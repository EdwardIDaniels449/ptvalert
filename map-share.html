<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PtvAlertç½‘é¡µç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', sans-serif;
        }
        
        body {
            position: relative;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            background-color: #1c1c1e;
            color: #fff;
        }
        
        #map {
            width: 100%;
            height: 100vh;
            z-index: 1;
        }
        
        /* å¼¹å¹•å®¹å™¨æ ·å¼ */
        .danmaku-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 130px;
            overflow: hidden;
            pointer-events: none;
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.15);
        }
        
        /* å¼¹å¹•é¡¹ç›®æ ·å¼ */
        .danmaku-item {
            position: absolute;
            white-space: nowrap;
            color: #333;
            font-size: 16px;
            font-weight: 500;
            padding: 6px 16px;
            border-radius: 20px;
            background-color: rgba(255, 255, 255, 0.75);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateX(100vw);
            animation: danmaku-move 15s linear forwards;
        }
        
        /* ä¸åŒç±»å‹çš„å¼¹å¹• */
        .danmaku-item.important {
            background-color: rgba(255, 245, 210, 0.85);
            border-left: 3px solid #f0c040;
            color: #805000;
            font-weight: bold;
        }
        
        .danmaku-item.service {
            background-color: rgba(230, 245, 255, 0.85);
            border-left: 3px solid #40a0f0;
            color: #104080;
        }
        
        .danmaku-item.safety {
            background-color: rgba(255, 230, 230, 0.85);
            border-left: 3px solid #f04050;
            color: #801020;
            font-weight: bold;
        }
        
        /* å¼¹å¹•åŠ¨ç”» */
        @keyframes danmaku-move {
            from {
                transform: translateX(100vw);
            }
            to {
                transform: translateX(-100%);
            }
        }
        
        .map-control {
            position: absolute;
            bottom: 30px;
            left: 0;
            right: 0;
            margin: 0 auto;
            width: 80%;
            max-width: 600px;
            z-index: 1000;
        }
        
        .add-report-btn {
            display: block;
            width: 100%;
            background-color: white;
            color: #333;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            text-decoration: none;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .add-report-btn:hover {
            background-color: #f8f8f8;
        }
        
        .report-form {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #1c1c1e;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
            z-index: 1001;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
        }
        
        .report-form.active, #editForm.active {
            transform: translateY(0);
        }
        
        #editForm {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #1c1c1e;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
            z-index: 1001;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
        }
        
        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .form-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
        }
        
        .form-title {
            font-size: 20px;
            font-weight: bold;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-input, .form-textarea {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #444;
            background-color: #2c2c2e;
            color: #fff;
            font-size: 16px;
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .image-preview {
            width: 100%;
            height: 200px;
            border-radius: 8px;
            background-color: #2c2c2e;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .preview-img {
            max-width: 100%;
            max-height: 100%;
            display: none;
        }
        
        .image-placeholder {
            color: #777;
            font-size: 16px;
        }
        
        .submit-btn {
            width: 100%;
            background-color: #0071e3;
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .submit-btn:hover {
            background-color: #0077ed;
        }
        
        .report-card {
            position: absolute;
            bottom: 90px;
            left: 0;
            right: 0;
            margin: 0 auto;
            width: 80%;
            max-width: 400px;
            background-color: rgba(28, 28, 30, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 999;
            display: none;
        }
        
        .report-time {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .report-description {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 10px;
        }
        
        .report-image {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 10px;
            max-height: 200px;
            object-fit: cover;
        }
        
        .report-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .comment-btn, .edit-btn {
            background: none;
            border: none;
            color: #0071e3;
            font-size: 14px;
            cursor: pointer;
        }
        
        .edit-btn {
            margin-left: auto;
        }
        
        .comment-count {
            font-size: 14px;
            color: #aaa;
        }
        
        .comments-section {
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            display: none;
        }
        
        .comment {
            background-color: #2c2c2e;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
        }
        
        .comment-input {
            display: flex;
            margin-top: 10px;
        }
        
        .comment-input input {
            flex: 1;
            padding: 8px 12px;
            border-radius: 20px;
            border: 1px solid #444;
            background-color: #2c2c2e;
            color: #fff;
        }
        
        .send-btn {
            background-color: #0071e3;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 15px;
            margin-left: 8px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .marker-icon {
            width: 40px;
            height: 40px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        .marker-emoji {
            font-size: 24px;
        }
        
        .attribution {
            position: absolute;
            bottom: 5px;
            left: 5px;
            font-size: 12px;
            color: #666;
            z-index: 998;
        }
        
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        
        .confirm-dialog.active {
            opacity: 1;
            visibility: visible;
        }
        
        .confirm-content {
            background-color: #2c2c2e;
            border-radius: 12px;
            width: 85%;
            max-width: 320px;
            padding: 20px;
            text-align: center;
        }
        
        .confirm-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .confirm-message {
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .confirm-buttons {
            display: flex;
            justify-content: space-between;
        }
        
        .confirm-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }
        
        .confirm-cancel {
            background-color: #3a3a3c;
            color: white;
            margin-right: 10px;
        }
        
        .confirm-ok {
            background-color: #0071e3;
            color: white;
        }
        
        .scroll-emoji {
            position: absolute;
            pointer-events: none;
            font-size: 24px;
            z-index: 1000;
            opacity: 0;
            animation: moveAndFade 2s forwards;
        }
        
        @keyframes moveAndFade {
            0% {
                transform: translateY(0);
                opacity: 1;
            }
            70% {
                opacity: 0.7;
            }
            100% {
                transform: translateY(-60px);
                opacity: 0;
            }
        }
        
        /* YarraTramsæ›´æ–°æ§åˆ¶æŒ‰é’® */
        .tram-updates-control {
            position: absolute;
            top: 130px;
            right: 10px;
            z-index: 1000;
        }
        
        .refresh-tram-btn {
            background-color: rgba(255, 255, 255, 0.8);
            color: #333;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
        }
        
        .refresh-tram-btn span {
            margin-right: 5px;
            font-size: 16px;
        }
        
        .refresh-tram-btn:hover {
            background-color: rgba(255, 255, 255, 0.9);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- å¼¹å¹•å®¹å™¨ -->
    <div class="danmaku-container" id="danmakuContainer"></div>
    
    <div class="map-control">
        <a href="#" class="add-report-btn" id="addReportBtn">+ Add a Report</a>
    </div>
    
    <!-- YarraTramsæ›´æ–°æ§åˆ¶æŒ‰é’® -->
    <div class="tram-updates-control">
        <button id="refreshTramUpdates" class="refresh-tram-btn">
            <span>ğŸš‹</span> åˆ·æ–°ç”µè½¦ä¿¡æ¯
        </button>
    </div>
    
    <div class="report-form" id="reportForm">
        <div class="form-header">
            <h2 class="form-title">æ–°æŠ¥å‘Š</h2>
            <button class="form-close" id="formClose">&times;</button>
        </div>
        
        <div class="form-group">
            <label class="form-label">ç…§ç‰‡</label>
            <div class="image-preview">
                <img src="" class="preview-img" id="previewImg">
                <span class="image-placeholder" id="imagePlaceholder">ç‚¹å‡»æ·»åŠ ç…§ç‰‡</span>
            </div>
            <input type="file" id="imageInput" accept="image/*" style="display: none;">
        </div>
        
        <div class="form-group">
            <label class="form-label">æè¿°</label>
            <textarea class="form-textarea" id="descriptionInput" placeholder="è¯·æè¿°æ‚¨çœ‹åˆ°çš„æƒ…å†µ..."></textarea>
        </div>
        
        <button class="submit-btn" id="submitReport">æäº¤æŠ¥å‘Š</button>
    </div>
    
    <div class="report-card" id="reportCard">
        <div class="report-time" id="reportTime">9 minutes ago</div>
        <div class="report-description" id="reportDesc">Dogs in 58, park st going to city</div>
        <img src="" class="report-image" id="reportImage" style="display: none;">
        
        <div class="report-actions">
            <button class="comment-btn" id="commentBtn">è¯„è®º</button>
            <span class="comment-count" id="commentCount">0 è¯„è®º</span>
            <button class="edit-btn" id="editReportBtn" style="display: none;">ç¼–è¾‘</button>
        </div>
        
        <div class="comments-section" id="commentsSection">
            <!-- è¯„è®ºå°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
            <div class="comment-input">
                <input type="text" placeholder="æ·»åŠ è¯„è®º..." id="commentInput">
                <button class="send-btn" id="sendComment">å‘é€</button>
            </div>
        </div>
    </div>
    
    <div class="report-form" id="editForm" style="display: none;">
        <div class="form-header">
            <h2 class="form-title">ç¼–è¾‘æŠ¥å‘Š</h2>
            <button class="form-close" id="editFormClose">&times;</button>
        </div>
        
        <div class="form-group">
            <label class="form-label">ç…§ç‰‡</label>
            <div class="image-preview" id="editImagePreview">
                <img src="" class="preview-img" id="editPreviewImg">
                <span class="image-placeholder" id="editImagePlaceholder">ç‚¹å‡»æ·»åŠ ç…§ç‰‡</span>
            </div>
            <input type="file" id="editImageInput" accept="image/*" style="display: none;">
        </div>
        
        <div class="form-group">
            <label class="form-label">æè¿°</label>
            <textarea class="form-textarea" id="editDescriptionInput" placeholder="è¯·æè¿°æ‚¨çœ‹åˆ°çš„æƒ…å†µ..."></textarea>
        </div>
        
        <button class="submit-btn" id="submitEditReport">ä¿å­˜ä¿®æ”¹</button>
    </div>
    
    <div class="confirm-dialog" id="confirmDialog">
        <div class="confirm-content">
            <div class="confirm-title">ç¡®è®¤æ“ä½œ</div>
            <div class="confirm-message" id="confirmMessage">æ‚¨ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ</div>
            <div class="confirm-buttons">
                <button class="confirm-btn confirm-cancel" id="confirmCancel">å–æ¶ˆ</button>
                <button class="confirm-btn confirm-ok" id="confirmOk">ç¡®è®¤</button>
            </div>
        </div>
    </div>
    
    <div class="attribution">Map data Â© Google Maps</div>
    
    <!-- æ›¿æ¢Leafletä¸ºGoogle Maps API -->
    <!-- æ³¨æ„: ä½¿ç”¨å‰è¯·å°†YOUR_API_KEYæ›¿æ¢ä¸ºæ‚¨çš„Google Maps APIå¯†é’¥ -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCE-oMIlcnOeqplgMmL9y1qcU6A9-HBu9U&callback=initMap" async defer></script>
    <script>
        // Google Mapsç›¸å…³å˜é‡
        let map;
        let markers = [];
        // å¢¨å°”æœ¬ä¸­å¿ƒåæ ‡
        const MELBOURNE_CENTER = { lat: -37.8136, lng: 144.9631 };
        
        // å¢¨å°”æœ¬ä¸»è¦ç”µè½¦ç«™ç‚¹æ•°æ®
        const tramStops = [
            { name: "Flinders Street Station", lat: -37.8183, lng: 144.9671, type: "tram" },
            { name: "Melbourne Central", lat: -37.8100, lng: 144.9633, type: "tram" },
            { name: "Parliament Station", lat: -37.8113, lng: 144.9730, type: "tram" },
            { name: "Bourke Street Mall", lat: -37.8136, lng: 144.9659, type: "tram" },
            { name: "Queen Victoria Market", lat: -37.8076, lng: 144.9566, type: "tram" },
            { name: "St Kilda Beach", lat: -37.8684, lng: 144.9733, type: "tram" },
            { name: "Toorak", lat: -37.8406, lng: 145.0174, type: "tram" },
            { name: "Brunswick St", lat: -37.7965, lng: 144.9783, type: "tram" },
            { name: "South Melbourne Beach", lat: -37.8505, lng: 144.9499, type: "tram" },
            { name: "Docklands", lat: -37.8159, lng: 144.9459, type: "tram" }
        ];
        
        // å¢¨å°”æœ¬ä¸»è¦ç«è½¦ç«™ç‚¹æ•°æ®
        const trainStations = [
            { name: "Flinders Street Station", lat: -37.8183, lng: 144.9671, type: "train" },
            { name: "Southern Cross Station", lat: -37.8183, lng: 144.9522, type: "train" },
            { name: "Melbourne Central", lat: -37.8100, lng: 144.9633, type: "train" },
            { name: "Parliament Station", lat: -37.8113, lng: 144.9730, type: "train" },
            { name: "Flagstaff Station", lat: -37.8127, lng: 144.9562, type: "train" },
            { name: "Richmond Station", lat: -37.8239, lng: 144.9975, type: "train" },
            { name: "South Yarra Station", lat: -37.8387, lng: 144.9926, type: "train" },
            { name: "Footscray Station", lat: -37.8012, lng: 144.9037, type: "train" },
            { name: "North Melbourne Station", lat: -37.8062, lng: 144.9416, type: "train" },
            { name: "Jolimont Station", lat: -37.8162, lng: 144.9802, type: "train" }
        ];
        
        // åˆå§‹åŒ–Googleåœ°å›¾
        function initMap() {
            // åˆ›å»ºåœ°å›¾
            map = new google.maps.Map(document.getElementById("map"), {
                center: MELBOURNE_CENTER,
                zoom: 13,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                styles: [
                    {
                        "elementType": "geometry",
                        "stylers": [{"color": "#212121"}]
                    },
                    {
                        "elementType": "labels.icon",
                        "stylers": [{"visibility": "off"}]
                    },
                    {
                        "elementType": "labels.text.fill",
                        "stylers": [{"color": "#757575"}]
                    },
                    {
                        "elementType": "labels.text.stroke",
                        "stylers": [{"color": "#212121"}]
                    },
                    {
                        "featureType": "administrative",
                        "elementType": "geometry",
                        "stylers": [{"color": "#757575"}]
                    },
                    {
                        "featureType": "administrative.country",
                        "elementType": "labels.text.fill",
                        "stylers": [{"color": "#9e9e9e"}]
                    },
                    {
                        "featureType": "administrative.land_parcel",
                        "stylers": [{"visibility": "off"}]
                    },
                    {
                        "featureType": "administrative.locality",
                        "elementType": "labels.text.fill",
                        "stylers": [{"color": "#bdbdbd"}]
                    },
                    {
                        "featureType": "poi",
                        "elementType": "labels.text.fill",
                        "stylers": [{"color": "#757575"}]
                    },
                    {
                        "featureType": "poi.park",
                        "elementType": "geometry",
                        "stylers": [{"color": "#181818"}]
                    },
                    {
                        "featureType": "poi.park",
                        "elementType": "labels.text.fill",
                        "stylers": [{"color": "#616161"}]
                    },
                    {
                        "featureType": "poi.park",
                        "elementType": "labels.text.stroke",
                        "stylers": [{"color": "#1b1b1b"}]
                    },
                    {
                        "featureType": "road",
                        "elementType": "geometry.fill",
                        "stylers": [{"color": "#2c2c2c"}]
                    },
                    {
                        "featureType": "road",
                        "elementType": "labels.text.fill",
                        "stylers": [{"color": "#8a8a8a"}]
                    },
                    {
                        "featureType": "road.arterial",
                        "elementType": "geometry",
                        "stylers": [{"color": "#373737"}]
                    },
                    {
                        "featureType": "road.highway",
                        "elementType": "geometry",
                        "stylers": [{"color": "#3c3c3c"}]
                    },
                    {
                        "featureType": "road.highway.controlled_access",
                        "elementType": "geometry",
                        "stylers": [{"color": "#4e4e4e"}]
                    },
                    {
                        "featureType": "road.local",
                        "elementType": "labels.text.fill",
                        "stylers": [{"color": "#616161"}]
                    },
                    {
                        "featureType": "transit",
                        "elementType": "labels.text.fill",
                        "stylers": [{"color": "#757575"}]
                    },
                    {
                        "featureType": "water",
                        "elementType": "geometry",
                        "stylers": [{"color": "#000000"}]
                    },
                    {
                        "featureType": "water",
                        "elementType": "labels.text.fill",
                        "stylers": [{"color": "#3d3d3d"}]
                    }
                ]
            });
            
            // æ·»åŠ ç”µè½¦ç«™æ ‡è®°
            tramStops.forEach(stop => {
                addStationMarker(stop);
            });
            
            // æ·»åŠ ç«è½¦ç«™æ ‡è®°
            trainStations.forEach(station => {
                addStationMarker(station);
            });
            
            // æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·æŠ¥å‘Š
            displayReports();
            
            // æ·»åŠ åœ°å›¾ç‚¹å‡»äº‹ä»¶
            map.addListener("click", (event) => {
                handleMapClick(event.latLng);
            });
        }
        
        // æ·»åŠ ç«™ç‚¹æ ‡è®°
        function addStationMarker(station) {
            const icon = {
                url: station.type === 'tram' 
                    ? 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="#40c0ff" d="M19,16.94V8.5C19,5.71 16.39,5 12,5C7.61,5 5,5.71 5,8.5V16.94C5,18.39 6.13,19.6 7.58,19.91L6,21.5V22H8.23L10.23,20H14L16,22H18V21.5L16.42,19.91C17.87,19.6 19,18.39 19,16.94M12,18.5A1.5,1.5 0 0,1 10.5,17A1.5,1.5 0 0,1 12,15.5A1.5,1.5 0 0,1 13.5,17A1.5,1.5 0 0,1 12,18.5M17,14H7V9H17V14Z" /></svg>')
                    : 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="#ff8040" d="M12,2C7.58,2 4,2.5 4,6V15.5A3.5,3.5 0 0,0 7.5,19L6,20.5V21H8.23L10.23,19H14L16,21H18V20.5L16.5,19A3.5,3.5 0 0,0 20,15.5V6C20,2.5 16.42,2 12,2M7.5,17A1.5,1.5 0 0,1 6,15.5A1.5,1.5 0 0,1 7.5,14A1.5,1.5 0 0,1 9,15.5A1.5,1.5 0 0,1 7.5,17M11,10H6V6H11V10M16.5,17A1.5,1.5 0 0,1 15,15.5A1.5,1.5 0 0,1 16.5,14A1.5,1.5 0 0,1 18,15.5A1.5,1.5 0 0,1 16.5,17M18,10H13V6H18V10Z" /></svg>'),
                scaledSize: new google.maps.Size(32, 32),
                anchor: new google.maps.Point(16, 16),
            };
            
            const marker = new google.maps.Marker({
                position: { lat: station.lat, lng: station.lng },
                map: map,
                title: station.name,
                icon: icon,
                zIndex: 10
            });
            
            // ä¿¡æ¯çª—å£
            const infoWindow = new google.maps.InfoWindow({
                content: `<div style="color:#000;font-weight:bold;">${station.name}</div><div style="color:#555;">${station.type === 'tram' ? 'ç”µè½¦ç«™' : 'ç«è½¦ç«™'}</div>`
            });
            
            marker.addListener("click", () => {
                infoWindow.open(map, marker);
            });
            
            markers.push(marker);
        }
        
        // å¤„ç†åœ°å›¾ç‚¹å‡»äº‹ä»¶
        function handleMapClick(latLng) {
            // å¦‚æœæŠ¥å‘Šå¡ç‰‡æ­£åœ¨æ˜¾ç¤ºï¼Œç‚¹å‡»åœ°å›¾æ—¶éšè—å®ƒ
            if (document.getElementById('reportCard').style.display === 'block') {
                document.getElementById('reportCard').style.display = 'none';
                return;
            }
            
            // å­˜å‚¨é€‰ä¸­çš„ä½ç½®
            selectedLocation = {
                lat: latLng.lat(),
                lng: latLng.lng()
            };
            
            // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼Œè¯¢é—®æ˜¯å¦åœ¨æ­¤å¤„æ·»åŠ æŠ¥å‘Š
            showConfirmDialog(`æ‚¨ç¡®å®šè¦åœ¨æ­¤ä½ç½® (${selectedLocation.lat.toFixed(4)}, ${selectedLocation.lng.toFixed(4)}) æ·»åŠ æŠ¥å‘Šå—ï¼Ÿ`, function(confirmed) {
                if (confirmed) {
                    // æ˜¾ç¤ºä¸´æ—¶æ ‡è®°
                    addTempMarker(selectedLocation);
                    
                    // æ‰“å¼€è¡¨å•
                    document.getElementById('reportForm').classList.add('active');
                } else {
                    selectedLocation = null;
                }
            });
        }
        
        // æ·»åŠ ä¸´æ—¶æ ‡è®°
        function addTempMarker(location) {
            // åˆ›å»ºä¸´æ—¶æ ‡è®°ä½œä¸ºè§†è§‰åé¦ˆ
            const marker = new google.maps.Marker({
                position: { lat: location.lat, lng: location.lng },
                map: map,
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="white" opacity="0.8"/><text x="12" y="16" font-size="12" text-anchor="middle" fill="black">ğŸ“</text></svg>'),
                    scaledSize: new google.maps.Size(40, 40),
                    anchor: new google.maps.Point(20, 20),
                },
                animation: google.maps.Animation.DROP
            });
            
            // å°†ä¸´æ—¶æ ‡è®°æ·»åŠ åˆ°markersæ•°ç»„
            markers.push(marker);
        }
        
        // å­˜å‚¨æ‰€æœ‰æŠ¥å‘Šçš„æ•°ç»„
        let reports = [
            {
                id: 1,
                lat: -37.8295,
                lng: 144.9649,
                description: "Dogs in 58, park st going to city",
                time: new Date(Date.now() - 9 * 60 * 1000), // 9åˆ†é’Ÿå‰
                image: "",
                emoji: "ğŸ¶",
                comments: [],
                userId: "user1" // æ·»åŠ ç”¨æˆ·IDå­—æ®µç”¨äºæ ‡è¯†æŠ¥å‘Šæ‰€æœ‰è€…
            }
        ];
        
        // å½“å‰ç”¨æˆ·ID - åœ¨å®é™…åº”ç”¨ä¸­åº”é€šè¿‡ç™»å½•ç³»ç»Ÿè·å–
        const currentUserId = "user1";
        
        // å½“å‰é€‰ä¸­çš„æŠ¥å‘ŠID
        let currentReportId = null;
        
        // å½“å‰é€‰ä¸­çš„åæ ‡
        let selectedLocation = null;
        
        // ç¡®è®¤å¯¹è¯æ¡†å›è°ƒå‡½æ•°
        let confirmCallback = null;
        
        // äº¤é€šå’Œè­¦å¯Ÿè¡¨æƒ…æ•°ç»„
        const scrollEmojis = [
            'ğŸš—', 'ğŸš•', 'ğŸš™', 'ğŸšŒ', 'ğŸš', 'ğŸï¸', 'ğŸš“', 'ğŸš‘', 'ğŸš’', 'ğŸš', 'ğŸ›»', 'ğŸšš',
            'ğŸš›', 'ğŸšœ', 'ğŸ›µ', 'ğŸï¸', 'ğŸ›º', 'ğŸš²', 'ğŸš„', 'ğŸš…', 'ğŸš', 'ğŸš', 'ğŸš‹', 'ğŸš‰',
            'ğŸ‘®â€â™€ï¸', 'ğŸ‘®â€â™‚ï¸', 'ğŸš”', 'ğŸš¨', 'ğŸš¥', 'ğŸš¦', 'ğŸ›¤ï¸', 'ğŸš', 'ğŸš‡', 'ğŸšŠ', 'âœˆï¸', 'ğŸš€'
        ];
        
        // æ˜¾ç¤ºæ‰€æœ‰æŠ¥å‘Šæ ‡è®°
        function displayReports() {
            reports.forEach(report => {
                // åˆ›å»ºè‡ªå®šä¹‰HTMLæ ‡è®°å†…å®¹
                const markerIcon = {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="white" opacity="0.8"/><text x="12" y="16" font-size="12" text-anchor="middle" fill="black">${report.emoji}</text></svg>`),
                    scaledSize: new google.maps.Size(40, 40),
                    anchor: new google.maps.Point(20, 20),
                };
                
                const marker = new google.maps.Marker({
                    position: { lat: report.lat, lng: report.lng },
                    map: map,
                    icon: markerIcon
                });
                
                // ä¿å­˜æŠ¥å‘ŠIDåˆ°æ ‡è®°
                marker.reportId = report.id;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                marker.addListener("click", function() {
                    showReportCard(this.reportId);
                });
                
                // æ·»åŠ åˆ°æ ‡è®°æ•°ç»„
                markers.push(marker);
            });
        }
        
        // æ·»åŠ æ–°æŠ¥å‘Š
        function addNewReport(description, image, lat, lng) {
            const newReport = {
                id: reports.length + 1,
                lat: lat,
                lng: lng,
                description: description,
                time: new Date(),
                image: image,
                emoji: "ğŸ“", // é»˜è®¤ä½¿ç”¨å®šä½å›¾æ ‡
                comments: [],
                userId: currentUserId // ä¿å­˜å½“å‰ç”¨æˆ·ID
            };
            
            // æ ¹æ®æè¿°é€‰æ‹©è¡¨æƒ…
            if (description.toLowerCase().includes('dog') || description.toLowerCase().includes('ç‹—')) {
                newReport.emoji = "ğŸ¶";
            } else if (description.toLowerCase().includes('traffic') || description.toLowerCase().includes('äº¤é€š')) {
                newReport.emoji = "ğŸš—";
            } else if (description.toLowerCase().includes('food') || description.toLowerCase().includes('é¤')) {
                newReport.emoji = "ğŸ”";
            } else if (description.toLowerCase().includes('event') || description.toLowerCase().includes('æ´»åŠ¨')) {
                newReport.emoji = "ğŸª";
            }
            
            reports.push(newReport);
            
            // æ·»åŠ æ ‡è®°åˆ°åœ°å›¾
            const markerIcon = {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="white" opacity="0.8"/><text x="12" y="16" font-size="12" text-anchor="middle" fill="black">${newReport.emoji}</text></svg>`),
                scaledSize: new google.maps.Size(40, 40),
                anchor: new google.maps.Point(20, 20),
            };
            
            const marker = new google.maps.Marker({
                position: { lat: lat, lng: lng },
                map: map,
                icon: markerIcon,
                animation: google.maps.Animation.DROP
            });
            
            marker.reportId = newReport.id;
            
            marker.addListener("click", function() {
                showReportCard(this.reportId);
            });
            
            // æ·»åŠ åˆ°æ ‡è®°æ•°ç»„
            markers.push(marker);
            
            // æ˜¾ç¤ºæ–°æ·»åŠ çš„æŠ¥å‘Šå¡ç‰‡
            showReportCard(newReport.id);
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('descriptionInput').value = '';
            document.getElementById('previewImg').style.display = 'none';
            document.getElementById('imagePlaceholder').style.display = 'block';
            document.getElementById('imageInput').value = '';
        }
        
        // æ˜¾ç¤ºæŠ¥å‘Šå¡ç‰‡
        function showReportCard(reportId) {
            const report = reports.find(r => r.id === reportId);
            if (!report) return;
            
            currentReportId = reportId;
            
            const reportCard = document.getElementById('reportCard');
            const reportTime = document.getElementById('reportTime');
            const reportDesc = document.getElementById('reportDesc');
            const reportImage = document.getElementById('reportImage');
            const commentCount = document.getElementById('commentCount');
            const commentsSection = document.getElementById('commentsSection');
            
            reportTime.textContent = formatTime(report.time);
            reportDesc.textContent = report.description;
            
            if (report.image) {
                reportImage.src = report.image;
                reportImage.style.display = 'block';
            } else {
                reportImage.style.display = 'none';
            }
            
            commentCount.textContent = `${report.comments.length} è¯„è®º`;
            commentsSection.style.display = 'none';
            
            // æ¸…é™¤ç°æœ‰è¯„è®º
            const existingComments = commentsSection.querySelectorAll('.comment');
            existingComments.forEach(comment => comment.remove());
            
            // æ·»åŠ è¯„è®ºåˆ°è¯„è®ºåŒº
            report.comments.forEach(comment => {
                const commentElement = document.createElement('div');
                commentElement.className = 'comment';
                commentElement.textContent = comment;
                commentsSection.insertBefore(commentElement, document.getElementById('commentInput').parentNode);
            });
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºå½“å‰ç”¨æˆ·çš„æŠ¥å‘Šï¼Œå¦‚æœæ˜¯åˆ™æ˜¾ç¤ºç¼–è¾‘æŒ‰é’®
            const editBtn = document.getElementById('editReportBtn');
            if (report.userId === currentUserId) {
                editBtn.style.display = 'block';
            } else {
                editBtn.style.display = 'none';
            }
            
            reportCard.style.display = 'block';
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(date) {
            const now = new Date();
            const diff = Math.floor((now - date) / 1000); // ç§’å·®
            
            if (diff < 60) {
                return "åˆšåˆš";
            } else if (diff < 3600) {
                const minutes = Math.floor(diff / 60);
                return `${minutes} åˆ†é’Ÿå‰`;
            } else if (diff < 86400) {
                const hours = Math.floor(diff / 3600);
                return `${hours} å°æ—¶å‰`;
            } else {
                const days = Math.floor(diff / 86400);
                return `${days} å¤©å‰`;
            }
        }
        
        // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
        function showConfirmDialog(message, callback) {
            const confirmDialog = document.getElementById('confirmDialog');
            const confirmMessage = document.getElementById('confirmMessage');
            
            confirmMessage.textContent = message;
            confirmCallback = callback;
            
            confirmDialog.classList.add('active');
        }
        
        // å…³é—­ç¡®è®¤å¯¹è¯æ¡†
        function closeConfirmDialog() {
            const confirmDialog = document.getElementById('confirmDialog');
            confirmDialog.classList.remove('active');
        }
        
        // åˆ›å»ºæ»šåŠ¨emoji
        function createScrollEmoji(x, y) {
            const emoji = document.createElement('div');
            emoji.className = 'scroll-emoji';
            emoji.textContent = scrollEmojis[Math.floor(Math.random() * scrollEmojis.length)];
            emoji.style.left = `${x}px`;
            emoji.style.top = `${y}px`;
            document.body.appendChild(emoji);
            
            // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
            setTimeout(() => {
                emoji.remove();
            }, 2000);
        }
        
        // å¤„ç†æ»šåŠ¨æ—¶çš„emojiæ˜¾ç¤º
        let scrollTimer;
        let isScrolling = false;
        
        function handleScroll(e) {
            isScrolling = true;
            clearTimeout(scrollTimer);
            
            // ä¸ºæ¯ä¸ªæ»šåŠ¨äº‹ä»¶åˆ›å»ºä¸€ä¸ªemoji
            if (e.deltaY !== 0) {
                createScrollEmoji(e.clientX, e.clientY);
            }
            
            // è®¾ç½®ä¸€ä¸ªå®šæ—¶å™¨ï¼Œå½“ç”¨æˆ·åœæ­¢æ»šåŠ¨ä¸€æ®µæ—¶é—´åè®¾ç½®ä¸ºéæ»šåŠ¨çŠ¶æ€
            scrollTimer = setTimeout(() => {
                isScrolling = false;
            }, 100);
        }
        
        // å¼¹å¹•æ•°æ® - YarraTramsæœ€æ–°å…¬å‘Šä¸å†…å®¹
        let danmakuData = [
            "YarraTrams: 58è·¯ç”µè½¦ä»Šæ—¥å°†åœ¨West Coburgåˆ°Toorakä¹‹é—´æ­£å¸¸è¿è¡Œ",
            "å…¬å‘Š: å¢¨å°”æœ¬è‰ºæœ¯ç”µè½¦é¡¹ç›®è‡ª1978å¹´å¼€å§‹ï¼Œä¿ƒè¿›è‰ºæœ¯ä¸å…¬å…±äº¤é€šçš„èåˆ",
            "96è·¯ç”µè½¦: East Brunswickè‡³St Kilda Beachæœ‰ä¸´æ—¶è°ƒæ•´ï¼Œè¯·æŸ¥çœ‹æœ€æ–°æ—¶åˆ»è¡¨",
            "YarraTrams: åœ¨Collins Streetæ–°å¢è‰ºæœ¯å€™è½¦äº­ï¼Œè¿æ¥ä¹˜å®¢ä¸åŸä½æ°‘æ–‡åŒ–",
            "äº¤é€šæ›´æ–°: 11è·¯ç”µè½¦West Prestonè‡³Victoria Harbour Docklandsè·¯çº¿æ­£å¸¸",
            "å…è´¹ç”µè½¦åŒºæé†’: å¢¨å°”æœ¬å¸‚ä¸­å¿ƒåŒºåŸŸä¹˜åç”µè½¦æ— éœ€ä»˜è´¹",
            "YarraTrams: ä¸ºæå‡ç½‘ç»œè¦†ç›–èŒƒå›´ï¼Œéƒ¨åˆ†çº¿è·¯å°†è¿›è¡ŒåŸºç¡€è®¾æ–½å‡çº§",
            "æœåŠ¡å…¬å‘Š: 35è·¯ç¯åŸç”µè½¦æä¾›ä¾¿æ·çš„å¸‚åŒºè§‚å…‰ä½“éªŒ",
            "YarraTrams: 72è·¯ç”µè½¦Melbourne Universityè‡³Camberwellçº¿è·¯æ­£å¸¸è¿è¡Œ",
            "å®‰å…¨æç¤º: è¯·åœ¨é è¿‘ç”µè½¦è½¨é“æ—¶ä¿æŒè­¦æƒ•ï¼Œæ³¨æ„å®‰å…¨",
            "YarraTrams: è®¿é—®PTVæ—…ç¨‹è§„åˆ’å·¥å…·ï¼Œè½»æ¾è§„åˆ’æ‚¨çš„å‡ºè¡Œè·¯çº¿",
            "æœåŠ¡å…¬å‘Š: 109è·¯ç”µè½¦Box Hillè‡³Port Melbourneçº¿è·¯æŒ‰æ—¶åˆ»è¡¨è¿è¡Œ"
        ];
        
        // ä¸Šæ¬¡æ›´æ–°æ—¶é—´
        let lastUpdateTime = new Date();
        
        // è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨
        let autoRefreshTimer;
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatusDisplay() {
            const lastUpdateSpan = document.getElementById('lastUpdateTime');
            if (lastUpdateSpan) {
                const timeDiff = Math.floor((new Date() - lastUpdateTime) / 60000); // åˆ†é’Ÿå·®
                lastUpdateSpan.textContent = timeDiff < 1 ? 'åˆšåˆš' : `${timeDiff}åˆ†é’Ÿå‰`;
            }
        }
        
        // è·å–YarraTramsæœ€æ–°ä¿¡æ¯
        function fetchTramUpdates(showAlert = true) {
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥æ˜¯å‘YarraTrams APIå‘èµ·è¯·æ±‚
            // ç”±äºæˆ‘ä»¬æ— æ³•å®é™…è°ƒç”¨å¤–éƒ¨APIï¼Œè¿™é‡Œæ¨¡æ‹Ÿæ–°æ•°æ®
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const refreshBtn = document.getElementById('refreshTramUpdates');
            const originalBtnText = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<span>ğŸ”„</span> åŠ è½½ä¸­...';
            refreshBtn.disabled = true;
            
            // æ¨¡æ‹ŸAPIå»¶è¿Ÿ
            setTimeout(() => {
                // ç”Ÿæˆä¸€äº›æ–°çš„å…¬å‘Š
                const newUpdates = [
                    `YarraTrams: ${new Date().toLocaleDateString()} æœ€æ–°æœåŠ¡è°ƒæ•´å…¬å‘Š`,
                    "äº¤é€šéƒ¨é—¨å…¬å‘Š: è®¡åˆ’å‡ºè¡Œè¯·å…³æ³¨PTVæ—…ç¨‹è§„åˆ’å·¥å…·çš„æœ€æ–°ä¿¡æ¯",
                    `æœåŠ¡æ›´æ–°: ä»Šæ—¥${Math.floor(Math.random() * 10) + 1}æ¡çº¿è·¯å› ç»´æŠ¤å·¥ä½œæœ‰ä¸´æ—¶è°ƒæ•´`,
                    "YarraTrams: ä¸‹è½½ç§»åŠ¨åº”ç”¨è·å–å®æ—¶ç”µè½¦åˆ°ç«™ä¿¡æ¯",
                    "å®‰å…¨æé†’: åœ¨ç”µè½¦ç«™å°è¯·ç«™åœ¨é»„çº¿å†…ç­‰å€™",
                    `ç”µè½¦è°ƒæ•´: ${Math.floor(Math.random() * 100) + 1}è·¯ç”µè½¦æœ‰ä¸´æ—¶æœåŠ¡å˜æ›´`
                ];
                
                // æ›´æ–°å¼¹å¹•æ•°æ®
                danmakuData = [...newUpdates, ...danmakuData.slice(0, 6)];
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                refreshBtn.innerHTML = originalBtnText;
                refreshBtn.disabled = false;
                
                // æ›´æ–°æœ€ååˆ·æ–°æ—¶é—´
                lastUpdateTime = new Date();
                updateStatusDisplay();
                
                // æ˜¾ç¤ºæç¤º
                if (showAlert) {
                    alert('ç”µè½¦ä¿¡æ¯å·²æ›´æ–°');
                }
            }, 1500);
        }
        
        // åˆå§‹åŒ–å¼¹å¹•ç³»ç»Ÿ
        function initDanmaku() {
            const container = document.getElementById('danmakuContainer');
            
            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';
            
            // å¾ªç¯å‘é€å¼¹å¹•
            function loopDanmaku() {
                danmakuData.forEach((text, index) => {
                    setTimeout(() => {
                        createDanmaku(text);
                    }, index * 3000); // æ¯3ç§’å‘é€ä¸€æ¡
                });
                
                // å¾ªç¯é—´éš”æ—¶é—´
                setTimeout(loopDanmaku, danmakuData.length * 3000);
            }
            
            // åˆ›å»ºå•æ¡å¼¹å¹•
            function createDanmaku(text) {
                const danmaku = document.createElement('div');
                danmaku.className = 'danmaku-item';
                
                // æ ¹æ®å†…å®¹è®¾ç½®ä¸åŒçš„æ ·å¼
                if (text.includes('å®‰å…¨') || text.includes('è­¦å‘Š') || text.includes('æ³¨æ„')) {
                    danmaku.classList.add('safety');
                } else if (text.includes('æœåŠ¡') || text.includes('ç”µè½¦')) {
                    danmaku.classList.add('service');
                } else if (text.includes('å…¬å‘Š') || text.includes('YarraTrams:')) {
                    danmaku.classList.add('important');
                }
                
                danmaku.textContent = text;
                
                // éšæœºå‚ç›´ä½ç½®
                const top = Math.floor(Math.random() * 90);
                danmaku.style.top = `${top}px`;
                
                // éšæœºé€Ÿåº¦ (é€šè¿‡åŠ¨ç”»æŒç»­æ—¶é—´æ§åˆ¶)
                const speed = 12 + Math.random() * 8; // 12-20ç§’ä¹‹é—´
                danmaku.style.animationDuration = `${speed}s`;
                
                // æ·»åŠ åˆ°å®¹å™¨
                container.appendChild(danmaku);
                
                // åŠ¨ç”»ç»“æŸåç§»é™¤
                setTimeout(() => {
                    danmaku.remove();
                }, speed * 1000);
            }
            
            // å¼€å§‹å¾ªç¯å¼¹å¹•
            loopDanmaku();
        }
        
        // ç¼–è¾‘æŠ¥å‘Š
        function editReport(reportId, description, image) {
            const report = reports.find(r => r.id === reportId);
            if (!report) return;
            
            // åªèƒ½ç¼–è¾‘è‡ªå·±çš„æŠ¥å‘Š
            if (report.userId !== currentUserId) {
                showConfirmDialog('æ‚¨åªèƒ½ç¼–è¾‘è‡ªå·±å‘å¸ƒçš„æŠ¥å‘Š', null);
                return false;
            }
            
            // æ›´æ–°æŠ¥å‘Šå†…å®¹
            report.description = description;
            if (image) {
                report.image = image;
            }
            
            // æ ¹æ®æè¿°æ›´æ–°è¡¨æƒ…
            let newEmoji = report.emoji; // é»˜è®¤ä¿æŒåŸæ¥çš„è¡¨æƒ…
            if (description.toLowerCase().includes('dog') || description.toLowerCase().includes('ç‹—')) {
                newEmoji = "ğŸ¶";
            } else if (description.toLowerCase().includes('traffic') || description.toLowerCase().includes('äº¤é€š')) {
                newEmoji = "ğŸš—";
            } else if (description.toLowerCase().includes('food') || description.toLowerCase().includes('é¤')) {
                newEmoji = "ğŸ”";
            } else if (description.toLowerCase().includes('event') || description.toLowerCase().includes('æ´»åŠ¨')) {
                newEmoji = "ğŸª";
            }
            
            // å¦‚æœè¡¨æƒ…æ”¹å˜äº†ï¼Œæ›´æ–°åœ°å›¾ä¸Šçš„æ ‡è®°
            if (newEmoji !== report.emoji) {
                report.emoji = newEmoji;
                
                // æŸ¥æ‰¾å¹¶ç§»é™¤æ—§æ ‡è®°
                for (let i = 0; i < markers.length; i++) {
                    if (markers[i].reportId === report.id) {
                        markers[i].setMap(null);
                        markers.splice(i, 1);
                        break;
                    }
                }
                
                // æ·»åŠ æ–°æ ‡è®°
                const markerIcon = {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="white" opacity="0.8"/><text x="12" y="16" font-size="12" text-anchor="middle" fill="black">${report.emoji}</text></svg>`),
                    scaledSize: new google.maps.Size(40, 40),
                    anchor: new google.maps.Point(20, 20),
                };
                
                const marker = new google.maps.Marker({
                    position: { lat: report.lat, lng: report.lng },
                    map: map,
                    icon: markerIcon,
                    animation: google.maps.Animation.DROP
                });
                
                marker.reportId = report.id;
                
                marker.addListener("click", function() {
                    showReportCard(this.reportId);
                });
                
                markers.push(marker);
            }
            
            // é‡æ–°æ˜¾ç¤ºæŠ¥å‘Šå¡ç‰‡
            showReportCard(reportId);
            return true;
        }
        
        // æ·»åŠ è¯„è®º
        function addComment(reportId, comment) {
            const report = reports.find(r => r.id === reportId);
            if (!report) return;
            
            report.comments.push(comment);
            
            // æ›´æ–°è¯„è®ºåŒº
            const commentsSection = document.getElementById('commentsSection');
            const commentElement = document.createElement('div');
            commentElement.className = 'comment';
            commentElement.textContent = comment;
            commentsSection.insertBefore(commentElement, document.getElementById('commentInput').parentNode);
            
            // æ›´æ–°è¯„è®ºè®¡æ•°
            document.getElementById('commentCount').textContent = `${report.comments.length} è¯„è®º`;
        }
        
        // DOM äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function() {
            const addReportBtn = document.getElementById('addReportBtn');
            const reportForm = document.getElementById('reportForm');
            const formClose = document.getElementById('formClose');
            const imagePreview = document.querySelector('.image-preview');
            const imageInput = document.getElementById('imageInput');
            const previewImg = document.getElementById('previewImg');
            const imagePlaceholder = document.getElementById('imagePlaceholder');
            const submitReport = document.getElementById('submitReport');
            const commentBtn = document.getElementById('commentBtn');
            const commentsSection = document.getElementById('commentsSection');
            const sendComment = document.getElementById('sendComment');
            const commentInput = document.getElementById('commentInput');
            const confirmCancel = document.getElementById('confirmCancel');
            const confirmOk = document.getElementById('confirmOk');
            const editReportBtn = document.getElementById('editReportBtn');
            const editForm = document.getElementById('editForm');
            const editFormClose = document.getElementById('editFormClose');
            const editImagePreview = document.getElementById('editImagePreview');
            const editImageInput = document.getElementById('editImageInput');
            const editPreviewImg = document.getElementById('editPreviewImg');
            const editImagePlaceholder = document.getElementById('editImagePlaceholder');
            const submitEditReport = document.getElementById('submitEditReport');
            const refreshTramUpdates = document.getElementById('refreshTramUpdates');
            
            // æ·»åŠ æœ€åæ›´æ–°æ—¶é—´æ ‡ç­¾
            const updateTimeSpan = document.createElement('span');
            updateTimeSpan.id = 'lastUpdateTime';
            updateTimeSpan.textContent = 'åˆšåˆš';
            updateTimeSpan.style.marginLeft = '5px';
            updateTimeSpan.style.fontSize = '12px';
            updateTimeSpan.style.color = '#666';
            refreshTramUpdates.appendChild(updateTimeSpan);
            
            // åˆå§‹åŒ–å¼¹å¹•
            initDanmaku();
            
            // è®¾ç½®è‡ªåŠ¨åˆ·æ–° (æ¯15åˆ†é’Ÿ)
            autoRefreshTimer = setInterval(() => {
                fetchTramUpdates(false); // é™é»˜åˆ·æ–°ï¼Œä¸æ˜¾ç¤ºæç¤º
                initDanmaku();
            }, 15 * 60 * 1000); // 15åˆ†é’Ÿ
            
            // æ¯åˆ†é’Ÿæ›´æ–°çŠ¶æ€æ˜¾ç¤º
            setInterval(updateStatusDisplay, 60 * 1000);
            
            // åˆ·æ–°ç”µè½¦ä¿¡æ¯æŒ‰é’®
            refreshTramUpdates.addEventListener('click', function() {
                fetchTramUpdates(true); // æ˜¾ç¤ºæç¤º
                initDanmaku();
            });
            
            // æ‰“å¼€æŠ¥å‘Šè¡¨å•
            addReportBtn.addEventListener('click', function(e) {
                e.preventDefault();
                alert('è¯·åœ¨åœ°å›¾ä¸Šç‚¹å‡»æ‚¨æƒ³è¦æŠ¥å‘Šçš„ä½ç½®');
            });
            
            // å…³é—­æŠ¥å‘Šè¡¨å•
            formClose.addEventListener('click', function() {
                showConfirmDialog('æ‚¨ç¡®å®šè¦å–æ¶ˆæ­¤æŠ¥å‘Šå—ï¼Ÿæœªä¿å­˜çš„å†…å®¹å°†ä¼šä¸¢å¤±ã€‚', function(confirmed) {
                    if (confirmed) {
                        reportForm.classList.remove('active');
                        selectedLocation = null;
                    }
                });
            });
            
            // å›¾ç‰‡é¢„è§ˆåŠŸèƒ½
            imagePreview.addEventListener('click', function() {
                imageInput.click();
            });
            
            imageInput.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImg.src = e.target.result;
                        previewImg.style.display = 'block';
                        imagePlaceholder.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // æäº¤æŠ¥å‘Š
            submitReport.addEventListener('click', function() {
                const description = document.getElementById('descriptionInput').value.trim();
                
                if (!description) {
                    alert('è¯·è¾“å…¥æè¿°');
                    return;
                }
                
                if (!selectedLocation) {
                    alert('è¯·é€‰æ‹©ä½ç½®');
                    return;
                }
                
                showConfirmDialog('æ‚¨ç¡®å®šè¦æäº¤è¿™ä¸ªæŠ¥å‘Šå—ï¼Ÿ', function(confirmed) {
                    if (confirmed) {
                        // è·å–å›¾ç‰‡
                        let imageData = '';
                        if (previewImg.style.display !== 'none') {
                            imageData = previewImg.src;
                        }
                        
                        // æ·»åŠ æ–°æŠ¥å‘Š
                        addNewReport(description, imageData, selectedLocation.lat, selectedLocation.lng);
                        
                        // å…³é—­è¡¨å•
                        reportForm.classList.remove('active');
                        selectedLocation = null;
                    }
                });
            });
            
            // æ˜¾ç¤º/éšè—è¯„è®ºåŒº
            commentBtn.addEventListener('click', function() {
                if (commentsSection.style.display === 'none') {
                    commentsSection.style.display = 'block';
                } else {
                    commentsSection.style.display = 'none';
                }
            });
            
            // å‘é€è¯„è®º
            sendComment.addEventListener('click', function() {
                const comment = commentInput.value.trim();
                if (!comment) return;
                
                showConfirmDialog('ç¡®å®šå‘é€æ­¤è¯„è®ºï¼Ÿ', function(confirmed) {
                    if (confirmed) {
                        addComment(currentReportId, comment);
                        commentInput.value = '';
                    }
                });
            });
            
            // å›è½¦å‘é€è¯„è®º
            commentInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const comment = this.value.trim();
                    if (!comment) return;
                    
                    showConfirmDialog('ç¡®å®šå‘é€æ­¤è¯„è®ºï¼Ÿ', function(confirmed) {
                        if (confirmed) {
                            addComment(currentReportId, comment);
                            commentInput.value = '';
                        }
                    });
                }
            });
            
            // ç‚¹å‡»åœ°å›¾ç©ºç™½å¤„å…³é—­æŠ¥å‘Šå¡ç‰‡
            map.addListener("click", (event) => {
                if (document.getElementById('reportCard').style.display === 'block') {
                    document.getElementById('reportCard').style.display = 'none';
                }
            });
            
            // ç‚¹å‡»ç¼–è¾‘æŒ‰é’®
            editReportBtn.addEventListener('click', function() {
                const report = reports.find(r => r.id === currentReportId);
                if (!report) return;
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºå½“å‰ç”¨æˆ·çš„æŠ¥å‘Š
                if (report.userId !== currentUserId) {
                    showConfirmDialog('æ‚¨åªèƒ½ç¼–è¾‘è‡ªå·±å‘å¸ƒçš„æŠ¥å‘Š', null);
                    return;
                }
                
                // å¡«å……ç¼–è¾‘è¡¨å•
                document.getElementById('editDescriptionInput').value = report.description;
                
                if (report.image) {
                    editPreviewImg.src = report.image;
                    editPreviewImg.style.display = 'block';
                    editImagePlaceholder.style.display = 'none';
                } else {
                    editPreviewImg.style.display = 'none';
                    editImagePlaceholder.style.display = 'block';
                }
                
                // æ˜¾ç¤ºç¼–è¾‘è¡¨å•
                editForm.classList.add('active');
            });
            
            // å…³é—­ç¼–è¾‘è¡¨å•
            editFormClose.addEventListener('click', function() {
                showConfirmDialog('æ‚¨ç¡®å®šè¦å–æ¶ˆç¼–è¾‘å—ï¼Ÿæœªä¿å­˜çš„ä¿®æ”¹å°†ä¼šä¸¢å¤±ã€‚', function(confirmed) {
                    if (confirmed) {
                        editForm.classList.remove('active');
                    }
                });
            });
            
            // ç¼–è¾‘è¡¨å•çš„å›¾ç‰‡é¢„è§ˆåŠŸèƒ½
            editImagePreview.addEventListener('click', function() {
                editImageInput.click();
            });
            
            editImageInput.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        editPreviewImg.src = e.target.result;
                        editPreviewImg.style.display = 'block';
                        editImagePlaceholder.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // æäº¤ç¼–è¾‘
            submitEditReport.addEventListener('click', function() {
                const description = document.getElementById('editDescriptionInput').value.trim();
                
                if (!description) {
                    alert('è¯·è¾“å…¥æè¿°');
                    return;
                }
                
                showConfirmDialog('æ‚¨ç¡®å®šè¦ä¿å­˜è¿™äº›ä¿®æ”¹å—ï¼Ÿ', function(confirmed) {
                    if (confirmed) {
                        // è·å–å›¾ç‰‡
                        let imageData = '';
                        if (editPreviewImg.style.display !== 'none') {
                            imageData = editPreviewImg.src;
                        }
                        
                        // ç¼–è¾‘æŠ¥å‘Š
                        if (editReport(currentReportId, description, imageData)) {
                            // å…³é—­ç¼–è¾‘è¡¨å•
                            editForm.classList.remove('active');
                        }
                    }
                });
            });
            
            // ç¡®è®¤å¯¹è¯æ¡†æŒ‰é’®
            confirmCancel.addEventListener('click', function() {
                closeConfirmDialog();
                if (confirmCallback) {
                    confirmCallback(false);
                    confirmCallback = null;
                }
            });
            
            confirmOk.addEventListener('click', function() {
                closeConfirmDialog();
                if (confirmCallback) {
                    confirmCallback(true);
                    confirmCallback = null;
                }
            });
            
            // æ·»åŠ æ»šè½®äº‹ä»¶ç›‘å¬å™¨
            document.addEventListener('wheel', handleScroll);
        });
    </script>
</body>
</html> 