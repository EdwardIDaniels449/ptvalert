<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PtvAlertÁΩëÈ°µÁâà</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- Ê∑ªÂä†Firebase SDK ËÑöÊú¨ -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', sans-serif;
            -webkit-tap-highlight-color: transparent; /* ÁßªÈô§ÁßªÂä®Á´ØÁÇπÂáªÊó∂ÁöÑÈ´ò‰∫Æ */
        }
        
        body {
            position: relative;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            background-color: #1c1c1e;
            color: #fff;
        }
        
        #map {
            width: 100%;
            height: 100vh;
            z-index: 1;
        }
        
        /* Êä•ÂëäËÆ°Êï∞Âô®ÂºπÁ™óÊ†∑Âºè */
        .report-counter-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(50, 50, 54, 0.95);
            border-radius: 16px;
            padding: 20px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            z-index: 3000;
            text-align: center;
            animation: popup-fade-in 0.3s ease-out;
            display: none;
        }
        
        @keyframes popup-fade-in {
            from { opacity: 0; transform: translate(-50%, -60%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }
        
        .report-counter-popup h3 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #fff;
        }
        
        .report-counter-popup p {
            font-size: 16px;
            margin-bottom: 20px;
            color: #ccc;
        }
        
        .counter-value {
            font-size: 24px;
            font-weight: bold;
            color: #0071e3;
            margin: 0 5px;
        }
        
        .close-counter-popup {
            background-color: #0071e3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .close-counter-popup:hover {
            background-color: #0077ed;
        }
        
        /* Âú∞ÂõæÊéßÂà∂Ê†∑Âºè */
        .map-control {
            position: absolute;
            bottom: 30px;
            left: 0;
            right: 0;
            margin: 0 auto;
            width: 80%;
            max-width: 600px;
            z-index: 1000;
        }
        
        .add-report-btn {
            display: block;
            width: 100%;
            background-color: white;
            color: #333;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            text-decoration: none;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .add-report-btn:hover {
            background-color: #f8f8f8;
        }
        
        /* Êä•ÂëäË°®ÂçïÊ†∑Âºè */
        .report-form {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #1c1c1e;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
            z-index: 1001;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
        }
        
        .report-form.active {
            transform: translateY(0);
        }
        
        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .form-title {
            font-size: 20px;
            font-weight: bold;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-textarea {
            width: 100%;
            min-height: 100px;
            resize: vertical;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #444;
            background-color: #2c2c2e;
            color: #fff;
            font-size: 16px;
        }
        
        .submit-btn {
            width: 100%;
            background-color: #0071e3;
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .submit-btn:hover {
            background-color: #0077ed;
        }
        
        /* Áî®Êà∑ËèúÂçïÊ†∑Âºè */
        .user-menu {
            position: fixed;
            top: 60px;
            right: 18px;
            z-index: 1001;
            background: #fff;
            color: #333;
            border-radius: 20px;
            padding: 10px 18px;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 2px 12px rgba(0,0,0,0.18);
            border: 2px solid #0071e3;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            display: none; /* ÈªòËÆ§ÈöêËóèÔºåÁõ¥Âà∞Áî®Êà∑È™åËØÅÊàêÂäü */
        }
        
        .user-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            width: 150px;
            display: none;
            z-index: 1002;
            overflow: hidden;
        }
        
        .user-menu-item {
            padding: 12px 15px;
            font-size: 14px;
            color: #333;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .user-menu-item:hover {
            background-color: #f5f5f5;
        }
        
        .user-menu-item.logout {
            color: #e74c3c;
            border-top: 1px solid #eee;
        }
        
        /* ÁßªÂä®ËÆæÂ§áÈÄÇÈÖç */
        @media (max-width: 768px) {
            .map-control {
                width: 90%;
                bottom: 20px;
            }
            
            .add-report-btn {
                padding: 14px;
                font-size: 18px;
            }
            
            .report-counter-popup {
                width: 95%;
                padding: 15px;
            }
        }

        /* ÂºπÂπïÊ†∑Âºè */
        .danmaku-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 70%;
            pointer-events: none;
            z-index: 900;
            overflow: hidden;
        }
        
        .danmaku {
            position: absolute;
            white-space: nowrap;
            color: white;
            font-weight: bold;
            font-size: 20px;
            padding: 5px 12px;
            border-radius: 18px;
            background-color: rgba(0, 0, 0, 0.65);
            animation-name: danmaku-move;
            animation-timing-function: linear;
            animation-iteration-count: 1;
            user-select: none;
            z-index: 900;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.9);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            letter-spacing: 0.5px;
        }
        
        @keyframes danmaku-move {
            from { transform: translateX(100vw); }
            to { transform: translateX(-100%); }
        }
        
        /* ÁøªËØëÊåâÈíÆÊ†∑Âºè */
        .translate-btn {
            display: inline-block;
            margin-left: 8px;
            padding: 2px 5px;
            background-color: rgba(255, 255, 255, 0.2);
            color: #fff;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .translate-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .translated-text {
            margin-top: 5px;
            padding: 5px;
            background-color: rgba(0, 113, 227, 0.1);
            border-radius: 4px;
            font-style: italic;
            color: #8cc5ff;
        }
        
        #userDisplayName {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Âè≥‰∏äËßíËØ≠Ë®ÄÂàáÊç¢ÊåâÈíÆ -->
    <button id="langSwitchBtn" style="position:fixed;top:18px;right:18px;z-index:1001;background:rgba(255,255,255,0.8);color:#333;border-radius:20px;padding:6px 12px;font-size:14px;font-weight:bold;box-shadow:0 2px 12px rgba(0,0,0,0.18);border:2px solid #0071e3;cursor:pointer;display:flex;align-items:center;gap:6px;transition:background 0.2s,border 0.2s;">
      <span style="font-size:16px;">üåê</span>
      <span id="langSwitchText">EN</span>
    </button>
    
    <!-- Áî®Êà∑ËèúÂçï -->
    <div id="userMenu" class="user-menu">
      <span style="font-size:16px;">üë§</span>
      <span id="userDisplayName" style="max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">Áî®Êà∑</span>
      <div class="user-menu-dropdown" id="userMenuDropdown">
        <div class="user-menu-item" id="profileMenuItem">‰∏™‰∫∫ËµÑÊñô</div>
        <div class="user-menu-item logout" id="logoutMenuItem">ÈÄÄÂá∫ÁôªÂΩï</div>
      </div>
    </div>
    
    <!-- Ê∑ªÂä†ÂºπÂπïÂÆπÂô® -->
    <div class="danmaku-container" id="danmakuContainer"></div>
    
    <!-- Âú∞ÂõæÂÆπÂô® -->
    <div id="map"></div>
    
    <!-- Êä•ÂëäÊåâÈíÆ -->
    <div class="map-control">
        <a href="#" class="add-report-btn" id="addReportBtn">+ Ê∑ªÂä†Êä•Âëä</a>
        <span id="addReportTip" style="display:none;color:#ffb300;font-size:14px;margin-left:10px;">ËØ∑Âú®Âú∞Âõæ‰∏äÁÇπÈÄâ‰ΩçÁΩÆ</span>
    </div>
    
    <!-- Êä•ÂëäËÆ°Êï∞Âô®ÂºπÁ™ó -->
    <div class="report-counter-popup" id="reportCounterPopup">
        <h3 id="reportSuccessTitle">Êä•ÂëäÊèê‰∫§ÊàêÂäü!</h3>
        <p id="reportCounterText">ÊÇ®Â∑≤Á¥ØËÆ°Êèê‰∫§ <span class="counter-value" id="reportCountValue">1</span> Ê¨°Êä•Âëä</p>
        <button class="close-counter-popup" id="closeCounterPopup">Á°ÆÂÆö</button>
    </div>
    
    <!-- Êä•ÂëäË°®Âçï -->
    <div class="report-form" id="reportForm" style="position:fixed;bottom:0;left:0;right:0;background-color:#1c1c1e;padding:20px;border-radius:20px 20px 0 0;box-shadow:0 -2px 10px rgba(0,0,0,0.5);z-index:1001;transform:translateY(100%);transition:transform 0.3s ease-in-out;">
        <div class="form-header">
            <h2 class="form-title" id="formTitle">Êñ∞Êä•Âëä</h2>
            <button class="form-close" id="formClose" style="background:none;border:none;color:#fff;font-size:24px;cursor:pointer;">&times;</button>
        </div>
        
        <div class="form-group">
            <label class="form-label" id="photoLabel">ÁÖßÁâá</label>
            <div class="image-preview" style="width:100%;height:200px;border-radius:8px;background-color:#2c2c2e;display:flex;align-items:center;justify-content:center;margin-bottom:15px;overflow:hidden;position:relative;cursor:pointer;">
                <img src="" class="preview-img" id="previewImg" style="max-width:100%;max-height:100%;display:none;">
                <span class="image-placeholder" id="imagePlaceholder">ÁÇπÂáªÊ∑ªÂä†ÁÖßÁâá</span>
                <input type="file" id="imageInput" accept="image/*" style="position:absolute;left:0;top:0;width:100%;height:100%;opacity:0;cursor:pointer;z-index:2;">
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label" id="descLabel">ÊèèËø∞</label>
            <textarea class="form-textarea" id="descriptionInput" placeholder="ËØ∑ÊèèËø∞ÊÇ®ÁúãÂà∞ÁöÑÊÉÖÂÜµ..." style="width:100%;padding:12px;border-radius:8px;border:1px solid #444;background-color:#2c2c2e;color:#fff;font-size:16px;min-height:100px;resize:vertical;"></textarea>
        </div>
        
        <div style="display:flex;gap:10px;margin-top:15px;">
            <button class="submit-btn" id="submitReport" style="flex:1;background-color:#0071e3;color:white;border:none;padding:14px;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;">Á°ÆÂÆö</button>
            <button class="reset-location-btn" id="resetLocationBtn" style="flex:1;background-color:#ffc107;color:#000;border:none;padding:14px;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;">ÈáçÊñ∞ÈÄâÁÇπ</button>
            <button class="cancel-btn" id="cancelReport" style="flex:1;background-color:#3a3a3c;color:white;border:none;padding:14px;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;">ÂèñÊ∂à</button>
        </div>
    </div>
    
    <!-- FirebaseÂàùÂßãÂåñ -->
    <script>
        // FirebaseÈÖçÁΩÆ
        const firebaseConfig = {
            apiKey: "AIzaSyA41pAi6PZ7qQ8xrLbTg65Y6pcZBYMpLmY",
            authDomain: "ptvalert-19ea4.firebaseapp.com",
            databaseURL: "https://ptvalert-19ea4-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ptvalert-19ea4",
            storageBucket: "ptvalert-19ea4.appspot.com",
            messagingSenderId: "590126951854",
            appId: "1:590126951854:web:4cbc14144b0a395dc42c3f"
        };
        
        // ÂàùÂßãÂåñFirebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const auth = firebase.auth();
        const database = firebase.database();
        
        // Ëé∑ÂèñÊï∞ÊçÆÂ∫ìÂºïÁî®
        const reportsRef = database.ref('reports');
        
        // Áî®Êà∑Êä•ÂëäËÆ°Êï∞Âô®ÂºïÁî®
        const userReportsCountRef = database.ref('userReportsCount');
        
        // ÂºπÂπïÂäüËÉΩ
        const danmakuContainer = document.getElementById('danmakuContainer');
        const danmakuQueue = [];
        const activeDanmakus = [];
        let danmakuRunning = false;
        
        // ËØ≠Ë®ÄËÆæÁΩÆ
        let currentLang = 'zh';
        const i18n = {
            zh: {
                reportSuccess: 'Êä•ÂëäÊèê‰∫§ÊàêÂäü!',
                reportCounterText: 'ÊÇ®Â∑≤Á¥ØËÆ°Êèê‰∫§ {count} Ê¨°Êä•Âëä',
                closeButton: 'Á°ÆÂÆö',
                addReport: '+ Ê∑ªÂä†Êä•Âëä',
                newReport: 'Êñ∞Êä•Âëä',
                photo: 'ÁÖßÁâá',
                imagePlaceholder: 'ÁÇπÂáªÊ∑ªÂä†ÁÖßÁâá',
                description: 'ÊèèËø∞',
                descriptionPlaceholder: 'ËØ∑ÊèèËø∞ÊÇ®ÁúãÂà∞ÁöÑÊÉÖÂÜµ...',
                submit: 'Á°ÆÂÆö',
                resetLocation: 'ÈáçÊñ∞ÈÄâÁÇπ',
                cancel: 'ÂèñÊ∂à',
                selectLocation: 'ËØ∑Âú®Âú∞Âõæ‰∏äÁÇπÈÄâ‰ΩçÁΩÆ',
                reportDetails: 'Êä•ÂëäËØ¶ÊÉÖ',
                noDescription: 'Êó†ÊèèËø∞',
                selecting: 'Ê≠£Âú®ÈÄâÁÇπ...',
                translate: 'üåê',
                translating: 'ÁøªËØë‰∏≠...',
                translation: 'ÁøªËØë: ',
                refreshTramInfo: 'Âà∑Êñ∞ÁîµËΩ¶‰ø°ÊÅØ',
                addComment: 'Ê∑ªÂä†ËØÑËÆ∫',
                deleteReport: 'Âà†Èô§Êä•Âëä',
                commentPlaceholder: 'ÂÜô‰∏ãÊÇ®ÁöÑËØÑËÆ∫...',
                submitComment: 'ÂèëÈÄÅ',
                cancelComment: 'ÂèñÊ∂à',
                confirmDelete: 'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Êä•ÂëäÂêóÔºü',
                yes: 'ÊòØ',
                no: 'Âê¶',
                profile: '‰∏™‰∫∫ËµÑÊñô',
                logout: 'ÈÄÄÂá∫ÁôªÂΩï',
                comments: 'ËØÑËÆ∫',
                noComments: 'ÊöÇÊó†ËØÑËÆ∫'
            },
            en: {
                reportSuccess: 'Report submitted successfully!',
                reportCounterText: 'You have submitted {count} reports in total',
                closeButton: 'OK',
                addReport: '+ Add Report',
                newReport: 'New Report',
                photo: 'Photo',
                imagePlaceholder: 'Click to add photo',
                description: 'Description',
                descriptionPlaceholder: 'Describe what you see...',
                submit: 'Submit',
                resetLocation: 'Reset Location',
                cancel: 'Cancel',
                selectLocation: 'Please select a location on the map',
                reportDetails: 'Report Details',
                noDescription: 'No description',
                selecting: 'Selecting...',
                translate: 'üåê',
                translating: 'Translating...',
                translation: 'Translation: ',
                refreshTramInfo: 'Refresh Tram Info',
                addComment: 'Add Comment',
                deleteReport: 'Delete Report',
                commentPlaceholder: 'Write your comment...',
                submitComment: 'Send',
                cancelComment: 'Cancel',
                confirmDelete: 'Are you sure you want to delete this report?',
                yes: 'Yes',
                no: 'No',
                profile: 'Profile',
                logout: 'Logout',
                comments: 'Comments',
                noComments: 'No comments yet'
            }
        };
        
        // ÂΩìÂâçÁî®Êà∑ID
        let currentUserId = '';
        // Áî®Êà∑Êä•ÂëäËÆ°Êï∞
        let userReportCount = 0;
        // Áî®‰∫éÂ≠òÂÇ®ÈÄâ‰∏≠ÁöÑ‰ΩçÁΩÆ
        let selectedLocation = null;
        // ÈÄâÊã©‰ΩçÁΩÆÊ®°Âºè
        let isSelectingLocation = false;
        
        // Â¢®Â∞îÊú¨ÁîµËΩ¶ÂÖ¨ÂëäÊï∞ÊçÆ
        const tramAnnouncements = [
            "Route 1: Minor delays due to track maintenance between Stop 13 and Federation Square.",
            "Route 5: Service running smoothly with normal frequency.",
            "Route 11: Additional services added during peak hours due to increased demand.",
            "Route 16: Temporary stop closure at Melbourne University until further notice.",
            "Route 19: Normal service has resumed after earlier disruption.",
            "Route 48: Delays expected near Bridge Road due to road works.",
            "Route 57: Service changes this weekend for scheduled maintenance.",
            "Route 58: Increased frequency during AFL matches at MCG.",
            "Route 64: Minor delays expected due to traffic congestion in CBD area.",
            "Route 70: Service diverted between stops 10-15 due to street festival.",
            "Route 75: Service operating normally with good frequency.",
            "Route 86: Temporary stop relocation at Bourke Street due to construction.",
            "Route 96: Express service available during peak hours.",
            "All routes: Free tram zone remains in effect in CBD area.",
            "Safety reminder: Please hold handrails when tram is in motion."
        ];
        
        // Â¢®Â∞îÊú¨ÁîµËΩ¶ÂÖ¨Âëä‰∏≠ÊñáÁâà
        const tramAnnouncementsCN = [
            "1Âè∑Á∫øÔºö13Á´ôÂíåËÅîÈÇ¶ÂπøÂú∫‰πãÈó¥ÁöÑËΩ®ÈÅìÁª¥‰øÆÂØºËá¥ËΩªÂæÆÂª∂ËØØ„ÄÇ",
            "5Âè∑Á∫øÔºöÊúçÂä°Âπ≥Á®≥ËøêË°åÔºåÈ¢ëÁéáÊ≠£Â∏∏„ÄÇ",
            "11Âè∑Á∫øÔºöÂõ†ÈúÄÊ±ÇÂ¢ûÂä†ÔºåÈ´òÂ≥∞Êó∂ÊÆµÂ¢ûÂä†‰∫ÜÊúçÂä°„ÄÇ",
            "16Âè∑Á∫øÔºöÂ¢®Â∞îÊú¨Â§ßÂ≠¶Á´ô‰∏¥Êó∂ÂÖ≥Èó≠ÔºåÊÅ¢Â§çÊó∂Èó¥ÂæÖÂÆö„ÄÇ",
            "19Âè∑Á∫øÔºöÊó©ÂÖàÁöÑ‰∏≠Êñ≠ÂêéÔºåÊ≠£Â∏∏ÊúçÂä°Â∑≤ÊÅ¢Â§ç„ÄÇ",
            "48Âè∑Á∫øÔºöÁî±‰∫éÈÅìË∑ØÂ∑•Á®ãÔºåBridge RoadÈôÑËøëÈ¢ÑËÆ°‰ºöÊúâÂª∂ËØØ„ÄÇ",
            "57Âè∑Á∫øÔºöÊú¨Âë®Êú´ËÆ°ÂàíÁª¥Êä§ÔºåÊúçÂä°ÊúâÂèòÊõ¥„ÄÇ",
            "58Âè∑Á∫øÔºöMCG‰∏æË°åAFLÊØîËµõÊúüÈó¥ÔºåÂ¢ûÂä†È¢ëÁéá„ÄÇ",
            "64Âè∑Á∫øÔºöÁî±‰∫éÂ∏Ç‰∏≠ÂøÉÂå∫Âüü‰∫§ÈÄöÊã•Â†µÔºåÈ¢ÑËÆ°‰ºöÊúâËΩªÂæÆÂª∂ËØØ„ÄÇ",
            "70Âè∑Á∫øÔºöÂõ†Ë°óÂ§¥ËäÇÊó•Ê¥ªÂä®Ôºå10-15Á´ô‰πãÈó¥ÊúçÂä°ÊîπÈÅì„ÄÇ",
            "75Âè∑Á∫øÔºöÊúçÂä°Ê≠£Â∏∏ËøêË°åÔºåÈ¢ëÁéáËâØÂ•Ω„ÄÇ",
            "86Âè∑Á∫øÔºöÁî±‰∫éÂª∫Á≠ëÂ∑•Á®ãÔºåBourke StreetÁ´ô‰∏¥Êó∂ËøÅÁßª„ÄÇ",
            "96Âè∑Á∫øÔºöÈ´òÂ≥∞Êó∂ÊÆµÊèê‰æõÂø´ÈÄüÊúçÂä°„ÄÇ",
            "ÊâÄÊúâÁ∫øË∑ØÔºöÂ∏Ç‰∏≠ÂøÉÂå∫ÂüüÂÖçË¥πÁîµËΩ¶Âå∫‰ªçÁÑ∂ÊúâÊïà„ÄÇ",
            "ÂÆâÂÖ®ÊèêÈÜíÔºöÁîµËΩ¶Ë°åÈ©∂Êó∂ËØ∑Êâ∂Â•ΩÊâ∂Êâã„ÄÇ"
        ];
        
        // È™åËØÅÁî®Êà∑ÁôªÂΩïÁä∂ÊÄÅ
        function checkAuthState() {
            // È¶ñÂÖàÊ£ÄÊü•localStorage
            const isGuestUserLS = localStorage.getItem('isGuestUser') === 'true';
            const userLoggedInLS = localStorage.getItem('userLoggedIn') === 'true';
            const guestIdLS = localStorage.getItem('guestId');
            
            // Â¶ÇÊûúlocalStorageÊòæÁ§∫Áî®Êà∑Êú™ÁôªÂΩïÔºå‰∏çÂÜçËøõË°åÂêéÁª≠Ê£ÄÊü•
            if (!userLoggedInLS) {
                console.log('localStorageÊòæÁ§∫Áî®Êà∑Êú™ÁôªÂΩïÔºåÈáçÂÆöÂêëÂà∞ÁôªÂΩïÈ°µ...');
                window.location.href = 'login.html';
                return;
            }
            
            // Á°ÆÂÆöÊòØÂê¶‰∏∫Ê∏∏ÂÆ¢Ê®°Âºè
            const isGuestUser = isGuestUserLS;
            const userLoggedIn = userLoggedInLS;
            const guestId = guestIdLS || 'guest_user';
            
            if (isGuestUser && userLoggedIn) {
                console.log('‰ΩøÁî®Ê∏∏ÂÆ¢Ê®°Âºè...');
                console.log('Ê∏∏ÂÆ¢ID:', guestId);
                
                // ËÆæÁΩÆÂΩìÂâçÁî®Êà∑ID‰∏∫Ê∏∏ÂÆ¢ID
                currentUserId = guestId;
                
                // ÊòæÁ§∫Ê∏∏ÂÆ¢Ê®°ÂºèËèúÂçï
                const userMenu = document.getElementById('userMenu');
                const userDisplayName = document.getElementById('userDisplayName');
                // Ê†πÊçÆÂΩìÂâçËØ≠Ë®ÄËÆæÁΩÆÊòæÁ§∫ÊñáÊú¨
                userDisplayName.textContent = currentLang === 'zh' ? 'Ê∏∏ÂÆ¢' : 'Guest';
                userMenu.style.display = 'flex';
                
                // Âä†ËΩΩÁî®Êà∑Êä•ÂëäËÆ°Êï∞
                loadUserReportCount(currentUserId);
                
                return; // Ê∏∏ÂÆ¢Ê®°ÂºèÁôªÂΩïÊàêÂäüÔºå‰∏çÈúÄË¶ÅËøõ‰∏ÄÊ≠•Ê£ÄÊü•
            }
            
            // Â¶ÇÊûú‰∏çÊòØÊ∏∏ÂÆ¢Ê®°ÂºèÔºåÊ£ÄÊü•FirebaseËÆ§ËØÅ
            auth.onAuthStateChanged(function(user) {
                if (user) {
                    // Áî®Êà∑Â∑≤ÈÄöËøáFirebaseÁôªÂΩï
                    console.log('Áî®Êà∑Â∑≤ÁôªÂΩïFirebase:', user.uid, user.isAnonymous ? '(ÂåøÂêçÁî®Êà∑)' : '');
                    // Êõ¥Êñ∞ÂΩìÂâçÁî®Êà∑ID
                    currentUserId = user.uid;
                    
                    // Âä†ËΩΩÁî®Êà∑Êä•ÂëäËÆ°Êï∞
                    loadUserReportCount(currentUserId);
                    
                    // Êõ¥Êñ∞Áî®Êà∑ËèúÂçï
                    updateUserMenu(user);
                } else if (userLoggedIn) {
                    // Áî®Êà∑ÈÄöËøálocalStorageÁôªÂΩï‰ΩÜFirebase‰∏çËØÜÂà´
                    console.log('Áî®Êà∑Â∑≤ÈÄöËøálocalStorageÁôªÂΩï');
                    const userEmail = localStorage.getItem('userEmail') || (currentLang === 'zh' ? 'Áî®Êà∑' : 'User');
                    
                    // ‰ΩøÁî®email‰Ωú‰∏∫Áî®Êà∑ID
                    currentUserId = userEmail.replace(/[^a-zA-Z0-9]/g, '_');
                    
                    // Âä†ËΩΩÁî®Êà∑Êä•ÂëäËÆ°Êï∞
                    loadUserReportCount(currentUserId);
                    
                    // Êõ¥Êñ∞Áî®Êà∑ËèúÂçï
                    const userMenu = document.getElementById('userMenu');
                    const userDisplayName = document.getElementById('userDisplayName');
                    userDisplayName.textContent = userEmail.split('@')[0];
                    userMenu.style.display = 'flex';
                } else {
                    // Êú™ÁôªÂΩïÔºåÈáçÂÆöÂêëÂà∞ÁôªÂΩïÈ°µ
                    console.log('Áî®Êà∑Êú™ÁôªÂΩïÔºåÈáçÂÆöÂêëÂà∞ÁôªÂΩïÈ°µ...');
                    window.location.href = 'login.html';
                }
            });
        }
        
        // Âä†ËΩΩÁî®Êà∑Êä•ÂëäËÆ°Êï∞
        function loadUserReportCount(userId) {
            if (!userId) return;
            
            userReportsCountRef.child(userId).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        userReportCount = snapshot.val();
                        console.log(`Áî®Êà∑${userId}ÁöÑÊä•ÂëäËÆ°Êï∞‰∏∫:`, userReportCount);
                    } else {
                        userReportCount = 0;
                        console.log(`Áî®Êà∑${userId}Ê≤°ÊúâÊä•ÂëäËÆ∞ÂΩïÔºåÂàùÂßãÂåñËÆ°Êï∞‰∏∫0`);
                    }
                })
                .catch((error) => {
                    console.error('Âä†ËΩΩÁî®Êà∑Êä•ÂëäËÆ°Êï∞Âá∫Èîô:', error);
                    userReportCount = 0;
                });
        }
        
        // Êõ¥Êñ∞Áî®Êà∑Êä•ÂëäËÆ°Êï∞
        function incrementUserReportCount() {
            if (!currentUserId) return;
            
            userReportCount++;
            
            userReportsCountRef.child(currentUserId).set(userReportCount)
                .then(() => {
                    console.log(`Êõ¥Êñ∞Áî®Êà∑${currentUserId}ÁöÑÊä•ÂëäËÆ°Êï∞‰∏∫:`, userReportCount);
                    // ÊòæÁ§∫Êä•ÂëäËÆ°Êï∞Âô®ÂºπÁ™ó
                    showReportCounterPopup();
                })
                .catch((error) => {
                    console.error('Êõ¥Êñ∞Áî®Êà∑Êä•ÂëäËÆ°Êï∞Âá∫Èîô:', error);
                });
        }
        
        // ÊòæÁ§∫Êä•ÂëäËÆ°Êï∞Âô®ÂºπÁ™ó
        function showReportCounterPopup() {
            const popup = document.getElementById('reportCounterPopup');
            const countValueEl = document.getElementById('reportCountValue');
            
            // Á°Æ‰øùÂÖàËé∑ÂèñÊúÄÊñ∞ÁöÑÁî®Êà∑Êä•ÂëäËÆ°Êï∞
            userReportsCountRef.child(currentUserId).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        userReportCount = snapshot.val();
                    }
                    
                    // Êõ¥Êñ∞ÂºπÁ™óÊñáÊú¨
                    document.getElementById('reportSuccessTitle').textContent = i18n[currentLang].reportSuccess;
                    document.getElementById('reportCounterText').innerHTML = i18n[currentLang].reportCounterText.replace('{count}', '<span class="counter-value" id="reportCountValue">' + userReportCount + '</span>');
                    document.getElementById('closeCounterPopup').textContent = i18n[currentLang].closeButton;
                    
                    // ËÆæÁΩÆËÆ°Êï∞ÂÄº
                    countValueEl.textContent = userReportCount;
                    
                    // ÊòæÁ§∫ÂºπÁ™ó
                    popup.style.display = 'block';
                })
                .catch((error) => {
                    console.error('Ëé∑ÂèñÁî®Êà∑Êä•ÂëäËÆ°Êï∞Âá∫Èîô:', error);
                    popup.style.display = 'block';
                });
        }
        
        // ÂÖ≥Èó≠Êä•ÂëäËÆ°Êï∞Âô®ÂºπÁ™ó
        function closeReportCounterPopup() {
            const popup = document.getElementById('reportCounterPopup');
            popup.style.display = 'none';
        }
        
        // Ê∑ªÂä†Êñ∞Êä•Âëä
        function addNewReport(description, image, lat, lng) {
            if (!currentUserId) {
                console.error("Êú™ÊâæÂà∞Áî®Êà∑IDÔºåÊó†Ê≥ïÊèê‰∫§Êä•Âëä");
                return;
            }
            
            const newReport = {
                id: Date.now(), // ‰ΩøÁî®Êó∂Èó¥Êà≥‰Ωú‰∏∫ID
                lat: lat,
                lng: lng,
                description: description,
                time: new Date().toISOString(),
                image: image,
                emoji: "üê∂", // ÈªòËÆ§emoji
                comments: [],
                userId: currentUserId,
                userName: document.getElementById('userDisplayName').textContent || (currentLang === 'zh' ? 'Áî®Êà∑' : 'User')
            };
            
            // Ê†πÊçÆÊèèËø∞ÈÄâÊã©Ë°®ÊÉÖ
            if (description && (description.toLowerCase().includes('dog') || description.toLowerCase().includes('Áãó'))) {
                newReport.emoji = "üê∂";
            } else if (description && (description.toLowerCase().includes('traffic') || description.toLowerCase().includes('‰∫§ÈÄö'))) {
                newReport.emoji = "üöó";
            } else if (description && (description.toLowerCase().includes('food') || description.toLowerCase().includes('È§ê'))) {
                newReport.emoji = "üçî";
            } else if (description && (description.toLowerCase().includes('event') || description.toLowerCase().includes('Ê¥ªÂä®'))) {
                newReport.emoji = "üé™";
            }
            
            // ‰øùÂ≠òÂà∞Firebase
            reportsRef.child(newReport.id.toString()).set(newReport)
                .then(() => {
                    console.log("Report successfully saved to Firebase", newReport);
                    // ÂÖ≥Èó≠Êä•ÂëäË°®Âçï
                    closeReportForm();
                    // ÈáçÁΩÆË°®Âçï
                    resetReportForm();
                    
                    // ÁßªÈô§‰∏¥Êó∂ÈÄâÁÇπÊ†áËÆ∞ÔºàÂ¶ÇÊûúÊúâÔºâ
                    if (selectionMarker) {
                        selectionMarker.setMap(null);
                        selectionMarker = null;
                    }
                    
                    // Â¢ûÂä†Áî®Êà∑Êä•ÂëäËÆ°Êï∞
                    incrementUserReportCount();
                })
                .catch((error) => {
                    console.error("Error saving report to Firebase:", error);
                    alert("Êèê‰∫§Êä•ÂëäÂ§±Ë¥•: " + error.message);
                });
        }
        
        // ÊâìÂºÄÊä•ÂëäË°®Âçï
        function openReportForm() {
            const reportForm = document.getElementById('reportForm');
            reportForm.classList.add('active');
            reportForm.style.transform = 'translateY(0)';
        }
        
        // ÂÖ≥Èó≠Êä•ÂëäË°®Âçï
        function closeReportForm() {
            const reportForm = document.getElementById('reportForm');
            reportForm.classList.remove('active');
            reportForm.style.transform = 'translateY(100%)';
        }
        
        // ÈáçÁΩÆÊä•ÂëäË°®Âçï
        function resetReportForm() {
            document.getElementById('descriptionInput').value = '';
            document.getElementById('previewImg').style.display = 'none';
            document.getElementById('imagePlaceholder').style.display = 'block';
            document.getElementById('imageInput').value = '';
        }
        
        // Êõ¥Êñ∞Áî®Êà∑ËèúÂçïÊòæÁ§∫
        function updateUserMenu(user) {
            const userMenu = document.getElementById('userMenu');
            const userDisplayName = document.getElementById('userDisplayName');
            const profileMenuItem = document.getElementById('profileMenuItem');
            const logoutMenuItem = document.getElementById('logoutMenuItem');
            
            if (user) {
                // ‰ºòÂÖà‰ΩøÁî®Áî®Êà∑ÂêçÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî®ÈÇÆÁÆ±
                const displayName = user.displayName || user.email || (currentLang === 'zh' ? 'Áî®Êà∑' : 'User');
                userDisplayName.textContent = displayName.split('@')[0]; // Âè™ÊòæÁ§∫@ÂâçÈù¢ÁöÑÈÉ®ÂàÜ
                userMenu.style.display = 'flex';
                
                // Êõ¥Êñ∞ËèúÂçïÈ°πÊñáÊú¨
                profileMenuItem.textContent = i18n[currentLang].profile;
                logoutMenuItem.textContent = i18n[currentLang].logout;
            } else {
                userMenu.style.display = 'none';
            }
        }
        
        // Â§ÑÁêÜÂú∞ÂõæÁÇπÂáª‰∫ã‰ª∂ - ÈÄâÊã©Êä•Âëä‰ΩçÁΩÆ
        function handleMapClick(latLng) {
            if (!isSelectingLocation) return;
            
            selectedLocation = {
                lat: latLng.lat,
                lng: latLng.lng
            };
            
            // ÈáçÁΩÆÈÄâÊã©Ê®°Âºè
            isSelectingLocation = false;
            document.getElementById('addReportTip').style.display = 'none';
            document.getElementById('addReportBtn').textContent = i18n[currentLang].addReport;
            document.body.style.cursor = '';
            
            // ÊâìÂºÄÊä•ÂëäË°®Âçï
            openReportForm();
        }
        
        // Âú∞ÂõæÂèòÈáè
        let map;
        let markers = [];
        
        // Â¢®Â∞îÊú¨‰∏≠ÂøÉÂùêÊ†á
        const MELBOURNE_CENTER = { lat: -37.8136, lng: 144.9631 };
        
        // ÂàùÂßãÂåñÂú∞Âõæ
        function initMap() {
            console.log("initMapË¢´Ë∞ÉÁî®ÔºåÂàùÂßãÂåñÂú∞Âõæ...");
            // ÂàõÂª∫Âú∞Âõæ
            try {
                map = new google.maps.Map(document.getElementById("map"), {
                    center: MELBOURNE_CENTER,
                    zoom: 13,
                    mapTypeId: google.maps.MapTypeId.ROADMAP
                });
                
                // Ê∑ªÂä†Âú∞ÂõæÁÇπÂáª‰∫ã‰ª∂
                map.addListener("click", (event) => {
                    if (isSelectingLocation) {
                        // Ê∑ªÂä†‰∏¥Êó∂ÈÄâÁÇπÊ†áËÆ∞Âä®ÁîªÊïàÊûú
                        addSelectionMarker({
                            lat: event.latLng.lat(),
                            lng: event.latLng.lng()
                        });
                        
                        handleMapClick({
                            lat: event.latLng.lat(),
                            lng: event.latLng.lng()
                        });
                    }
                });
                
                // Âä†ËΩΩÊä•Âëä
                loadReportsFromFirebase();
                console.log("Âú∞ÂõæÂàùÂßãÂåñÂÆåÊàê!");
            } catch (error) {
                console.error("Âú∞ÂõæÂàùÂßãÂåñÂ§±Ë¥•:", error);
            }
        }
        
        // ‰∏¥Êó∂ÈÄâÁÇπÊ†áËÆ∞
        let selectionMarker = null;
        
        // Ê∑ªÂä†ÈÄâÁÇπÂä®ÁîªÊ†áËÆ∞
        function addSelectionMarker(location) {
            // Â¶ÇÊûúÂ∑≤Êúâ‰∏¥Êó∂Ê†áËÆ∞ÔºåÂÖàÁßªÈô§
            if (selectionMarker) {
                selectionMarker.setMap(null);
            }
            
            // ÂàõÂª∫Ê≥¢Á∫πÂä®ÁîªÊïàÊûú
            const rippleIcon = {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
                    `<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 60 60">
                        <circle cx="30" cy="30" r="20" fill="#666666" opacity="0.6">
                            <animate attributeName="r" from="10" to="30" dur="1.5s" begin="0s" repeatCount="indefinite"/>
                            <animate attributeName="opacity" from="0.6" to="0" dur="1.5s" begin="0s" repeatCount="indefinite"/>
                        </circle>
                        <circle cx="30" cy="30" r="10" fill="#666666" opacity="0.9"/>
                    </svg>`
                ),
                scaledSize: new google.maps.Size(60, 60),
                anchor: new google.maps.Point(30, 30)
            };
            
            // ÂàõÂª∫Ê†áËÆ∞
            selectionMarker = new google.maps.Marker({
                position: location,
                map: map,
                icon: rippleIcon,
                clickable: false,
                zIndex: 1000
            });
        }
        
        // ‰ªéFirebaseÂä†ËΩΩÊä•ÂëäÊï∞ÊçÆ
        function loadReportsFromFirebase() {
            reportsRef.on('value', (snapshot) => {
                // Ê∏ÖÈô§Áé∞ÊúâÊ†áËÆ∞
                markers.forEach(marker => {
                    marker.setMap(null);
                });
                markers = [];
                
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const report = childSnapshot.val();
                        addReportMarker(report);
                    });
                }
                
                console.log("Reports loaded from Firebase:", markers.length);
            });
        }
        
        // Ê∑ªÂä†Êä•ÂëäÊ†áËÆ∞Âà∞Âú∞Âõæ
        function addReportMarker(report) {
            if (!map) return;
            
            const now = new Date();
            const reportTime = new Date(report.time);
            const reportAgeHours = (now - reportTime) / (1000 * 60 * 60);
            
            // Ë∑≥ËøáË∂ÖËøá3Â∞èÊó∂ÁöÑÊä•Âëä
            if (reportAgeHours > 3) {
                console.log(`Report ID ${report.id} is older than 3 hours, not displaying`);
                return;
            }
            
            // ÂàõÂª∫Ê†áËÆ∞ - ‰ΩøÁî®ÁôΩËâ≤ËÉåÊôØ
            const markerIcon = {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
                    `<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40">
                        <circle cx="20" cy="20" r="18" fill="white" opacity="0.9"/>
                        <text x="20" y="28" font-size="24" text-anchor="middle" fill="black">${report.emoji}</text>
                    </svg>`
                ),
                scaledSize: new google.maps.Size(40, 40),
                anchor: new google.maps.Point(20, 20)
            };
            
            const marker = new google.maps.Marker({
                position: { lat: report.lat, lng: report.lng },
                map: map,
                icon: markerIcon,
                clickable: true,
                zIndex: 999
            });
            
            // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ - ÊòæÁ§∫Êä•ÂëäËØ¶ÊÉÖ
            marker.reportData = report;
            marker.addListener("click", function() {
                console.log('Report marker clicked:', this.reportData.id);
                showReportDetails(this.reportData);
            });
            
            markers.push(marker);
        }
        
        // Êä•ÂëäËØ¶ÊÉÖÂºπÁ™ó
        function showReportDetails(report) {
            // ÂÖàÊ£ÄÊü•ÊòØÂê¶Â∑≤ÊúâËØ¶ÊÉÖÂºπÁ™óÔºåÊúâÂàôÁßªÈô§
            let existingDetailPopup = document.getElementById('reportDetailPopup');
            if (existingDetailPopup) {
                existingDetailPopup.remove();
            }
            
            // ÂàõÂª∫ËØ¶ÊÉÖÂºπÁ™ó
            const detailPopup = document.createElement('div');
            detailPopup.id = 'reportDetailPopup';
            detailPopup.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:400px;background-color:rgba(33,33,33,0.95);border-radius:16px;padding:20px;z-index:2000;box-shadow:0 4px 20px rgba(0,0,0,0.5);color:white;animation:popup-fade-in 0.3s ease-out;max-height:90vh;overflow-y:auto;';
            
            // Ê∑ªÂä†ÂÖ≥Èó≠ÊåâÈíÆ
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '&times;';
            closeBtn.style.cssText = 'position:absolute;top:10px;right:15px;background:none;border:none;color:white;font-size:24px;cursor:pointer;';
            closeBtn.onclick = function() {
                detailPopup.remove();
            };
            detailPopup.appendChild(closeBtn);
            
            // Ê∑ªÂä†Êä•ÂëäÊó∂Èó¥ÂíåÁî®Êà∑‰ø°ÊÅØ
            const headerDiv = document.createElement('div');
            const reportTime = new Date(report.time);
            headerDiv.style.cssText = 'display:flex;justify-content:space-between;align-items:center;';
            headerDiv.innerHTML = `
                <span style="color:#aaa;font-size:14px;">${reportTime.toLocaleString()}</span>
                <span style="color:#aaa;font-size:14px;">üë§ ${report.userName || (currentLang === 'zh' ? 'Áî®Êà∑' : 'User')}</span>
            `;
            detailPopup.appendChild(headerDiv);
            
            // Ê∑ªÂä†Ê†áÈ¢ò
            const titleDiv = document.createElement('div');
            titleDiv.innerHTML = `<h3 style="margin:10px 0 15px;font-size:20px;">${report.emoji} ${i18n[currentLang].reportDetails}</h3>`;
            detailPopup.appendChild(titleDiv);
            
            // Ê∑ªÂä†ÂõæÁâáÔºàÂ¶ÇÊûúÊúâÔºâ
            if (report.image && report.image.length > 0) {
                const imageDiv = document.createElement('div');
                imageDiv.style.cssText = 'width:100%;height:200px;margin:15px 0;border-radius:8px;overflow:hidden;';
                const img = document.createElement('img');
                img.src = report.image;
                img.style.cssText = 'width:100%;height:100%;object-fit:cover;';
                imageDiv.appendChild(img);
                detailPopup.appendChild(imageDiv);
            }
            
            // Ê∑ªÂä†ÊèèËø∞ÂíåÁøªËØëÊåâÈíÆ
            const descDiv = document.createElement('div');
            descDiv.id = 'descriptionText';
            descDiv.style.cssText = 'margin:15px 0;padding:10px;background-color:rgba(255,255,255,0.1);border-radius:8px;';
            const descText = report.description || i18n[currentLang].noDescription;
            descDiv.innerText = descText;
            
            // Â¶ÇÊûúÊúâÊèèËø∞ÔºåÊ∑ªÂä†ÁøªËØëÊåâÈíÆ
            if (report.description) {
                const translateBtn = document.createElement('span');
                translateBtn.className = 'translate-btn';
                translateBtn.innerHTML = i18n[currentLang].translate;
                translateBtn.style.color = '#3498db'; // ËìùËâ≤Âú∞ÁêÉemojiÈááÁî®ËìùËâ≤
                translateBtn.onclick = function() {
                    this.innerText = i18n[currentLang].translating;
                    this.style.pointerEvents = 'none';
                    
                    // Ê£ÄÊµãÂéüÊñáËØ≠Ë®ÄÂπ∂ÁøªËØëÂà∞ÂØπÂ∫îËØ≠Ë®Ä
                    const isEnglish = /^[a-zA-Z0-9\s.,!?;:()"'-]+$/.test(descText.trim());
                    const targetLang = isEnglish ? 'zh' : 'en';
                    
                    // ÁøªËØëÊñáÊú¨
                    translateText(descText, targetLang)
                        .then(translatedText => {
                            const translatedDiv = document.createElement('div');
                            translatedDiv.className = 'translated-text';
                            translatedDiv.innerText = `${i18n[currentLang].translation}${translatedText}`;
                            
                            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÊúâÁøªËØëÔºåÂ¶ÇÊûúÊúâÂàôÊõøÊç¢
                            const existingTranslation = document.getElementById('translatedText');
                            if (existingTranslation) {
                                existingTranslation.remove();
                            }
                            
                            translatedDiv.id = 'translatedText';
                            descDiv.appendChild(translatedDiv);
                            
                            // ÈáçÁΩÆÊåâÈíÆ
                            this.innerHTML = i18n[currentLang].translate;
                            this.style.pointerEvents = 'auto';
                        })
                        .catch(error => {
                            console.error('ÁøªËØëÂ§±Ë¥•:', error);
                            // ÈáçÁΩÆÊåâÈíÆ
                            this.innerHTML = i18n[currentLang].translate;
                            this.style.pointerEvents = 'auto';
                        });
                };
                
                // Ê∑ªÂä†ÁøªËØëÊåâÈíÆÂà∞ÊèèËø∞div‰πãÂêé
                descDiv.appendChild(document.createElement('br'));
                descDiv.appendChild(translateBtn);
            }
            
            detailPopup.appendChild(descDiv);
            
            // Ê∑ªÂä†Êìç‰ΩúÊåâÈíÆÔºàËØÑËÆ∫ÂíåÂà†Èô§Ôºâ
            const actionDiv = document.createElement('div');
            actionDiv.style.cssText = 'display:flex;justify-content:space-between;margin:15px 0;';
            
            // Ê∑ªÂä†ËØÑËÆ∫ÊåâÈíÆ
            const commentBtn = document.createElement('button');
            commentBtn.innerHTML = 'üí¨'; // ËØÑËÆ∫Ê∞îÊ≥°emoji
            commentBtn.title = i18n[currentLang].addComment;
            commentBtn.style.cssText = 'background:rgba(255,255,255,0.2);border:none;color:white;border-radius:50%;width:40px;height:40px;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;';
            commentBtn.onclick = function() {
                showCommentForm(report, detailPopup);
            };
            actionDiv.appendChild(commentBtn);
            
            // Ê∑ªÂä†Âà†Èô§ÊåâÈíÆÔºà‰ªÖÂØπÊä•ÂëäÂàõÂª∫ËÄÖÊòæÁ§∫Ôºâ
            if (currentUserId === report.userId) {
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = 'üóëÔ∏è'; // ÂûÉÂúæÊ°∂emoji
                deleteBtn.title = i18n[currentLang].deleteReport;
                deleteBtn.style.cssText = 'background:rgba(255,80,80,0.2);border:none;color:white;border-radius:50%;width:40px;height:40px;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;';
                deleteBtn.onclick = function() {
                    confirmDeleteReport(report.id, detailPopup);
                };
                actionDiv.appendChild(deleteBtn);
            }
            
            detailPopup.appendChild(actionDiv);
            
            // ÊòæÁ§∫ËØÑËÆ∫Âå∫
            const commentsSection = document.createElement('div');
            commentsSection.id = 'commentsSection';
            commentsSection.style.cssText = 'margin-top:20px;';
            
            const commentsTitle = document.createElement('h4');
            commentsTitle.textContent = i18n[currentLang].comments;
            commentsTitle.style.cssText = 'margin-bottom:10px;font-size:16px;border-bottom:1px solid rgba(255,255,255,0.2);padding-bottom:5px;';
            commentsSection.appendChild(commentsTitle);
            
            // Âä†ËΩΩËØÑËÆ∫
            loadComments(report.id, commentsSection);
            
            detailPopup.appendChild(commentsSection);
            
            // Ê∑ªÂä†Âà∞ÊñáÊ°£
            document.body.appendChild(detailPopup);
            
            // Â∞ÜÊèèËø∞ÂèëÈÄÅÂà∞ÂºπÂπï
            if (report.description) {
                sendDanmaku(report.description);
            }
        }
        
        // ÊòæÁ§∫ËØÑËÆ∫Ë°®Âçï
        function showCommentForm(report, parentPopup) {
            // ÂàõÂª∫ËØÑËÆ∫Ë°®ÂçïÂÆπÂô®
            const commentFormDiv = document.createElement('div');
            commentFormDiv.id = 'commentFormDiv';
            commentFormDiv.style.cssText = 'margin-top:15px;background-color:rgba(255,255,255,0.1);border-radius:8px;padding:10px;';
            
            // ÂàõÂª∫ËØÑËÆ∫ËæìÂÖ•Ê°Ü
            const commentInput = document.createElement('textarea');
            commentInput.placeholder = i18n[currentLang].commentPlaceholder;
            commentInput.style.cssText = 'width:100%;min-height:60px;resize:vertical;padding:8px;border-radius:4px;border:1px solid #444;background-color:#2c2c2e;color:#fff;font-size:14px;';
            commentFormDiv.appendChild(commentInput);
            
            // ÂàõÂª∫ÊåâÈíÆÂÆπÂô®
            const btnContainer = document.createElement('div');
            btnContainer.style.cssText = 'display:flex;justify-content:flex-end;gap:10px;margin-top:10px;';
            
            // ÂèñÊ∂àÊåâÈíÆ
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = i18n[currentLang].cancelComment;
            cancelBtn.style.cssText = 'padding:6px 12px;border-radius:4px;border:none;background-color:#3a3a3c;color:white;cursor:pointer;';
            cancelBtn.onclick = function() {
                commentFormDiv.remove();
            };
            btnContainer.appendChild(cancelBtn);
            
            // Êèê‰∫§ÊåâÈíÆ
            const submitBtn = document.createElement('button');
            submitBtn.textContent = i18n[currentLang].submitComment;
            submitBtn.style.cssText = 'padding:6px 12px;border-radius:4px;border:none;background-color:#0071e3;color:white;cursor:pointer;';
            submitBtn.onclick = function() {
                const commentText = commentInput.value.trim();
                if (commentText) {
                    addComment(report.id, commentText);
                    commentFormDiv.remove();
                    // Âà∑Êñ∞ËØÑËÆ∫Âå∫
                    const commentsSection = document.getElementById('commentsSection');
                    if (commentsSection) {
                        loadComments(report.id, commentsSection);
                    }
                }
            };
            btnContainer.appendChild(submitBtn);
            
            commentFormDiv.appendChild(btnContainer);
            
            // Ê∑ªÂä†Âà∞Áà∂ÂºπÁ™ó
            parentPopup.appendChild(commentFormDiv);
            
            // ËÅöÁÑ¶ËæìÂÖ•Ê°Ü
            commentInput.focus();
        }
        
        // Ê∑ªÂä†ËØÑËÆ∫
        function addComment(reportId, commentText) {
            if (!currentUserId) return;
            
            const newComment = {
                id: Date.now(),
                userId: currentUserId,
                userName: document.getElementById('userDisplayName').textContent || (currentLang === 'zh' ? 'Áî®Êà∑' : 'User'),
                text: commentText,
                time: new Date().toISOString()
            };
            
            // Ëé∑ÂèñÊä•ÂëäÂºïÁî®
            const reportRef = reportsRef.child(reportId.toString());
            
            // ÂÖàËé∑ÂèñÂΩìÂâçËØÑËÆ∫ÔºåÁÑ∂ÂêéÊ∑ªÂä†Êñ∞ËØÑËÆ∫
            reportRef.child('comments').once('value')
                .then((snapshot) => {
                    let comments = [];
                    if (snapshot.exists()) {
                        comments = snapshot.val() || [];
                    }
                    
                    // Ê∑ªÂä†Êñ∞ËØÑËÆ∫
                    comments.push(newComment);
                    
                    // Êõ¥Êñ∞ËØÑËÆ∫ÂàóË°®
                    return reportRef.child('comments').set(comments);
                })
                .then(() => {
                    console.log('ËØÑËÆ∫Ê∑ªÂä†ÊàêÂäü');
                    // ÂèëÈÄÅËØÑËÆ∫Âà∞ÂºπÂπï
                    sendDanmaku(`üí¨ ${newComment.userName}: ${commentText}`);
                })
                .catch((error) => {
                    console.error('Ê∑ªÂä†ËØÑËÆ∫Â§±Ë¥•:', error);
                });
        }
        
        // Âä†ËΩΩËØÑËÆ∫
        function loadComments(reportId, commentsSection) {
            // Ê∏ÖÁ©∫Áé∞ÊúâÂÜÖÂÆπ
            while (commentsSection.childNodes.length > 1) {
                commentsSection.removeChild(commentsSection.lastChild);
            }
            
            // Ëé∑ÂèñÊä•ÂëäÁöÑËØÑËÆ∫
            reportsRef.child(reportId.toString()).child('comments').once('value')
                .then((snapshot) => {
                    if (snapshot.exists() && snapshot.val()) {
                        const comments = snapshot.val();
                        
                        // ÊòæÁ§∫ËØÑËÆ∫
                        comments.forEach(comment => {
                            const commentDiv = document.createElement('div');
                            commentDiv.style.cssText = 'margin-bottom:10px;padding:8px;background-color:rgba(255,255,255,0.05);border-radius:4px;';
                            
                            const commentHeader = document.createElement('div');
                            commentHeader.style.cssText = 'display:flex;justify-content:space-between;margin-bottom:5px;';
                            
                            const userName = document.createElement('span');
                            userName.textContent = `üë§ ${comment.userName || (currentLang === 'zh' ? 'Áî®Êà∑' : 'User')}`;
                            userName.style.cssText = 'font-weight:bold;font-size:14px;';
                            commentHeader.appendChild(userName);
                            
                            const commentTime = document.createElement('span');
                            commentTime.textContent = new Date(comment.time).toLocaleString();
                            commentTime.style.cssText = 'color:#aaa;font-size:12px;';
                            commentHeader.appendChild(commentTime);
                            
                            commentDiv.appendChild(commentHeader);
                            
                            const commentText = document.createElement('p');
                            commentText.textContent = comment.text;
                            commentText.style.cssText = 'margin:0;font-size:14px;';
                            commentDiv.appendChild(commentText);
                            
                            commentsSection.appendChild(commentDiv);
                        });
                    } else {
                        // Êó†ËØÑËÆ∫Êó∂ÊòæÁ§∫ÊèêÁ§∫
                        const noCommentsDiv = document.createElement('p');
                        noCommentsDiv.textContent = i18n[currentLang].noComments;
                        noCommentsDiv.style.cssText = 'color:#aaa;font-style:italic;text-align:center;font-size:14px;';
                        commentsSection.appendChild(noCommentsDiv);
                    }
                })
                .catch((error) => {
                    console.error('Âä†ËΩΩËØÑËÆ∫Â§±Ë¥•:', error);
                    const errorDiv = document.createElement('p');
                    errorDiv.textContent = 'Error loading comments';
                    errorDiv.style.cssText = 'color:red;text-align:center;';
                    commentsSection.appendChild(errorDiv);
                });
        }
        
        // Á°ÆËÆ§Âà†Èô§Êä•Âëä
        function confirmDeleteReport(reportId, parentPopup) {
            // ÂàõÂª∫Á°ÆËÆ§ÂºπÁ™ó
            const confirmDiv = document.createElement('div');
            confirmDiv.style.cssText = 'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background-color:rgba(40,40,40,0.95);border-radius:8px;padding:15px;width:80%;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,0.7);z-index:2001;';
            
            const confirmText = document.createElement('p');
            confirmText.textContent = i18n[currentLang].confirmDelete;
            confirmText.style.cssText = 'margin-bottom:15px;font-size:16px;';
            confirmDiv.appendChild(confirmText);
            
            const btnContainer = document.createElement('div');
            btnContainer.style.cssText = 'display:flex;justify-content:center;gap:15px;';
            
            // Á°ÆËÆ§ÊåâÈíÆ
            const yesBtn = document.createElement('button');
            yesBtn.textContent = i18n[currentLang].yes;
            yesBtn.style.cssText = 'padding:8px 16px;border-radius:4px;border:none;background-color:#e53935;color:white;cursor:pointer;';
            yesBtn.onclick = function() {
                deleteReport(reportId);
                parentPopup.remove();
            };
            btnContainer.appendChild(yesBtn);
            
            // ÂèñÊ∂àÊåâÈíÆ
            const noBtn = document.createElement('button');
            noBtn.textContent = i18n[currentLang].no;
            noBtn.style.cssText = 'padding:8px 16px;border-radius:4px;border:none;background-color:#3a3a3c;color:white;cursor:pointer;';
            noBtn.onclick = function() {
                confirmDiv.remove();
            };
            btnContainer.appendChild(noBtn);
            
            confirmDiv.appendChild(btnContainer);
            
            // Ê∑ªÂä†Âà∞Áà∂ÂºπÁ™ó
            parentPopup.appendChild(confirmDiv);
        }
        
        // Âà†Èô§Êä•Âëä
        function deleteReport(reportId) {
            reportsRef.child(reportId.toString()).remove()
                .then(() => {
                    console.log('Êä•ÂëäÂà†Èô§ÊàêÂäü');
                    
                    // Âà†Èô§ÂØπÂ∫îÁöÑÊ†áËÆ∞
                    const markerIndex = markers.findIndex(marker => marker.reportData && marker.reportData.id === reportId);
                    if (markerIndex !== -1) {
                        markers[markerIndex].setMap(null);
                        markers.splice(markerIndex, 1);
                    }
                })
                .catch((error) => {
                    console.error('Âà†Èô§Êä•ÂëäÂ§±Ë¥•:', error);
                    alert(currentLang === 'zh' ? 'Âà†Èô§Â§±Ë¥•ÔºåËØ∑ÈáçËØï' : 'Delete failed, please try again');
                });
        }
        
        // ÁÆÄÂçïÁöÑÊñáÊú¨ÁøªËØëÂáΩÊï∞Ôºà‰ΩøÁî®Ê®°ÊãüÁøªËØëÔºåÂÆûÈôÖÂ∫îÁî®‰∏≠Â∫îÊõøÊç¢‰∏∫ÁúüÂÆûAPIÔºâ
        async function translateText(text, targetLang) {
            // Âú®ÂÆûÈôÖÂ∫îÁî®‰∏≠ÔºåËøôÈáåÂ∫îËØ•Ë∞ÉÁî®ÁøªËØëAPIÔºåÂ¶ÇGoogle Translate API
            // ËøôÈáå‰ΩøÁî®ÁÆÄÂçïÊ®°ÊãüÔºåÊ†πÊçÆÁõÆÊ†áËØ≠Ë®ÄËøîÂõû‰∏çÂêåÁöÑÊñáÊú¨
            
            // Âª∂Êó∂1ÁßíÊ®°ÊãüAPIË∞ÉÁî®
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            if (targetLang === 'zh') {
                // Ëã±ÊñáÂà∞‰∏≠ÊñáÁöÑÁÆÄÂçïÊò†Â∞Ñ
                const enToCnMap = {
                    'dog': 'Áãó',
                    'cat': 'Áå´',
                    'hello': '‰Ω†Â•Ω',
                    'traffic': '‰∫§ÈÄö',
                    'accident': '‰∫ãÊïÖ',
                    'attention': 'Ê≥®ÊÑè',
                    'caution': 'Â∞èÂøÉ',
                    'danger': 'Âç±Èô©',
                    'warning': 'Ë≠¶Âëä',
                    'help': 'Â∏ÆÂä©',
                    'police': 'Ë≠¶ÂØü',
                    'emergency': 'Á¥ßÊÄ•ÊÉÖÂÜµ',
                    'crowded': 'Êã•Êå§',
                    'delayed': 'Âª∂ËØØ',
                    'cancelled': 'ÂèñÊ∂à',
                    'closed': 'ÂÖ≥Èó≠',
                    'open': 'ÂºÄÊîæ',
                };
                
                let translated = text;
                Object.keys(enToCnMap).forEach(key => {
                    const regex = new RegExp(key, 'gi');
                    translated = translated.replace(regex, enToCnMap[key]);
                });
                
                return translated;
            } else {
                // ‰∏≠ÊñáÂà∞Ëã±ÊñáÁöÑÁÆÄÂçïÊò†Â∞Ñ
                const cnToEnMap = {
                    'Áãó': 'dog',
                    'Áå´': 'cat',
                    '‰Ω†Â•Ω': 'hello',
                    '‰∫§ÈÄö': 'traffic',
                    '‰∫ãÊïÖ': 'accident',
                    'Ê≥®ÊÑè': 'attention',
                    'Â∞èÂøÉ': 'caution',
                    'Âç±Èô©': 'danger',
                    'Ë≠¶Âëä': 'warning',
                    'Â∏ÆÂä©': 'help',
                    'Ë≠¶ÂØü': 'police',
                    'Á¥ßÊÄ•ÊÉÖÂÜµ': 'emergency',
                    'Êã•Êå§': 'crowded',
                    'Âª∂ËØØ': 'delayed',
                    'ÂèñÊ∂à': 'cancelled',
                    'ÂÖ≥Èó≠': 'closed',
                    'ÂºÄÊîæ': 'open',
                };
                
                let translated = text;
                Object.keys(cnToEnMap).forEach(key => {
                    translated = translated.replace(new RegExp(key, 'g'), cnToEnMap[key]);
                });
                
                return translated;
            }
        }
        
        // ÂºπÂπïÁõ∏ÂÖ≥ÂáΩÊï∞
        function sendDanmaku(text) {
            // ÈôêÂà∂ÈïøÂ∫¶ÔºåËøáÈïøÁöÑÊñáÊú¨‰ºöË¢´Êà™Êñ≠
            const maxLength = 30;
            let danmakuText = text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
            
            // Â¶ÇÊûúÊñáÊú¨‰∏∫Á©∫Ôºå‰∏çÊòæÁ§∫ÂºπÂπï
            if (!danmakuText.trim()) return;
            
            // Â∞ùËØïÊ†πÊçÆÂΩìÂâçËØ≠Ë®ÄËøõË°åÁøªËØë
            if (currentLang === 'en') {
                // Â¶ÇÊûúÂΩìÂâçÊòØËã±ÊñáÁïåÈù¢Ôºå‰ΩÜÂÜÖÂÆπÂåÖÂê´‰∏≠ÊñáÂ≠óÁ¨¶ÔºåÂ∞ùËØïËΩ¨‰∏∫Ëã±Êñá
                if (/[\u4e00-\u9fa5]/.test(danmakuText)) {
                    // ÁÆÄÂçïÁöÑ‰∏≠Ëã±ÊñáÂÖ≥ÈîÆËØçÊò†Â∞Ñ
                    const cnToEnMap = {
                        'Áãó': 'dog',
                        'Áå´': 'cat',
                        '‰Ω†Â•Ω': 'hello',
                        '‰∫§ÈÄö': 'traffic',
                        '‰∫ãÊïÖ': 'accident',
                        'Ê≥®ÊÑè': 'attention',
                        'Â∞èÂøÉ': 'caution',
                        'Âç±Èô©': 'danger',
                        'Ë≠¶Âëä': 'warning',
                        'Â∏ÆÂä©': 'help',
                        'Ë≠¶ÂØü': 'police',
                        'Á¥ßÊÄ•ÊÉÖÂÜµ': 'emergency',
                        'Êã•Êå§': 'crowded',
                        'Âª∂ËØØ': 'delayed',
                        'ÂèñÊ∂à': 'cancelled',
                        'ÂÖ≥Èó≠': 'closed',
                        'ÂºÄÊîæ': 'open',
                        'Ê≠£Â∏∏': 'normal',
                        'ÊúçÂä°': 'service',
                        'ÁîµËΩ¶': 'tram',
                        'ËΩ®ÈÅì': 'track',
                        'Áª¥‰øÆ': 'maintenance',
                        'Á´ô': 'stop',
                        '‰∏¥Êó∂': 'temporary',
                        'È¢ëÁéá': 'frequency',
                        'È´òÂ≥∞': 'peak',
                        'Â∏Ç‰∏≠ÂøÉ': 'CBD',
                        'Á∫ø': 'route',
                        'Âè∑Á∫ø': 'route',
                        'Ê∏∏ÂÆ¢': 'Guest',
                        'Ê∑ªÂä†': 'Add',
                        'Êä•Âëä': 'Report',
                        'ËØÑËÆ∫': 'Comment',
                        'Ê¨¢Ëøé': 'Welcome',
                        '‰ΩøÁî®': 'using',
                        'Âú∞Âõæ': 'map',
                        'Á≥ªÁªü': 'system'
                    };
                    
                    // Â∞ùËØïÊõøÊç¢‰∏≠ÊñáÂÖ≥ÈîÆËØç
                    for (const [cn, en] of Object.entries(cnToEnMap)) {
                        danmakuText = danmakuText.replace(new RegExp(cn, 'g'), en);
                    }
                    
                    // ÂØπ‰∫éÂ∏∏ËßÅÁöÑÁ∫øË∑ØÂÖ¨ÂëäÊ†ºÂºèËøõË°åÁâπÊÆäÂ§ÑÁêÜ
                    danmakuText = danmakuText.replace(/(\d+)Âè∑Á∫ø/g, 'Route $1');
                }
            } else if (currentLang === 'zh') {
                // Â¶ÇÊûúÂΩìÂâçÊòØ‰∏≠ÊñáÁïåÈù¢Ôºå‰ΩÜÂÜÖÂÆπ‰∏çÂåÖÂê´‰∏≠ÊñáÂ≠óÁ¨¶ÔºåÂèØËÉΩÊòØËã±Êñá
                if (!/[\u4e00-\u9fa5]/.test(danmakuText) && danmakuText.length > 5) {
                    // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†Ëã±ÊñáÂà∞‰∏≠ÊñáÁöÑÁÆÄÂçïËΩ¨Êç¢Ôºå‰ΩÜÈªòËÆ§‰øùÁïôËã±Êñá‰πüÂèØ‰ª•
                    // ÁÆÄÂçïÂ§ÑÁêÜRouteÊ†ºÂºè
                    danmakuText = danmakuText.replace(/Route (\d+)/g, '$1Âè∑Á∫ø');
                }
            }
            
            // Ê∑ªÂä†Âà∞ÈòüÂàó
            danmakuQueue.push(danmakuText);
            
            // Â¶ÇÊûúÂºπÂπïÁ≥ªÁªüÊú™ËøêË°åÔºåÂêØÂä®ÂÆÉ
            if (!danmakuRunning) {
                processDanmakuQueue();
            }
        }
        
        function processDanmakuQueue() {
            if (danmakuQueue.length === 0) {
                danmakuRunning = false;
                return;
            }
            
            danmakuRunning = true;
            const text = danmakuQueue.shift();
            createDanmaku(text);
            
            // ÊØèÈöî‰∏ÄÊÆµÊó∂Èó¥Â§ÑÁêÜ‰∏ã‰∏Ä‰∏™ÂºπÂπï
            setTimeout(processDanmakuQueue, 2500);
        }
        
        function createDanmaku(text) {
            // Â§ÑÁêÜÊñáÊú¨‰∏≠ÁöÑÁ∫øË∑Ø‰ø°ÊÅØÔºåÊ†πÊçÆÂΩìÂâçËØ≠Ë®ÄËøõË°åËΩ¨Êç¢
            if (currentLang === 'en') {
                // ËΩ¨Êç¢‰∏≠ÊñáÁöÑÁ∫øË∑ØÈÄöÁü•Ê†ºÂºè‰∏∫Ëã±Êñá
                text = text.replace(/(\d+)Âè∑Á∫ø[:Ôºö](.+)/, 'Route $1: $2');
                
                // ÊõøÊç¢Â∏∏ËßÅ‰∏≠ÊñáÊñáÊú¨
                const commonPhrases = {
                    'ËΩªÂæÆÂª∂ËØØ': 'minor delays',
                    'Ê≠£Â∏∏ÊúçÂä°': 'normal service',
                    'ËΩ®ÈÅìÁª¥‰øÆ': 'track maintenance',
                    '‰∏¥Êó∂ÂÖ≥Èó≠': 'temporarily closed',
                    'È´òÂ≥∞Êó∂ÊÆµ': 'peak hours',
                    'ÊúçÂä°ÂèòÊõ¥': 'service changes',
                    'Â¢ûÂä†È¢ëÁéá': 'increased frequency',
                    'Êú¨Âë®Êú´': 'this weekend',
                    'ËÆ°ÂàíÁª¥Êä§': 'scheduled maintenance',
                    '‰πãÈó¥': 'between',
                    'ÈôÑËøë': 'near',
                    'È¢ÑËÆ°': 'expected',
                    'ÂØºËá¥': 'due to',
                    'Áî±‰∫é': 'due to',
                    'ÈÅìË∑ØÂ∑•Á®ã': 'road works',
                    'ÊúçÂä°Â∑≤ÊÅ¢Â§ç': 'service has resumed',
                    'Êó©ÂÖàÁöÑ‰∏≠Êñ≠': 'earlier disruption'
                };
                
                for (const [cn, en] of Object.entries(commonPhrases)) {
                    text = text.replace(new RegExp(cn, 'g'), en);
                }
            } else if (currentLang === 'zh') {
                // ËΩ¨Êç¢Ëã±ÊñáÁöÑÁ∫øË∑ØÈÄöÁü•Ê†ºÂºè‰∏∫‰∏≠Êñá
                text = text.replace(/Route (\d+): (.+)/, '$1Âè∑Á∫ø: $2');
                
                // ÊõøÊç¢Â∏∏ËßÅËã±ÊñáÊñáÊú¨
                const commonPhrases = {
                    'minor delays': 'ËΩªÂæÆÂª∂ËØØ',
                    'normal service': 'Ê≠£Â∏∏ÊúçÂä°',
                    'track maintenance': 'ËΩ®ÈÅìÁª¥‰øÆ',
                    'temporarily closed': '‰∏¥Êó∂ÂÖ≥Èó≠',
                    'peak hours': 'È´òÂ≥∞Êó∂ÊÆµ',
                    'service changes': 'ÊúçÂä°ÂèòÊõ¥',
                    'increased frequency': 'Â¢ûÂä†È¢ëÁéá',
                    'this weekend': 'Êú¨Âë®Êú´',
                    'scheduled maintenance': 'ËÆ°ÂàíÁª¥Êä§',
                    'between': '‰πãÈó¥',
                    'near': 'ÈôÑËøë',
                    'expected': 'È¢ÑËÆ°',
                    'due to': 'Áî±‰∫é',
                    'road works': 'ÈÅìË∑ØÂ∑•Á®ã',
                    'service has resumed': 'ÊúçÂä°Â∑≤ÊÅ¢Â§ç',
                    'earlier disruption': 'Êó©ÂÖàÁöÑ‰∏≠Êñ≠'
                };
                
                for (const [en, cn] of Object.entries(commonPhrases)) {
                    text = text.replace(new RegExp(en, 'gi'), cn);
                }
            }
            
            const danmaku = document.createElement('div');
            danmaku.className = 'danmaku';
            danmaku.textContent = text;
            
            // ÈöèÊú∫È¢úËâ≤
            const colors = ['#ffffff', '#ff9900', '#00cc99', '#66ccff', '#ff6666', '#cc99ff'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            danmaku.style.color = color;
            
            // ÈöèÊú∫Ë°åÈ´ò‰ΩçÁΩÆÔºåÈÅøÂÖçÈáçÂè†
            const lane = Math.floor(Math.random() * 8);
            danmaku.style.top = (lane * 40 + 20) + 'px';
            
            // ËÆ°ÁÆóÂä®ÁîªÊåÅÁª≠Êó∂Èó¥ÔºàÊ†πÊçÆÊñáÊú¨ÈïøÂ∫¶Ë∞ÉÊï¥Ôºâ
            // Â¢ûÂä†Âü∫Á°ÄÊó∂Èó¥ÂíåÈöèÊú∫Êó∂Èó¥Ôºå‰ΩøÂºπÂπïÈÄüÂ∫¶ÂèòÊÖ¢
            const duration = 10 + Math.random() * 5; // ÂéüÊù•ÊòØ5+3ÔºåÁé∞Âú®Êîπ‰∏∫10+5
            danmaku.style.animationDuration = duration + 's';
            
            // Ê∑ªÂä†Âà∞ÂÆπÂô®
            danmakuContainer.appendChild(danmaku);
            
            // Ê∑ªÂä†Âà∞Ê¥ªÂä®ÂºπÂπïÂàóË°®
            activeDanmakus.push(danmaku);
            
            // Âä®ÁîªÁªìÊùüÂêéÂà†Èô§
            setTimeout(() => {
                danmaku.remove();
                const index = activeDanmakus.indexOf(danmaku);
                if (index > -1) {
                    activeDanmakus.splice(index, 1);
                }
            }, duration * 1000);
        }
        
        // ÂàùÂßãÂåñÂºπÂπïÁ≥ªÁªü
        function initDanmakuSystem() {
            // Ê∏ÖÁ©∫Áé∞ÊúâÈòüÂàó
            danmakuQueue.length = 0;
            
            // Ê∑ªÂä†ÁîµËΩ¶ÂÖ¨ÂëäÂà∞ÈòüÂàó
            const announcements = currentLang === 'zh' ? tramAnnouncementsCN : tramAnnouncements;
            announcements.forEach(announcement => {
                danmakuQueue.push(announcement);
            });
            
            // Ê∑ªÂä†Ê¨¢ËøéÊ∂àÊÅØ
            danmakuQueue.push(currentLang === 'zh' ? "Ê¨¢Ëøé‰ΩøÁî®PtvAlertÂú∞ÂõæÊä•ÂëäÁ≥ªÁªü" : "Welcome to PtvAlert Map Reporting System");
            
            // ÂêØÂä®ÂºπÂπïÂ§ÑÁêÜ
            if (!danmakuRunning) {
                processDanmakuQueue();
            }
        }
        
        // Ê∑ªÂä†Âà∑Êñ∞ÁîµËΩ¶‰ø°ÊÅØÊåâÈíÆ
        function addRefreshTramButton() {
            const refreshBtn = document.createElement('button');
            refreshBtn.id = 'refreshTramBtn';
            refreshBtn.style.cssText = 'position:fixed;top:60px;left:18px;z-index:1001;background:rgba(255,255,255,0.8);color:#333;border-radius:20px;padding:6px 12px;font-size:14px;font-weight:bold;box-shadow:0 2px 12px rgba(0,0,0,0.18);border:2px solid #0071e3;cursor:pointer;display:flex;align-items:center;gap:6px;';
            refreshBtn.innerHTML = `<span style="font-size:16px;">üöÉ</span><span id="refreshTramText">${i18n[currentLang].refreshTramInfo}</span>`;
            
            refreshBtn.addEventListener('click', function() {
                initDanmakuSystem();
            });
            
            document.body.appendChild(refreshBtn);
        }
    </script>
    
    <!-- Ê∑ªÂä†Google Maps API -->
    <script>
        // Google Maps API Âä†ËΩΩÂõûË∞É
        function googleMapsLoadedCallback() {
            console.log("Google Maps Â∑≤Âä†ËΩΩÔºåÂàùÂßãÂåñÂú∞Âõæ...");
            if (typeof initMap === 'function') {
                initMap();
            }
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCE-oMIlcnOeqplgMmL9y1qcU6A9-HBu9U&callback=googleMapsLoadedCallback&libraries=places"></script>
    
    <!-- DOMÂ∞±Áª™ÂêéÂàùÂßãÂåñ -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOMÂ∑≤Âä†ËΩΩÔºåÊ£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ...");
            
            // È¶ñÂÖàÊ£ÄÊü•Áî®Êà∑ÊòØÂê¶Â∑≤ÁôªÂΩïÔºåÂ¶ÇÊûúÊú™ÁôªÂΩïÂàôÈáçÂÆöÂêëÂà∞ÁôªÂΩïÈ°µÈù¢
            const userLoggedIn = localStorage.getItem('userLoggedIn') === 'true';
            if (!userLoggedIn) {
                console.log('Áî®Êà∑Êú™ÁôªÂΩïÔºåÈáçÂÆöÂêëÂà∞ÁôªÂΩïÈ°µ...');
                window.location.href = 'login.html';
                return;
            }
            
            console.log("Áî®Êà∑Â∑≤ÁôªÂΩïÔºåÁ≠âÂæÖGoogle Maps APIÂõûË∞É...");
            
            // ÂàùÂßãÂåñÁî®Êà∑ËÆ§ËØÅ
            checkAuthState();
            
            // Ê∑ªÂä†Âà∑Êñ∞ÁîµËΩ¶‰ø°ÊÅØÊåâÈíÆ
            addRefreshTramButton();
            
            // ÂÖ≥Èó≠Êä•ÂëäËÆ°Êï∞Âô®ÂºπÁ™óÊåâÈíÆ‰∫ã‰ª∂
            document.getElementById('closeCounterPopup').addEventListener('click', function() {
                closeReportCounterPopup();
            });
            
            // Ê∑ªÂä†Êä•ÂëäÊåâÈíÆ‰∫ã‰ª∂
            document.getElementById('addReportBtn').addEventListener('click', function(e) {
                e.preventDefault();
                if (isSelectingLocation) return;
                
                isSelectingLocation = true;
                document.getElementById('addReportTip').style.display = 'inline';
                document.getElementById('addReportTip').textContent = i18n[currentLang].selectLocation;
                document.getElementById('addReportBtn').textContent = i18n[currentLang].selecting;
                document.body.style.cursor = 'crosshair';
            });
            
            // ËØ≠Ë®ÄÂàáÊç¢ÊåâÈíÆ‰∫ã‰ª∂
            document.getElementById('langSwitchBtn').addEventListener('click', function() {
                // ÂàáÊç¢ËØ≠Ë®Ä
                currentLang = currentLang === 'zh' ? 'en' : 'zh';
                
                // Êõ¥Êñ∞ÁïåÈù¢ÊñáÊú¨
                updateFormLanguage();
                
                // Êõ¥Êñ∞ËØ≠Ë®ÄÂàáÊç¢ÊåâÈíÆÊñáÊú¨
                document.getElementById('langSwitchText').textContent = currentLang === 'zh' ? 'EN' : '‰∏≠';
                
                // Â≠òÂÇ®ËØ≠Ë®ÄËÆæÁΩÆ
                localStorage.setItem('language', currentLang);
                
                // Êõ¥Êñ∞Âà∑Êñ∞ÁîµËΩ¶ÊåâÈíÆÊñáÊú¨
                document.getElementById('refreshTramText').textContent = i18n[currentLang].refreshTramInfo;
                
                // Â¶ÇÊûúÊòØÊ∏∏ÂÆ¢Ê®°ÂºèÔºåÊõ¥Êñ∞Ê∏∏ÂÆ¢ÊòæÁ§∫Ê†áÁ≠æ
                if (localStorage.getItem('isGuestUser') === 'true') {
                    document.getElementById('userDisplayName').textContent = currentLang === 'zh' ? 'Ê∏∏ÂÆ¢' : 'Guest';
                }
                
                // ÈáçÊñ∞ÂàùÂßãÂåñÂºπÂπïÁ≥ªÁªüÔºå‰ΩøÂÖ∂‰ΩøÁî®ÂΩìÂâçËØ≠Ë®Ä
                initDanmakuSystem();
                
                console.log('ËØ≠Ë®ÄÂ∑≤ÂàáÊç¢‰∏∫:', currentLang);
            });
            
            // Ë°®ÂçïÂÖ≥Èó≠ÊåâÈíÆ‰∫ã‰ª∂
            document.getElementById('formClose').addEventListener('click', function() {
                closeReportForm();
            });
            
            // ÂèñÊ∂àÊåâÈíÆ‰∫ã‰ª∂
            document.getElementById('cancelReport').addEventListener('click', function() {
                closeReportForm();
            });
            
            // ÈáçÊñ∞ÈÄâÁÇπÊåâÈíÆ‰∫ã‰ª∂
            document.getElementById('resetLocationBtn').addEventListener('click', function() {
                closeReportForm();
                
                // Âª∂Ëøü‰∏ÄÁÇπÂêØÂä®ÈÄâÁÇπÊ®°ÂºèÔºåËÆ©Ë°®ÂçïÊúâÊó∂Èó¥ÂÖ≥Èó≠
                setTimeout(function() {
                    isSelectingLocation = true;
                    document.getElementById('addReportTip').style.display = 'inline';
                    document.getElementById('addReportTip').textContent = i18n[currentLang].selectLocation;
                    document.getElementById('addReportBtn').textContent = i18n[currentLang].selecting;
                    document.body.style.cursor = 'crosshair';
                }, 300);
            });
            
            // ÂõæÁâáÈ¢ÑËßà
            document.getElementById('imageInput').addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('previewImg').src = e.target.result;
                        document.getElementById('previewImg').style.display = 'block';
                        document.getElementById('imagePlaceholder').style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Êèê‰∫§Êä•Âëä
            document.getElementById('submitReport').addEventListener('click', function() {
                const description = document.getElementById('descriptionInput').value.trim();
                if (!description) {
                    alert('ËØ∑ËæìÂÖ•ÊèèËø∞');
                    return;
                }
                
                if (!selectedLocation) {
                    alert('ËØ∑ÂÖàÂú®Âú∞Âõæ‰∏äÈÄâÊã©‰ΩçÁΩÆ');
                    closeReportForm();
                    return;
                }
                
                let imageData = '';
                if (document.getElementById('previewImg').style.display !== 'none') {
                    imageData = document.getElementById('previewImg').src;
                }
                
                addNewReport(description, imageData, selectedLocation.lat, selectedLocation.lng);
            });
            
            // Êõ¥Êñ∞Ë°®ÂçïËØ≠Ë®ÄÊñáÊú¨
            function updateFormLanguage() {
                document.getElementById('formTitle').textContent = i18n[currentLang].newReport;
                document.getElementById('photoLabel').textContent = i18n[currentLang].photo;
                document.getElementById('imagePlaceholder').textContent = i18n[currentLang].imagePlaceholder;
                document.getElementById('descLabel').textContent = i18n[currentLang].description;
                document.getElementById('descriptionInput').placeholder = i18n[currentLang].descriptionPlaceholder;
                document.getElementById('submitReport').textContent = i18n[currentLang].submit;
                document.getElementById('resetLocationBtn').textContent = i18n[currentLang].resetLocation;
                document.getElementById('cancelReport').textContent = i18n[currentLang].cancel;
                document.getElementById('addReportBtn').textContent = i18n[currentLang].addReport;
                
                // Êõ¥Êñ∞Áî®Êà∑ËèúÂçï
                document.getElementById('profileMenuItem').textContent = i18n[currentLang].profile;
                document.getElementById('logoutMenuItem').textContent = i18n[currentLang].logout;
            }
            
            // ËÆæÁΩÆËØ≠Ë®ÄÂáΩÊï∞Êâ©Â±ï
            window.setLang = function(lang) {
                currentLang = lang;
                updateFormLanguage();
                document.getElementById('langSwitchText').textContent = currentLang === 'zh' ? 'EN' : '‰∏≠';
                // ÂÖ∂‰ªñËØ≠Ë®ÄÊõ¥Êñ∞ÈÄªËæë
            };
            
            // ÂàùÂßãÂåñË°®ÂçïËØ≠Ë®Ä
            updateFormLanguage();
            
            // ÂàùÂßãÂåñÂºπÂπïÁ≥ªÁªü
            initDanmakuSystem();
            
            // ËÆæÁΩÆÁî®Êà∑ËèúÂçï‰∫ã‰ª∂
            document.getElementById('userDisplayName').addEventListener('click', function() {
                const userMenuDropdown = document.getElementById('userMenuDropdown');
                if (userMenuDropdown.style.display === 'block') {
                    userMenuDropdown.style.display = 'none';
                } else {
                    userMenuDropdown.style.display = 'block';
                }
            });
            
            // ËÆæÁΩÆÁôªÂá∫ÊåâÈíÆ‰∫ã‰ª∂
            document.getElementById('logoutMenuItem').addEventListener('click', function() {
                // Ê∏ÖÈô§ÁôªÂΩïÁä∂ÊÄÅ
                localStorage.removeItem('userLoggedIn');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('isGuestUser');
                localStorage.removeItem('guestId');
                
                // FirebaseÁôªÂá∫
                if (auth) {
                    auth.signOut().then(() => {
                        console.log('Áî®Êà∑Â∑≤ÁôªÂá∫Firebase');
                    }).catch((error) => {
                        console.error('FirebaseÁôªÂá∫ÈîôËØØ:', error);
                    });
                }
                
                // ÈáçÂÆöÂêëÂà∞ÁôªÂΩïÈ°µÈù¢ÔºåÊ∑ªÂä†ÁôªÂá∫Ê†áËÆ∞
                window.location.href = 'login.html?logout=1';
            });
            
            // ÁÇπÂáªÈ°µÈù¢ÂÖ∂‰ªñ‰ΩçÁΩÆÂÖ≥Èó≠Áî®Êà∑ËèúÂçï
            document.addEventListener('click', function(e) {
                const userMenu = document.getElementById('userMenu');
                const userMenuDropdown = document.getElementById('userMenuDropdown');
                
                if (!userMenu.contains(e.target) && userMenuDropdown.style.display === 'block') {
                    userMenuDropdown.style.display = 'none';
                }
            });
            
            // ÂàùÂßãÂåñËØ≠Ë®ÄËÆæÁΩÆ
            const savedLang = localStorage.getItem('language') || localStorage.getItem('preferredLanguage');
            if (savedLang) {
                currentLang = savedLang;
                document.getElementById('langSwitchText').textContent = currentLang === 'zh' ? 'EN' : '‰∏≠';
                updateFormLanguage();
                
                // Â¶ÇÊûúÊòØÊ∏∏ÂÆ¢Ê®°ÂºèÔºåÊ†πÊçÆÊÅ¢Â§çÁöÑËØ≠Ë®ÄÊõ¥Êñ∞Ê∏∏ÂÆ¢ÊòæÁ§∫Ê†áÁ≠æ
                if (localStorage.getItem('isGuestUser') === 'true') {
                    document.getElementById('userDisplayName').textContent = currentLang === 'zh' ? 'Ê∏∏ÂÆ¢' : 'Guest';
                }
                
                // Á°Æ‰øùÂºπÂπï‰ΩøÁî®Ê≠£Á°ÆÁöÑËØ≠Ë®Ä
                initDanmakuSystem();
                
                // Âà∑Êñ∞ÁîµËΩ¶ÊåâÈíÆÊñáÊú¨
                const refreshTramText = document.getElementById('refreshTramText');
                if (refreshTramText) {
                    refreshTramText.textContent = i18n[currentLang].refreshTramInfo;
                }
            }
        });
    </script>
</body>
</html>
