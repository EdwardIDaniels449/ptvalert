<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PtvAlertç½‘é¡µç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- æ·»åŠ Firebase SDK è„šæœ¬ -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', sans-serif;
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤ç§»åŠ¨ç«¯ç‚¹å‡»æ—¶çš„é«˜äº® */
        }
        
        body {
            position: relative;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            background-color: #1c1c1e;
            color: #fff;
        }
        
        #map {
            width: 100%;
            height: 100vh;
            z-index: 1;
        }
        
        /* å¼¹å¹•å®¹å™¨æ ·å¼ */
        .danmaku-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 180px; /* å¢åŠ å®¹å™¨é«˜åº¦ */
            overflow: hidden;
            pointer-events: none;
            z-index: 2000; /* Increased z-index to be above user menu */
            background-color: rgba(0, 0, 0, 0.15);
        }
        
        /* å¼¹å¹•é¡¹ç›®æ ·å¼ */
        .danmaku-item {
            position: absolute;
            white-space: nowrap;
            color: #333;
            font-size: 16px;
            font-weight: 500;
            padding: 6px 16px;
            border-radius: 20px;
            background-color: rgba(255, 255, 255, 0.75);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateX(100vw);
            animation: danmaku-move 15s linear forwards;
            margin-bottom: 16px; /* Increased from 8px to 16px for more spacing */
            max-height: 20px; /* æ§åˆ¶å¼¹å¹•é«˜åº¦ */
            overflow: visible; /* ç¡®ä¿æ–‡æœ¬ä¸ä¼šè¢«æˆªæ–­ */
            display: flex; /* ä½¿ç”¨å¼¹æ€§å¸ƒå±€ */
            align-items: center; /* å‚ç›´å±…ä¸­æ–‡æœ¬ */
        }
        
        /* ç§»åŠ¨ç«¯å¼¹å¹•é€‚é… */
        @media (max-width: 768px) {
            .danmaku-item {
                font-size: 14px;
                padding: 4px 12px;
            }
        }
        
        /* ä¸åŒç±»å‹çš„å¼¹å¹• */
        .danmaku-item.important {
            background-color: rgba(255, 245, 210, 0.85);
            border-left: 3px solid #f0c040;
            color: #805000;
            font-weight: bold;
        }
        
        .danmaku-item.service {
            background-color: rgba(230, 245, 255, 0.85);
            border-left: 3px solid #40a0f0;
            color: #104080;
        }
        
        .danmaku-item.safety {
            background-color: rgba(255, 230, 230, 0.85);
            border-left: 3px solid #f04050;
            color: #801020;
            font-weight: bold;
        }
        
        /* å¼¹å¹•åŠ¨ç”» */
        @keyframes danmaku-move {
            from {
                transform: translateX(100vw);
            }
            to {
                transform: translateX(-100%);
            }
        }
        
        .map-control {
            position: absolute;
            bottom: 30px;
            left: 0;
            right: 0;
            margin: 0 auto;
            width: 80%;
            max-width: 600px;
            z-index: 1000;
        }
        
        .add-report-btn {
            display: block;
            width: 100%;
            background-color: white;
            color: #333;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            text-decoration: none;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .add-report-btn:hover {
            background-color: #f8f8f8;
        }
        
        .report-form {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #1c1c1e;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
            z-index: 1001;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
        }
        
        .report-form.active, #editForm.active {
            transform: translateY(0);
        }
        
        #editForm {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #1c1c1e;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
            z-index: 1001;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
        }
        
        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .form-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
        }
        
        .form-title {
            font-size: 20px;
            font-weight: bold;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-input, .form-textarea {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #444;
            background-color: #2c2c2e;
            color: #fff;
            font-size: 16px;
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .image-preview {
            width: 100%;
            height: 200px;
            border-radius: 8px;
            background-color: #2c2c2e;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }
        
        .image-preview:after {
            content: "ç‚¹å‡»ä¸Šä¼ ç…§ç‰‡";
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .preview-img {
            max-width: 100%;
            max-height: 100%;
            display: none;
        }
        
        .image-placeholder {
            color: #777;
            font-size: 16px;
        }
        
        .submit-btn {
            width: 100%;
            background-color: #0071e3;
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .submit-btn:hover {
            background-color: #0077ed;
        }
        
        .report-card {
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            z-index: 2001 !important;
            background: rgba(28,28,30,0.98) !important;
            box-shadow: 0 4px 32px rgba(0,0,0,0.4) !important;
            display: none;
        }
        #reportCardMask {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.45);
            z-index: 2000;
            display: none;
        }
        
        .report-time {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .report-description {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 10px;
        }
        
        .report-image {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 10px;
            max-height: 200px;
            object-fit: cover;
        }
        
        .report-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .comment-btn, .edit-btn, .delete-btn {
            background: none;
            border: none;
            font-size: 14px;
            cursor: pointer;
        }
        
        .comment-btn {
            color: #0071e3;
        }
        
        .edit-btn {
            margin-left: auto;
            color: #0071e3;
        }
        
        .delete-btn {
            margin-left: 10px;
            color: #ff3b30;
        }
        
        .comment-count {
            font-size: 14px;
            color: #aaa;
        }
        
        .comments-section {
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            display: none;
        }
        
        .comment {
            background-color: #2c2c2e;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
        }
        
        .comment-input {
            display: flex;
            margin-top: 10px;
        }
        
        .comment-input input {
            flex: 1;
            padding: 8px 12px;
            border-radius: 20px;
            border: 1px solid #444;
            background-color: #2c2c2e;
            color: #fff;
        }
        
        .send-btn {
            background-color: #0071e3;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 15px;
            margin-left: 8px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .marker-icon {
            width: 40px;
            height: 40px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        .marker-emoji {
            font-size: 24px;
        }
        
        .attribution {
            position: absolute;
            bottom: 5px;
            left: 5px;
            font-size: 12px;
            color: #666;
            z-index: 998;
        }
        
        /* æ–°å¢æŠ¥å‘Šå’Œè¯„è®ºå¼¹å¹•æ ·å¼ */
        .danmaku-item.report {
            background-color: rgba(245, 255, 230, 0.85);
            border-left: 3px solid #60d040;
            color: #306010;
        }
        
        .danmaku-item.comment {
            background-color: rgba(240, 240, 255, 0.85);
            border-left: 3px solid #8080f0;
            color: #303080;
        }
        
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: none; /* æ”¹ä¸ºé»˜è®¤ä¸æ˜¾ç¤º */
            align-items: center;
            justify-content: center;
            z-index: 3000; /* æå‡z-indexï¼Œç¡®ä¿åœ¨æ‰€æœ‰å¼¹çª—ä¹‹ä¸Š */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        
        .confirm-dialog.active {
            opacity: 1;
            visibility: visible;
        }
        
        .confirm-content {
            background-color: #2c2c2e;
            border-radius: 12px;
            width: 85%;
            max-width: 320px;
            padding: 20px;
            text-align: center;
            position: relative;
            z-index: 3001; /* æå‡z-indexï¼Œç¡®ä¿å†…å®¹åœ¨é®ç½©ä¹‹ä¸Š */
        }
        
        .confirm-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .confirm-message {
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .confirm-buttons {
            display: flex;
            justify-content: space-between;
        }
        
        .confirm-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px; /* å¢å¤§å­—ä½“å¤§å° */
            min-height: 44px; /* å¢åŠ æŒ‰é’®é«˜åº¦ï¼Œæ›´æ˜“ç‚¹å‡» */
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0); /* ç§»é™¤ç§»åŠ¨ç«¯é«˜äº®æ•ˆæœ */
            touch-action: manipulation; /* ä¼˜åŒ–è§¦æ‘¸æ“ä½œ */
        }
        
        .confirm-btn:active {
            opacity: 0.7; /* æŒ‰ä¸‹æ—¶çš„è§†è§‰åé¦ˆ */
        }
        
        .confirm-cancel {
            background-color: #3a3a3c;
            color: white;
            margin-right: 10px;
        }
        
        .confirm-ok {
            background-color: #0071e3;
            color: white;
        }
        
        .scroll-emoji {
            position: absolute;
            pointer-events: none;
            font-size: 24px;
            z-index: 1000;
            opacity: 0;
            animation: moveAndFade 2s forwards;
        }
        
        @keyframes moveAndFade {
            0% {
                transform: translateY(0);
                opacity: 1;
            }
            70% {
                opacity: 0.7;
            }
            100% {
                transform: translateY(-60px);
                opacity: 0;
            }
        }
        
        /* YarraTramsæ›´æ–°æ§åˆ¶æŒ‰é’® */
        .tram-updates-control {
            position: absolute;
            top: 180px; /* æ›´æ–°ä¸ºåŒ¹é…æ–°çš„å¼¹å¹•å®¹å™¨é«˜åº¦ */
            right: 10px;
            z-index: 1000;
        }
        
        .refresh-tram-btn {
            background-color: rgba(255, 255, 255, 0.8);
            color: #333;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
        }
        
        .refresh-tram-btn span {
            margin-right: 5px;
            font-size: 16px;
        }
        
        .refresh-tram-btn:hover {
            background-color: rgba(255, 255, 255, 0.9);
        }
        
        /* æ·»åŠ ç§»åŠ¨è®¾å¤‡é€‚é…æ ·å¼ */
        @media (max-width: 768px) {
            .map-control {
                width: 90%;
                bottom: 20px;
            }
            
            .add-report-btn {
                padding: 14px;
                font-size: 18px;
            }
            
            .form-close {
                padding: 10px; /* å¢åŠ ç‚¹å‡»åŒºåŸŸ */
            }
            
            .confirm-btn {
                min-height: 50px; /* åœ¨ç§»åŠ¨ç«¯è¿›ä¸€æ­¥å¢åŠ æŒ‰é’®é«˜åº¦ */
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            /* YarraTramsæ›´æ–°æ§åˆ¶æŒ‰é’®ä¼˜åŒ– */
            .tram-updates-control {
                top: 195px; /* æ›´æ–°ä¸ºç§»åŠ¨ç«¯è§†å›¾åŒ¹é…æ–°çš„å®¹å™¨é«˜åº¦ */
                right: 5px;
            }
            
            .refresh-tram-btn {
                padding: 12px;
                min-height: 44px; /* æ›´æ˜“è§¦æ‘¸ */
            }
        }

        /* ç”¨æˆ·ä¿¡æ¯èœå•æ ·å¼ */
        .user-menu {
            position: fixed;
            top: 60px; /* Moved down to avoid overlapping with danmaku */
            right: 18px; /* Aligned with language switch button */
            z-index: 1001; /* Reduced z-index to be below danmaku (2000) */
            background: rgba(255, 255, 255, 0.8); /* Added transparency */
            color: #333;
            border-radius: 20px;
            padding: 6px 12px; /* Reduced padding to make it smaller */
            font-size: 14px; /* Reduced font size */
            font-weight: bold;
            box-shadow: 0 2px 12px rgba(0,0,0,0.18);
            border: 2px solid #0071e3;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px; /* Reduced gap */
            transition: background 0.2s,border 0.2s;
        }

        @media (max-width: 600px) {
            .user-menu {
                top: 50px; /* Adjusted for mobile */
                right: 18px;
                padding: 5px 8px; /* Further reduced padding for mobile */
                font-size: 12px; /* Smaller font for mobile */
            }
        }

        .user-menu:hover {
            background: rgba(230, 240, 250, 0.9);
        }

        .user-menu-dropdown {
            position: absolute;
            top: 35px; /* Adjusted to account for smaller button */
            right: 0;
            background: #fff;
            border-radius: 12px;
            padding: 10px 0;
            box-shadow: 0 2px 20px rgba(0,0,0,0.2);
            display: none;
            min-width: 150px;
            z-index: 3003; /* Ensure dropdown is above everything */
        }

        .user-menu-dropdown.active {
            display: block;
        }

        .user-menu-item {
            padding: 10px 15px;
            color: #333;
            font-size: 14px;
            font-weight: normal;
            cursor: pointer;
            transition: background 0.2s;
        }

        .user-menu-item:hover {
            background: #f0f0f0;
        }

        .user-menu-item.logout {
            color: #ff3b30;
            border-top: 1px solid #eee;
            margin-top: 5px;
            padding-top: 10px;
        }
    </style>
</head>
<body>
    <!-- å³ä¸Šè§’è¯­è¨€åˆ‡æ¢æŒ‰é’®ï¼Œç¡®ä¿åœ¨bodyæœ€é¡¶éƒ¨ -->
    <button id="langSwitchBtn" style="position:fixed;top:18px;right:18px;z-index:1001;background:rgba(255,255,255,0.8);color:#333;border-radius:20px;padding:6px 12px;font-size:14px;font-weight:bold;box-shadow:0 2px 12px rgba(0,0,0,0.18);border:2px solid #0071e3;cursor:pointer;display:flex;align-items:center;gap:6px;transition:background 0.2s,border 0.2s;">
      <span style="font-size:16px;">ğŸŒ</span>
      <span id="langSwitchText">EN</span>
    </button>
    <!-- åœ¨è¯­è¨€åˆ‡æ¢æŒ‰é’®ä¸‹æ–¹æ·»åŠ ç”¨æˆ·èœå• -->
    <div id="userMenu" class="user-menu">
      <span style="font-size:16px;">ğŸ‘¤</span>
      <span id="userDisplayName" style="max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">ç”¨æˆ·</span>
      <div class="user-menu-dropdown" id="userMenuDropdown">
        <div class="user-menu-item" id="profileMenuItem">ä¸ªäººèµ„æ–™</div>
        <div class="user-menu-item logout" id="logoutMenuItem">é€€å‡ºç™»å½•</div>
      </div>
    </div>
    <div id="map"></div>
    
    <!-- å¼¹å¹•å®¹å™¨ -->
    <div class="danmaku-container" id="danmakuContainer"></div>
    
    <div class="map-control">
        <a href="#" class="add-report-btn" id="addReportBtn">+ æ·»åŠ æŠ¥å‘Š</a>
        <span id="addReportTip" style="display:none;color:#ffb300;font-size:14px;margin-left:10px;">è¯·åœ¨åœ°å›¾ä¸Šç‚¹é€‰ä½ç½®</span>
    </div>
    
    <!-- YarraTramsæ›´æ–°æ§åˆ¶æŒ‰é’® -->
    <div class="tram-updates-control">
        <button id="refreshTramUpdates" class="refresh-tram-btn">
            <span>ğŸš‹</span> åˆ·æ–°ç”µè½¦ä¿¡æ¯
        </button>
    </div>
    
    <div class="report-form" id="reportForm">
        <div class="form-header">
            <h2 class="form-title">æ–°æŠ¥å‘Š</h2>
        </div>
        
        <div class="form-group">
            <label class="form-label">ç…§ç‰‡</label>
            <div class="image-preview" style="position:relative;">
                <img src="" class="preview-img" id="previewImg">
                <span class="image-placeholder" id="imagePlaceholder">ç‚¹å‡»æ·»åŠ ç…§ç‰‡</span>
                <input type="file" id="imageInput" accept="image/*" style="position:absolute;left:0;top:0;width:100%;height:100%;opacity:0;cursor:pointer;z-index:2;">
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">æè¿°</label>
            <textarea class="form-textarea" id="descriptionInput" placeholder="è¯·æè¿°æ‚¨çœ‹åˆ°çš„æƒ…å†µ..."></textarea>
        </div>
        
        <div style="display:flex;gap:10px;">
            <button class="submit-btn" id="submitReport" style="flex:1;">ç¡®å®š</button>
            <button class="submit-btn" id="reselectLocation" style="flex:1;background:#ffb300;color:#333;">é‡æ–°é€‰ç‚¹</button>
            <button class="submit-btn" id="cancelReport" style="flex:1;background:#3a3a3c;">å–æ¶ˆ</button>
        </div>
    </div>
    
    <!-- ç¡®ä¿å¼¹çª—å’Œé®ç½©å…ƒç´ åœ¨bodyå†… -->
    <div class="report-card" id="reportCard" style="display:none;">
        <button class="form-close" id="closeReportCardBtn" style="position:absolute;top:10px;right:10px;font-size:24px;background:none;border:none;color:#fff;z-index:2002;">&times;</button>
        <div class="report-time" id="reportTime"></div>
        <div class="report-description" id="reportDesc"></div>
        <img src="" class="report-image" id="reportImage" style="display: none;">
        <div class="report-actions">
            <button class="comment-btn" id="commentBtn">è¯„è®º</button>
            <span class="comment-count" id="commentCount">0 è¯„è®º</span>
            <button class="edit-btn" id="editReportBtn" style="display: none;">ç¼–è¾‘</button>
            <button class="delete-btn" id="deleteReportBtn" style="display: none;">åˆ é™¤</button>
        </div>
        <div class="comments-section" id="commentsSection">
            <div class="comment-input">
                <input type="text" placeholder="æ·»åŠ è¯„è®º..." id="commentInput">
                <button class="send-btn" id="sendComment">å‘é€</button>
            </div>
        </div>
    </div>
    <div id="reportCardMask" style="display:none;"></div>
    
    <div class="report-form" id="editForm" style="display: none;">
        <div class="form-header">
            <h2 class="form-title">ç¼–è¾‘æŠ¥å‘Š</h2>
            <button class="form-close" id="editFormClose">&times;</button>
        </div>
        
        <div class="form-group">
            <label class="form-label">ç…§ç‰‡</label>
            <div class="image-preview" id="editImagePreview">
                <img src="" class="preview-img" id="editPreviewImg">
                <span class="image-placeholder" id="editImagePlaceholder">ç‚¹å‡»æ·»åŠ ç…§ç‰‡</span>
            </div>
            <input type="file" id="editImageInput" accept="image/*" style="display: none;">
        </div>
        
        <div class="form-group">
            <label class="form-label">æè¿°</label>
            <textarea class="form-textarea" id="editDescriptionInput" placeholder="è¯·æè¿°æ‚¨çœ‹åˆ°çš„æƒ…å†µ..."></textarea>
        </div>
        
        <button class="submit-btn" id="submitEditReport">ä¿å­˜ä¿®æ”¹</button>
    </div>
    
    <div class="confirm-dialog" id="confirmDialog">
        <div class="confirm-content">
            <div class="confirm-title">ç¡®è®¤æ“ä½œ</div>
            <div class="confirm-message" id="confirmMessage">æ‚¨ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ</div>
            <div class="confirm-buttons">
                <button class="confirm-btn confirm-cancel" id="confirmCancel">å–æ¶ˆ</button>
                <button class="confirm-btn confirm-ok" id="confirmOk">ç¡®è®¤</button>
            </div>
        </div>
    </div>
    
    <div class="attribution">Map data Â© Google Maps</div>
    
    <!-- æ›¿æ¢Leafletä¸ºGoogle Maps API -->
    <!-- æ³¨æ„: ä½¿ç”¨å‰è¯·å°†YOUR_API_KEYæ›¿æ¢ä¸ºæ‚¨çš„Google Maps APIå¯†é’¥ -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCE-oMIlcnOeqplgMmL9y1qcU6A9-HBu9U&callback=initMap" async defer></script>
    <script>
        // Google Mapsç›¸å…³å˜é‡
        var map;
        var markers = [];
        // å¢¨å°”æœ¬ä¸­å¿ƒåæ ‡
        const MELBOURNE_CENTER = { lat: -37.8136, lng: 144.9631 };
        
        // Firebaseåˆå§‹åŒ–é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyA41pAi6PZ7qQ8xrLbTg65Y6pcZBYMpLmY",
            authDomain: "ptvalert-19ea4.firebaseapp.com",
            databaseURL: "https://ptvalert-19ea4-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ptvalert-19ea4",
            storageBucket: "ptvalert-19ea4.appspot.com",
            messagingSenderId: "590126951854",
            appId: "1:590126951854:web:4cbc14144b0a395dc42c3f"
        };
        
        // åˆå§‹åŒ–Firebase
        // æ£€æŸ¥æ˜¯å¦å·²åˆå§‹åŒ–ï¼Œé¿å…é‡å¤åˆå§‹åŒ–
        if (!firebase.apps.length) {
            console.log("åˆå§‹åŒ–Firebaseåº”ç”¨...");
            firebase.initializeApp(firebaseConfig);
        } else {
            console.log("Firebaseåº”ç”¨å·²åˆå§‹åŒ–");
        }
        
        const auth = firebase.auth();
        console.log("Firebase authçŠ¶æ€:", auth ? "å·²åŠ è½½" : "æœªåŠ è½½");
        const database = firebase.database();
        
        // è·å–æ•°æ®åº“å¼•ç”¨
        const reportsRef = database.ref('reports');
        
        // æ£€æŸ¥æ¸¸å®¢æ¨¡å¼cookie
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }
        
        // éªŒè¯ç”¨æˆ·ç™»å½•çŠ¶æ€
        function checkAuthState() {
            // é¦–å…ˆæ£€æŸ¥localStorage
            const isGuestUserLS = localStorage.getItem('isGuestUser') === 'true';
            const userLoggedInLS = localStorage.getItem('userLoggedIn') === 'true';
            const guestIdLS = localStorage.getItem('guestId');
            
            // ç„¶åæ£€æŸ¥cookie
            const isGuestUserCookie = getCookie('isGuestUser') === 'true';
            const userLoggedInCookie = getCookie('userLoggedIn') === 'true';
            const guestIdCookie = getCookie('guestId');
            
            // ç¡®å®šæ˜¯å¦ä¸ºæ¸¸å®¢æ¨¡å¼
            const isGuestUser = isGuestUserLS || isGuestUserCookie;
            const userLoggedIn = userLoggedInLS || userLoggedInCookie;
            const guestId = guestIdLS || guestIdCookie || 'guest_user';
            
            if (isGuestUser && userLoggedIn) {
                console.log('ä½¿ç”¨æ¸¸å®¢æ¨¡å¼...');
                console.log('æ¸¸å®¢ID:', guestId);
                
                // æ˜¾ç¤ºæ¸¸å®¢æ¨¡å¼èœå•
                const userMenu = document.getElementById('userMenu');
                const userDisplayName = document.getElementById('userDisplayName');
                userDisplayName.textContent = currentLang === 'zh' ? 'æ¸¸å®¢' : 'Guest';
                userMenu.style.display = 'flex';
                
                return; // æ¸¸å®¢æ¨¡å¼ç™»å½•æˆåŠŸï¼Œä¸éœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥
            }
            
            // å¦‚æœä¸æ˜¯æ¸¸å®¢æ¨¡å¼ï¼Œæ£€æŸ¥Firebaseè®¤è¯
            auth.onAuthStateChanged(function(user) {
                if (user) {
                    // ç”¨æˆ·å·²é€šè¿‡Firebaseç™»å½•
                    console.log('ç”¨æˆ·å·²ç™»å½•Firebase:', user.uid, user.isAnonymous ? '(åŒ¿åç”¨æˆ·)' : '');
                    updateUserMenu(user);
                } else if (userLoggedIn) {
                    // ç”¨æˆ·é€šè¿‡localStorageç™»å½•ä½†Firebaseä¸è¯†åˆ«ï¼Œç»§ç»­ä»¥localStorageç”¨æˆ·èº«ä»½ä½¿ç”¨
                    console.log('ç”¨æˆ·å·²é€šè¿‡localStorageç™»å½•');
                    const userMenu = document.getElementById('userMenu');
                    const userDisplayName = document.getElementById('userDisplayName');
                    const userEmail = localStorage.getItem('userEmail') || (currentLang === 'zh' ? 'ç”¨æˆ·' : 'User');
                    userDisplayName.textContent = userEmail.split('@')[0];
                    userMenu.style.display = 'flex';
                } else {
                    // æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ
                    console.log('ç”¨æˆ·æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ...');
                    window.location.href = 'login.html';
                }
            }, function(error) {
                console.error('Firebase AuthçŠ¶æ€æ£€æŸ¥é”™è¯¯:', error);
                // Firebaseè®¤è¯å‡ºé”™æ—¶ï¼Œæ£€æŸ¥localStorageç™»å½•çŠ¶æ€
                if (isGuestUser || userLoggedIn) {
                    console.log('Firebaseè®¤è¯å‡ºé”™ï¼Œä½†ç”¨æˆ·å·²é€šè¿‡localStorageæˆ–cookieç™»å½•');
                    const userMenu = document.getElementById('userMenu');
                    const userDisplayName = document.getElementById('userDisplayName');
                    if (isGuestUser) {
                        userDisplayName.textContent = currentLang === 'zh' ? 'æ¸¸å®¢' : 'Guest';
                    } else {
                        const userEmail = localStorage.getItem('userEmail') || (currentLang === 'zh' ? 'ç”¨æˆ·' : 'User');
                        userDisplayName.textContent = userEmail.split('@')[0];
                    }
                    userMenu.style.display = 'flex';
                } else {
                    // æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ
                    console.log('ç”¨æˆ·æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ...');
                    window.location.href = 'login.html';
                }
            });
        }
        
        // æ›´æ–°ç”¨æˆ·èœå•æ˜¾ç¤º
        function updateUserMenu(user) {
            const userMenu = document.getElementById('userMenu');
            const userDisplayName = document.getElementById('userDisplayName');
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯æœ¬åœ°æ¸¸å®¢æ¨¡å¼
            if (!user && localStorage.getItem('isGuestUser') === 'true') {
                userDisplayName.textContent = currentLang === 'zh' ? 'æ¸¸å®¢' : 'Guest';
                userMenu.style.display = 'flex';
                return;
            }
            
            if (user) {
                // ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·åï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é‚®ç®±
                const displayName = user.displayName || user.email || (currentLang === 'zh' ? 'ç”¨æˆ·' : 'User');
                userDisplayName.textContent = displayName.split('@')[0]; // åªæ˜¾ç¤º@å‰é¢çš„éƒ¨åˆ†
                userMenu.style.display = 'flex';
            } else {
                userMenu.style.display = 'none';
            }
        }
        
        // æ³¨é”€ç™»å½•
        function logout() {
            // æ¸…é™¤æœ¬åœ°å­˜å‚¨
            localStorage.removeItem('userLoggedIn');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('isGuestUser');
            localStorage.removeItem('guestId');
            
            // æ¸…é™¤cookies
            document.cookie = "isGuestUser=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT";
            document.cookie = "userLoggedIn=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT";
            document.cookie = "guestId=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT";
            
            // å¦‚æœæ˜¯é€šè¿‡Firebaseç™»å½•çš„ï¼Œä¹Ÿæ‰§è¡ŒFirebaseç™»å‡º
            if (auth && auth.currentUser) {
                auth.signOut().then(() => {
                    console.log('Firebaseç”¨æˆ·å·²æ³¨é”€');
                    // é‡å®šå‘åˆ°ç™»å½•é¡µ
                    window.location.href = 'login.html';
                }).catch((error) => {
                    console.error('Firebaseæ³¨é”€å¤±è´¥:', error);
                    // å³ä½¿å¤±è´¥ä¹Ÿé‡å®šå‘åˆ°ç™»å½•é¡µ
                    window.location.href = 'login.html';
                });
            } else {
                // å¦‚æœåªæ˜¯æœ¬åœ°æ¸¸å®¢æ¨¡å¼ï¼Œç›´æ¥é‡å®šå‘
                console.log('æœ¬åœ°æ¸¸å®¢æ¨¡å¼å·²æ³¨é”€');
                window.location.href = 'login.html';
            }
        }
        
        // ç”¨æˆ·èœå•äº¤äº’
        document.addEventListener('DOMContentLoaded', function() {
            const userMenu = document.getElementById('userMenu');
            const userMenuDropdown = document.getElementById('userMenuDropdown');
            const logoutMenuItem = document.getElementById('logoutMenuItem');
            const profileMenuItem = document.getElementById('profileMenuItem');
            
            // åˆ‡æ¢èœå•æ˜¾ç¤º/éšè—
            userMenu.addEventListener('click', function(e) {
                e.stopPropagation();
                userMenuDropdown.classList.toggle('active');
            });
            
            // ç‚¹å‡»æ–‡æ¡£å…¶ä»–ä½ç½®å…³é—­èœå•
            document.addEventListener('click', function() {
                userMenuDropdown.classList.remove('active');
            });
            
            // é€€å‡ºç™»å½•
            logoutMenuItem.addEventListener('click', function() {
                logout();
            });
            
            // æ›´æ–°ç”¨æˆ·èœå•ä¸­çš„æ–‡æœ¬
            function updateUserMenuLanguage() {
                logoutMenuItem.textContent = currentLang === 'zh' ? 'é€€å‡ºç™»å½•' : 'Log Out';
                profileMenuItem.textContent = currentLang === 'zh' ? 'ä¸ªäººèµ„æ–™' : 'Profile';
                
                // å¦‚æœæ˜¯æ¸¸å®¢æ¨¡å¼ï¼Œæ›´æ–°æ˜¾ç¤ºæ–‡æœ¬
                if (localStorage.getItem('isGuestUser') === 'true') {
                    document.getElementById('userDisplayName').textContent = currentLang === 'zh' ? 'æ¸¸å®¢' : 'Guest';
                }
            }
            
            // æŠŠè¯­è¨€æ›´æ–°å‡½æ•°ç»‘å®šåˆ°setLangä¸­
            const originalSetLang = setLang;
            setLang = function(lang) {
                originalSetLang(lang);
                updateUserMenuLanguage();
            };
            
            // åˆå§‹åŒ–ç”¨æˆ·èœå•è¯­è¨€
            updateUserMenuLanguage();
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            checkAuthState();
        });
        
        // å¢¨å°”æœ¬ä¸»è¦ç”µè½¦ç«™ç‚¹æ•°æ®
        const tramStops = [
            { name: "Flinders Street Station", lat: -37.8183, lng: 144.9671, type: "tram" },
            { name: "Melbourne Central", lat: -37.8100, lng: 144.9633, type: "tram" },
            { name: "Parliament Station", lat: -37.8113, lng: 144.9730, type: "tram" },
            { name: "Bourke Street Mall", lat: -37.8136, lng: 144.9659, type: "tram" },
            { name: "Queen Victoria Market", lat: -37.8076, lng: 144.9566, type: "tram" },
            { name: "St Kilda Beach", lat: -37.8684, lng: 144.9733, type: "tram" },
            { name: "Toorak", lat: -37.8406, lng: 145.0174, type: "tram" },
            { name: "Brunswick St", lat: -37.7965, lng: 144.9783, type: "tram" },
            { name: "South Melbourne Beach", lat: -37.8505, lng: 144.9499, type: "tram" },
            { name: "Docklands", lat: -37.8159, lng: 144.9459, type: "tram" }
        ];
        
        // å¢¨å°”æœ¬ä¸»è¦ç«è½¦ç«™ç‚¹æ•°æ®
        const trainStations = [
            { name: "Flinders Street Station", lat: -37.8183, lng: 144.9671, type: "train" },
            { name: "Southern Cross Station", lat: -37.8183, lng: 144.9522, type: "train" },
            { name: "Melbourne Central", lat: -37.8100, lng: 144.9633, type: "train" },
            { name: "Parliament Station", lat: -37.8113, lng: 144.9730, type: "train" },
            { name: "Flagstaff Station", lat: -37.8127, lng: 144.9562, type: "train" },
            { name: "Richmond Station", lat: -37.8239, lng: 144.9975, type: "train" },
            { name: "South Yarra Station", lat: -37.8387, lng: 144.9926, type: "train" },
            { name: "Footscray Station", lat: -37.8012, lng: 144.9037, type: "train" },
            { name: "North Melbourne Station", lat: -37.8062, lng: 144.9416, type: "train" },
            { name: "Jolimont Station", lat: -37.8162, lng: 144.9802, type: "train" }
        ];
        
        // æ–°å¢ï¼šæ·»åŠ æŠ¥å‘Šæµç¨‹çŠ¶æ€
        let isSelectingLocation = false;
        let tempMarker = null; // åªä¿ç•™ä¸€ä¸ªä¸´æ—¶æ ‡è®°
        
        // æ–°å¢: é¼ æ ‡ç§»åŠ¨è¡¨æƒ…ç›¸å…³å˜é‡
        let mouseMoveEmojiTimer;
        let activeMouseMoveEmojis = [];
        
        // åˆå§‹åŒ–Googleåœ°å›¾
        function initMap() {
            // åˆ›å»ºåœ°å›¾
            map = new google.maps.Map(document.getElementById("map"), {
                center: MELBOURNE_CENTER,
                zoom: 13,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                styles: [
                    {
                        "elementType": "geometry",
                        "stylers": [{"color": "#212121"}]
                    },
                    {
                        "elementType": "labels.icon",
                        "stylers": [{"visibility": "off"}]
                    },
                    {
                        "elementType": "labels.text.fill",
                        "stylers": [{"color": "#757575"}]
                    },
                    {
                        "elementType": "labels.text.stroke",
                        "stylers": [{"color": "#212121"}]
                    },
                    {
                        "featureType": "administrative",
                        "elementType": "geometry",
                        "stylers": [{"color": "#757575"}]
                    },
                    {
                        "featureType": "administrative.country",
                        "elementType": "labels.text.fill",
                        "stylers": [{"color": "#9e9e9e"}]
                    },
                    {
                        "featureType": "administrative.land_parcel",
                        "stylers": [{"visibility": "off"}]
                    },
                    {
                        "featureType": "administrative.locality",
                        "elementType": "labels.text.fill",
                        "stylers": [{"color": "#bdbdbd"}]
                    },
                    {
                        "featureType": "poi",
                        "elementType": "labels.text.fill",
                        "stylers": [{"color": "#757575"}]
                    },
                    {
                        "featureType": "poi.park",
                        "elementType": "geometry",
                        "stylers": [{"color": "#181818"}]
                    },
                    {
                        "featureType": "poi.park",
                        "elementType": "labels.text.fill",
                        "stylers": [{"color": "#616161"}]
                    },
                    {
                        "featureType": "poi.park",
                        "elementType": "labels.text.stroke",
                        "stylers": [{"color": "#1b1b1b"}]
                    },
                    {
                        "featureType": "road",
                        "elementType": "geometry.fill",
                        "stylers": [{"color": "#2c2c2c"}]
                    },
                    {
                        "featureType": "road",
                        "elementType": "labels.text.fill",
                        "stylers": [{"color": "#8a8a8a"}]
                    },
                    {
                        "featureType": "road.arterial",
                        "elementType": "geometry",
                        "stylers": [{"color": "#373737"}]
                    },
                    {
                        "featureType": "road.highway",
                        "elementType": "geometry",
                        "stylers": [{"color": "#3c3c3c"}]
                    },
                    {
                        "featureType": "road.highway.controlled_access",
                        "elementType": "geometry",
                        "stylers": [{"color": "#4e4e4e"}]
                    },
                    {
                        "featureType": "road.local",
                        "elementType": "labels.text.fill",
                        "stylers": [{"color": "#616161"}]
                    },
                    {
                        "featureType": "transit",
                        "elementType": "labels.text.fill",
                        "stylers": [{"color": "#757575"}]
                    },
                    {
                        "featureType": "water",
                        "elementType": "geometry",
                        "stylers": [{"color": "#000000"}]
                    },
                    {
                        "featureType": "water",
                        "elementType": "labels.text.fill",
                        "stylers": [{"color": "#3d3d3d"}]
                    }
                ]
            });
            
            // æ·»åŠ ç”µè½¦ç«™æ ‡è®°
            tramStops.forEach(stop => {
                addStationMarker(stop);
            });
            
            // æ·»åŠ ç«è½¦ç«™æ ‡è®°
            trainStations.forEach(station => {
                addStationMarker(station);
            });
            
            // æ·»åŠ åœ°å›¾ç‚¹å‡»äº‹ä»¶
            map.addListener("click", (event) => {
                handleMapClick(event.latLng);
                document.body.style.cursor = '';
            });
            // å…³é”®ï¼šåœ°å›¾åˆå§‹åŒ–åå†åŠ è½½æŠ¥å‘Šæ•°æ®
            loadReportsFromFirebase();
        }
        
        // æ·»åŠ ç«™ç‚¹æ ‡è®°
        function addStationMarker(station) {
            const icon = {
                url: station.type === 'tram' 
                    ? 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="#40c0ff" d="M19,16.94V8.5C19,5.71 16.39,5 12,5C7.61,5 5,5.71 5,8.5V16.94C5,18.39 6.13,19.6 7.58,19.91L6,21.5V22H8.23L10.23,20H14L16,22H18V21.5L16.42,19.91C17.87,19.6 19,18.39 19,16.94M12,18.5A1.5,1.5 0 0,1 10.5,17A1.5,1.5 0 0,1 12,15.5A1.5,1.5 0 0,1 13.5,17A1.5,1.5 0 0,1 12,18.5M17,14H7V9H17V14Z" /></svg>')
                    : 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="#ff8040" d="M12,2C7.58,2 4,2.5 4,6V15.5A3.5,3.5 0 0,0 7.5,19L6,20.5V21H8.23L10.23,19H14L16,21H18V20.5L16.5,19A3.5,3.5 0 0,0 20,15.5V6C20,2.5 16.42,2 12,2M7.5,17A1.5,1.5 0 0,1 6,15.5A1.5,1.5 0 0,1 7.5,14A1.5,1.5 0 0,1 9,15.5A1.5,1.5 0 0,1 7.5,17M11,10H6V6H11V10M16.5,17A1.5,1.5 0 0,1 15,15.5A1.5,1.5 0 0,1 16.5,14A1.5,1.5 0 0,1 18,15.5A1.5,1.5 0 0,1 16.5,17M18,10H13V6H18V10Z" /></svg>'),
                scaledSize: new google.maps.Size(32, 32),
                anchor: new google.maps.Point(16, 16),
            };
            
            const marker = new google.maps.Marker({
                position: { lat: station.lat, lng: station.lng },
                map: map,
                title: station.name,
                icon: icon,
                zIndex: 10
            });
            
            // ä¿¡æ¯çª—å£
            const infoWindow = new google.maps.InfoWindow({
                content: `<div style="color:#000;font-weight:bold;">${station.name}</div><div style="color:#555;">${station.type === 'tram' ? 'ç”µè½¦ç«™' : 'ç«è½¦ç«™'}</div>`
            });
            
            marker.addListener("click", () => {
                infoWindow.open(map, marker);
            });
            
            markers.push(marker);
        }
        
        // å¤„ç†åœ°å›¾ç‚¹å‡»äº‹ä»¶
        function handleMapClick(latLng) {
            if (!isSelectingLocation) {
                if (document.getElementById('reportCard').style.display === 'block') {
                    document.getElementById('reportCard').style.display = 'none';
                }
                return;
            }
            // æ¸…é™¤ä¸Šä¸€ä¸ªä¸´æ—¶æ ‡è®°
            if (tempMarker) {
                tempMarker.setMap(null);
                tempMarker = null;
            }
            selectedLocation = {
                lat: latLng.lat(),
                lng: latLng.lng()
            };
            document.getElementById('addReportTip').style.display = 'none';
            document.getElementById('addReportBtn').textContent = '+ æ·»åŠ æŠ¥å‘Š';
            document.getElementById('addReportBtn').classList.remove('disabled');
            isSelectingLocation = false;
            // æ·»åŠ ä¸´æ—¶æ ‡è®°
            tempMarker = new google.maps.Marker({
                position: { lat: selectedLocation.lat, lng: selectedLocation.lng },
                map: map,
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="white" opacity="0.8"/><text x="12" y="16" font-size="12" text-anchor="middle" fill="black">ğŸ¶</text></svg>'),
                    scaledSize: new google.maps.Size(40, 40),
                    anchor: new google.maps.Point(20, 20),
                },
                animation: google.maps.Animation.DROP
            });
            // æ¢å¤é¼ æ ‡
            document.body.style.cursor = '';
            // å¼¹å‡ºè¡¨å•
            document.getElementById('reportForm').classList.add('active');
        }
        
        // å­˜å‚¨æ‰€æœ‰æŠ¥å‘Šçš„æ•°ç»„
        // This array is now synchronized with Firebase Realtime Database.
        // Reports added by any user will be visible to all other users in real-time.
        let reports = [];
        let nextReportId = 1;
        
        // ä»FirebaseåŠ è½½æŠ¥å‘Šæ•°æ®
        function loadReportsFromFirebase() {
            reportsRef.on('value', (snapshot) => {
                reports = [];
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const report = childSnapshot.val();
                        // è½¬æ¢æ—¶é—´å­—ç¬¦ä¸²ä¸ºDateå¯¹è±¡
                        report.time = new Date(report.time);
                        reports.push(report);
                    });
                }
                
                // æ›´æ–°ä¸‹ä¸€ä¸ªæŠ¥å‘ŠID
                nextReportId = reports.length > 0 ? Math.max(0, ...reports.map(r => r.id)) + 1 : 1;
                
                // åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºæ ‡è®°
                displayReports();
                
                console.log("Reports loaded from Firebase:", reports.length);
            });
            
            // ç›‘å¬æ–°å¢çš„æŠ¥å‘Š
            reportsRef.on('child_added', (snapshot) => {
                console.log("New report added to Firebase");
            });
            
            // ç›‘å¬åˆ é™¤çš„æŠ¥å‘Š
            reportsRef.on('child_removed', (snapshot) => {
                console.log("Report removed from Firebase");
            });
        }
        
        // å½“å‰ç”¨æˆ·ID - åœ¨å®é™…åº”ç”¨ä¸­åº”é€šè¿‡ç™»å½•ç³»ç»Ÿè·å–
        // For this example, we'll generate a random user ID that persists in localStorage
        const currentUserId = localStorage.getItem('mapUserId') || 
                             'user_' + Math.random().toString(36).substr(2, 9);
        // ä¿å­˜ç”¨æˆ·IDåˆ°localStorage
        localStorage.setItem('mapUserId', currentUserId);
        
        // å½“å‰é€‰ä¸­çš„æŠ¥å‘ŠID
        let currentReportId = null;
        
        // å½“å‰é€‰ä¸­çš„åæ ‡
        let selectedLocation = null;
        
        // äº¤é€šå’Œè­¦å¯Ÿè¡¨æƒ…æ•°ç»„
        const scrollEmojis = [
            'ğŸš—', 'ğŸš•', 'ğŸš™', 'ğŸšŒ', 'ğŸš', 'ğŸï¸', 'ğŸš“', 'ğŸš‘', 'ğŸš’', 'ğŸš', 'ğŸ›»', 'ğŸšš',
            'ğŸš›', 'ğŸšœ', 'ğŸ›µ', 'ğŸï¸', 'ğŸ›º', 'ğŸš²', 'ğŸš„', 'ğŸš…', 'ğŸš', 'ğŸš', 'ğŸš‹', 'ğŸš‰',
            'ğŸ‘®â€â™€ï¸', 'ğŸ‘®â€â™‚ï¸', 'ğŸš”', 'ğŸš¨', 'ğŸš¥', 'ğŸš¦', 'ğŸ›¤ï¸', 'ğŸš', 'ğŸš‡', 'ğŸšŠ', 'âœˆï¸', 'ğŸš€'
        ];
        
        // æ˜¾ç¤ºæ‰€æœ‰æŠ¥å‘Šæ ‡è®°
        // This function displays markers based on the 'reports' array currently loaded in memory.
        // Now synchronized with Firebase Realtime Database for multi-user experience.
        function displayReports() {
            console.log('displayReports called, reports:', reports, 'map:', map);
            // æ¸…é™¤ç°æœ‰æ ‡è®°
            markers.forEach(marker => {
                marker.setMap(null);
            });
            markers = [];
            const now = new Date();
            reports.forEach(report => {
                const reportCreationTime = new Date(report.time);
                const reportAgeHours = (now - reportCreationTime) / (1000 * 60 * 60);
                if (reportAgeHours > 3) {
                    console.log(`Initial display: Report ID ${report.id} is older than 3 hours (${reportAgeHours.toFixed(2)} hrs), not displaying marker.`);
                    return; // Skip this report, it's too old
                }
                // ç”¨å…¼å®¹æ€§æ›´å¥½çš„emoji SVGè‡ªå®šä¹‰icon
                const markerIcon = {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
                        `<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40">
                            <circle cx="20" cy="20" r="18" fill="white" opacity="0.9"/>
                            <text x="20" y="28" font-size="24" text-anchor="middle" fill="black">${report.emoji}</text>
                        </svg>`
                    ),
                    scaledSize: new google.maps.Size(40, 40),
                    anchor: new google.maps.Point(20, 20)
                };
                const marker = new google.maps.Marker({
                    position: { lat: report.lat, lng: report.lng },
                    map: map,
                    icon: markerIcon,
                    clickable: true,
                    zIndex: 9999
                });
                marker.reportId = report.id;
                marker.addListener("click", function() {
                    console.log('marker clicked', this.reportId);
                    showReportCard(this.reportId);
                });
                markers.push(marker);
            });
        }
        
        // æ·»åŠ æ–°æŠ¥å‘Š
        // This function now saves the report to Firebase, making it visible to all users
        function addNewReport(description, image, lat, lng) {
            const newReport = {
                id: nextReportId++,
                lat: lat,
                lng: lng,
                description: description,
                time: new Date().toISOString(), // Store as ISO string for Firebase
                image: image,
                emoji: "ğŸ¶",
                comments: [],
                userId: currentUserId
            };
            
            // æ ¹æ®æè¿°é€‰æ‹©è¡¨æƒ…
            if (description && (description.toLowerCase().includes('dog') || description.toLowerCase().includes('ç‹—'))) {
                newReport.emoji = "ğŸ¶";
            } else if (description && (description.toLowerCase().includes('traffic') || description.toLowerCase().includes('äº¤é€š'))) {
                newReport.emoji = "ğŸš—";
            } else if (description && (description.toLowerCase().includes('food') || description.toLowerCase().includes('é¤'))) {
                newReport.emoji = "ğŸ”";
            } else if (description && (description.toLowerCase().includes('event') || description.toLowerCase().includes('æ´»åŠ¨'))) {
                newReport.emoji = "ğŸª";
            }
            
            // ä¿å­˜åˆ°Firebase (ä½¿ç”¨IDä½œä¸ºé”®)
            console.log('å³å°†å†™å…¥Firebaseçš„æ–°æŠ¥å‘Š:', newReport);
            reportsRef.child(newReport.id.toString()).set(newReport)
                .then(() => {
                    console.log("Report successfully saved to Firebase", newReport);
                    closeReportFormAndReset();
                    // åœ°å›¾æ ‡è®°ä¼šè‡ªåŠ¨åˆ·æ–°ï¼Œä¸”å¯ç‚¹å‡»ï¼ˆdisplayReportsé€»è¾‘å·²ä¿è¯ï¼‰
                    // ä¸å†è°ƒç”¨showReportCardï¼Œç›´æ¥å›åˆ°åˆå§‹é¡µé¢
                })
                .catch((error) => {
                    console.error("Error saving report to Firebase:", error);
                });
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('descriptionInput').value = '';
            document.getElementById('previewImg').style.display = 'none';
            document.getElementById('imagePlaceholder').style.display = 'block';
            document.getElementById('imageInput').value = '';
            loopDanmaku();
        }
        
        // æ˜¾ç¤ºæŠ¥å‘Šå¡ç‰‡
        function showReportCard(reportId) {
            console.log('showReportCard called', reportId);
            const report = reports.find(r => r.id === reportId);
            if (!report) return;
            currentReportId = reportId;
            // è·å–å¼¹çª—å’Œé®ç½©å…ƒç´ 
            const reportCard = document.getElementById('reportCard');
            const mask = document.getElementById('reportCardMask');
            const localEditBtn = document.getElementById('editReportBtn');
            const localDeleteBtn = document.getElementById('deleteReportBtn');
            const closeReportCardBtn = document.getElementById('closeReportCardBtn');
            if (!reportCard || !mask) {
                alert('å¼¹çª—å…ƒç´ æœªæ­£ç¡®æ’å…¥é¡µé¢ï¼Œè¯·æ£€æŸ¥HTMLç»“æ„æˆ–é®ç½©æ’å…¥é€»è¾‘ï¼');
                return;
            }
            const reportTime = document.getElementById('reportTime');
            const reportDesc = document.getElementById('reportDesc');
            const reportImage = document.getElementById('reportImage');
            const commentCount = document.getElementById('commentCount');
            const commentsSection = document.getElementById('commentsSection');
            if (!reportTime || !reportDesc || !reportImage || !commentCount || !commentsSection) {
                alert('å¼¹çª—å†…å®¹å…ƒç´ æœªæ­£ç¡®æ’å…¥é¡µé¢ï¼Œè¯·æ£€æŸ¥HTMLç»“æ„ï¼');
                return;
            }
            reportTime.textContent = formatTime(report.time);
            reportDesc.textContent = report.description;
            // æè¿°ç¿»è¯‘æŒ‰é’®
            let descTranslateBtn = document.getElementById('descTranslateBtn');
            if (!descTranslateBtn) {
                descTranslateBtn = document.createElement('button');
                descTranslateBtn.id = 'descTranslateBtn';
                descTranslateBtn.textContent = 'ğŸŒ';
                descTranslateBtn.style.marginLeft = '8px';
                descTranslateBtn.style.background = 'none';
                descTranslateBtn.style.border = 'none';
                descTranslateBtn.style.cursor = 'pointer';
                descTranslateBtn.style.color = '#4da3ff';
                descTranslateBtn.title = 'Translate Description';
                reportDesc.parentNode.insertBefore(descTranslateBtn, reportDesc.nextSibling);
            }
            // è®¾ç½®æŒ‰é’®titleå’Œé€»è¾‘
            const descLang = detectLang(report.description);
            const descTargetLang = descLang === 'zh' ? 'en' : 'zh';
            descTranslateBtn.title = descTargetLang === 'en' ? 'Translate to English' : 'ç¿»è¯‘ä¸ºä¸­æ–‡';
            descTranslateBtn.onclick = async function() {
                descTranslateBtn.disabled = true;
                descTranslateBtn.textContent = '...';
                const translated = await translateText(report.description, descTargetLang);
                reportDesc.textContent = translated;
                descTranslateBtn.textContent = 'ğŸŒ';
                descTranslateBtn.disabled = false;
            };
            if (report.image) {
                reportImage.src = report.image;
                reportImage.style.display = 'block';
            } else {
                reportImage.style.display = 'none';
            }
            if (!Array.isArray(report.comments)) {
                report.comments = [];
            }
            // è¯„è®ºåŒºæ ‡é¢˜
            commentCount.textContent = i18n[currentLang].comment + i18n[currentLang].commentCount(report.comments.length).replace(/\D*\d+\D*/, match => match.replace(/\D/g, ''));
            commentsSection.style.display = 'none';
            // æ¸…é™¤ç°æœ‰è¯„è®º
            const existingComments = commentsSection.querySelectorAll('.comment');
            existingComments.forEach(comment => comment.remove());
            // æ·»åŠ è¯„è®ºåˆ°è¯„è®ºåŒº
            report.comments.forEach((comment, idx) => {
                const commentElement = document.createElement('div');
                commentElement.className = 'comment';
                commentElement.textContent = comment;
                // æ‰€æœ‰è¯„è®ºéƒ½åŠ ç¿»è¯‘æŒ‰é’®
                const commentLang = detectLang(comment);
                const targetLang = commentLang === 'zh' ? 'en' : 'zh';
                const translateBtn = document.createElement('button');
                translateBtn.textContent = 'ğŸŒ';
                translateBtn.title = targetLang === 'en' ? 'Translate to English' : 'ç¿»è¯‘ä¸ºä¸­æ–‡';
                translateBtn.style.marginLeft = '8px';
                translateBtn.style.background = 'none';
                translateBtn.style.border = 'none';
                translateBtn.style.cursor = 'pointer';
                translateBtn.style.color = '#4da3ff';
                translateBtn.style.float = 'right';
                translateBtn.onclick = async function() {
                    translateBtn.disabled = true;
                    translateBtn.textContent = '...';
                    const translated = await translateText(comment, targetLang);
                    commentElement.textContent = translated;
                    translateBtn.textContent = 'ğŸŒ';
                    translateBtn.disabled = false;
                };
                commentElement.appendChild(translateBtn);
                commentsSection.insertBefore(commentElement, document.getElementById('commentInput').parentNode);
            });
            // æ£€æŸ¥æ˜¯å¦ä¸ºå½“å‰ç”¨æˆ·çš„æŠ¥å‘Šï¼Œå¦‚æœæ˜¯åˆ™æ˜¾ç¤ºç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®
            if (localEditBtn && localDeleteBtn) {
                if (report.userId === currentUserId) {
                    localEditBtn.style.display = 'block';
                    localDeleteBtn.style.display = 'block';
                } else {
                    localEditBtn.style.display = 'none';
                    localDeleteBtn.style.display = 'none';
                }
            }
            // æ˜¾ç¤ºé®ç½©å’Œå¼¹çª—
            mask.style.display = 'block';
            reportCard.style.display = 'block';
            // é‡æ–°ç»‘å®šå…³é—­æŒ‰é’®äº‹ä»¶
            if (closeReportCardBtn) {
                closeReportCardBtn.onclick = function() {
                    reportCard.style.display = 'none';
                    mask.style.display = 'none';
                };
            }
            // é‡æ–°ç»‘å®šç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®äº‹ä»¶
            if (localEditBtn) {
                localEditBtn.onclick = function() {
                    const report = reports.find(r => r.id === currentReportId);
                    if (!report) return;
                    if (report.userId !== currentUserId) {
                        showConfirmDialog('æ‚¨åªèƒ½ç¼–è¾‘è‡ªå·±å‘å¸ƒçš„æŠ¥å‘Š', null);
                        return;
                    }
                    document.getElementById('editDescriptionInput').value = report.description;
                    const editPreviewImg = document.getElementById('editPreviewImg');
                    const editImagePlaceholder = document.getElementById('editImagePlaceholder');
                    if (report.image) {
                        editPreviewImg.src = report.image;
                        editPreviewImg.style.display = 'block';
                        editImagePlaceholder.style.display = 'none';
                    } else {
                        editPreviewImg.style.display = 'none';
                        editImagePlaceholder.style.display = 'block';
                    }
                    document.getElementById('editForm').classList.add('active');
                };
            }
            if (localDeleteBtn) {
                localDeleteBtn.onclick = function() {
                    showConfirmDialog('æ‚¨ç¡®å®šè¦åˆ é™¤è¿™æ¡æŠ¥å‘Šå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚', function(confirmed) {
                        if (confirmed) {
                            deleteReport(currentReportId);
                        }
                    });
                };
            }
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(date) {
            const now = new Date();
            const diff = Math.floor((now - date) / 1000); // ç§’å·®
            
            if (diff < 60) {
                return "åˆšåˆš";
            } else if (diff < 3600) {
                const minutes = Math.floor(diff / 60);
                return `${minutes} åˆ†é’Ÿå‰`;
            } else if (diff < 86400) {
                const hours = Math.floor(diff / 3600);
                return `${hours} å°æ—¶å‰`;
            } else {
                const days = Math.floor(diff / 86400);
                return `${days} å¤©å‰`;
            }
        }
        
        // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
        let currentConfirmCallback = null;
        
        function handleConfirmOk() {
            console.log("ç¡®è®¤æŒ‰é’®è¢«ç‚¹å‡»");
            closeConfirmDialog();
            if (typeof currentConfirmCallback === 'function') {
                currentConfirmCallback(true);
            }
        }
        
        function handleConfirmCancel() {
            console.log("å–æ¶ˆæŒ‰é’®è¢«ç‚¹å‡»");
            closeConfirmDialog();
            if (typeof currentConfirmCallback === 'function') {
                currentConfirmCallback(false);
            }
        }
        
        function showConfirmDialog(message, callback) {
            const confirmDialog = document.getElementById('confirmDialog');
            currentConfirmCallback = callback;
            // è‹¥ä¼ å…¥çš„æ˜¯é€šç”¨ç¡®è®¤å†…å®¹ï¼Œè‡ªåŠ¨ç”¨i18n
            if (message === 'æ‚¨ç¡®å®šè¦æäº¤è¿™ä¸ªæŠ¥å‘Šå—ï¼Ÿ' || message === 'Are you sure you want to submit this report?' || /æäº¤/.test(message) || /submit/i.test(message)) {
                message = i18n[currentLang].confirmMsg;
            }
            if (message === 'æ‚¨ç¡®å®šè¦åˆ é™¤è¿™æ¡æŠ¥å‘Šå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚' || message === 'Are you sure you want to delete this report? This action cannot be undone.' || /åˆ é™¤/.test(message) || /delete/i.test(message)) {
                message = i18n[currentLang].confirmDelete;
            }
            if (message === 'æ‚¨ç¡®å®šè¦ä¿å­˜è¿™äº›ä¿®æ”¹å—ï¼Ÿ' || message === 'Are you sure you want to save these changes?' || /ä¿å­˜/.test(message) || /save/i.test(message)) {
                message = i18n[currentLang].confirmEdit;
            }
            if (message === 'ç¡®å®šå‘é€æ­¤è¯„è®ºï¼Ÿ' || message === 'Send this comment?' || /è¯„è®º/.test(message) || /comment/i.test(message)) {
                message = i18n[currentLang].confirmSendComment;
            }
            document.getElementById('confirmMessage').textContent = message;
            document.querySelector('.confirm-title').textContent = i18n[currentLang].confirmTitle;
            document.getElementById('confirmCancel').textContent = i18n[currentLang].cancel;
            document.getElementById('confirmOk').textContent = i18n[currentLang].confirm;
            // å¼ºåˆ¶æ˜¾ç¤ºå¼¹çª—
            confirmDialog.style.display = 'flex';
            confirmDialog.style.visibility = 'visible';
            confirmDialog.style.opacity = '1';
            confirmDialog.classList.add('active');
            // å…ˆè§£ç»‘å†ç»‘å®šï¼Œç¡®ä¿æ¯æ¬¡éƒ½æœ‰æ•ˆ
            const okBtn = document.getElementById('confirmOk');
            const cancelBtn = document.getElementById('confirmCancel');
            okBtn.onclick = function() {
                closeConfirmDialog();
                if (typeof currentConfirmCallback === 'function') {
                    currentConfirmCallback(true);
                }
            };
            cancelBtn.onclick = function() {
                closeConfirmDialog();
                if (typeof currentConfirmCallback === 'function') {
                    currentConfirmCallback(false);
                }
            };
        }
        
        // å…³é—­ç¡®è®¤å¯¹è¯æ¡†
        function closeConfirmDialog() {
            const confirmDialog = document.getElementById('confirmDialog');
            confirmDialog.classList.remove('active');
            setTimeout(() => {
                confirmDialog.style.display = 'none';
                currentConfirmCallback = null;
            }, 300);
        }
        
        // æ–°å¢: åˆ›å»ºéšé¼ æ ‡ç§»åŠ¨çš„è¡¨æƒ…
        function createDynamicEmoji(x, y) {
            const emojiEl = document.createElement('div');
            emojiEl.style.position = 'fixed'; // Use fixed to position relative to viewport
            emojiEl.style.left = `${x - 12}px`; // Center the emoji roughly on cursor
            emojiEl.style.top = `${y - 12}px`;  // Center the emoji roughly on cursor
            emojiEl.style.pointerEvents = 'none';
            emojiEl.style.fontSize = '24px'; // Match scroll-emoji font size
            emojiEl.style.zIndex = '2005'; // Ensure it's above most other elements
            emojiEl.textContent = scrollEmojis[Math.floor(Math.random() * scrollEmojis.length)];
            document.body.appendChild(emojiEl);
            activeMouseMoveEmojis.push(emojiEl);
        }

        // æ–°å¢: å¤„ç†é¼ æ ‡ç§»åŠ¨äº‹ä»¶ï¼Œç”¨äºæ˜¾ç¤ºè¡¨æƒ…
        function handleMouseMove(e) {
            createDynamicEmoji(e.clientX, e.clientY);
            clearTimeout(mouseMoveEmojiTimer);
            mouseMoveEmojiTimer = setTimeout(() => {
                activeMouseMoveEmojis.forEach(em => em.remove());
                activeMouseMoveEmojis = [];
            }, 200); // Emojis disappear after 200ms of no movement
        }

        // åˆ›å»ºæ»šåŠ¨emoji
        function createScrollEmoji(x, y) {
            const emoji = document.createElement('div');
            emoji.className = 'scroll-emoji';
            emoji.textContent = scrollEmojis[Math.floor(Math.random() * scrollEmojis.length)];
            emoji.style.left = `${x}px`;
            emoji.style.top = `${y}px`;
            document.body.appendChild(emoji);
            
            // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
            setTimeout(() => {
                emoji.remove();
            }, 2000);
        }
        
        // å¼¹å¹•æ•°æ® - YarraTramsæœ€æ–°å…¬å‘Šä¸å†…å®¹
        let danmakuData = [
            "YarraTrams: 58è·¯ç”µè½¦ä»Šæ—¥å°†åœ¨West Coburgåˆ°Toorakä¹‹é—´æ­£å¸¸è¿è¡Œ",
            "å…¬å‘Š: å¢¨å°”æœ¬è‰ºæœ¯ç”µè½¦é¡¹ç›®è‡ª1978å¹´å¼€å§‹ï¼Œä¿ƒè¿›è‰ºæœ¯ä¸å…¬å…±äº¤é€šçš„èåˆ",
            "96è·¯ç”µè½¦: East Brunswickè‡³St Kilda Beachæœ‰ä¸´æ—¶è°ƒæ•´ï¼Œè¯·æŸ¥çœ‹æœ€æ–°æ—¶åˆ»è¡¨",
            "YarraTrams: åœ¨Collins Streetæ–°å¢è‰ºæœ¯å€™è½¦äº­ï¼Œè¿æ¥ä¹˜å®¢ä¸åŸä½æ°‘æ–‡åŒ–",
            "äº¤é€šæ›´æ–°: 11è·¯ç”µè½¦West Prestonè‡³Victoria Harbour Docklandsè·¯çº¿æ­£å¸¸",
            "å…è´¹ç”µè½¦åŒºæé†’: å¢¨å°”æœ¬å¸‚ä¸­å¿ƒåŒºåŸŸä¹˜åç”µè½¦æ— éœ€ä»˜è´¹",
            "YarraTrams: ä¸ºæå‡ç½‘ç»œè¦†ç›–èŒƒå›´ï¼Œéƒ¨åˆ†çº¿è·¯å°†è¿›è¡ŒåŸºç¡€è®¾æ–½å‡çº§",
            "æœåŠ¡å…¬å‘Š: 35è·¯ç¯åŸç”µè½¦æä¾›ä¾¿æ·çš„å¸‚åŒºè§‚å…‰ä½“éªŒ",
            "YarraTrams: 72è·¯ç”µè½¦Melbourne Universityè‡³Camberwellçº¿è·¯æ­£å¸¸è¿è¡Œ",
            "å®‰å…¨æç¤º: è¯·åœ¨é è¿‘ç”µè½¦è½¨é“æ—¶ä¿æŒè­¦æƒ•ï¼Œæ³¨æ„å®‰å…¨",
            "YarraTrams: è®¿é—®PTVæ—…ç¨‹è§„åˆ’å·¥å…·ï¼Œè½»æ¾è§„åˆ’æ‚¨çš„å‡ºè¡Œè·¯çº¿",
            "æœåŠ¡å…¬å‘Š: 109è·¯ç”µè½¦Box Hillè‡³Port Melbourneçº¿è·¯æŒ‰æ—¶åˆ»è¡¨è¿è¡Œ"
        ];
        
        // ä¸Šæ¬¡æ›´æ–°æ—¶é—´
        let lastUpdateTime = new Date();
        
        // è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨
        let autoRefreshTimer;
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatusDisplay() {
            const lastUpdateSpan = document.getElementById('lastUpdateTime');
            if (lastUpdateSpan) {
                const timeDiff = Math.floor((new Date() - lastUpdateTime) / 60000); // åˆ†é’Ÿå·®
                lastUpdateSpan.textContent = timeDiff < 1 ? 'åˆšåˆš' : `${timeDiff}åˆ†é’Ÿå‰`;
            }
        }
        
        // è·å–YarraTramsæœ€æ–°ä¿¡æ¯
        function fetchTramUpdates(showAlert = true) {
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥æ˜¯å‘YarraTrams APIå‘èµ·è¯·æ±‚
            // ç”±äºæˆ‘ä»¬æ— æ³•å®é™…è°ƒç”¨å¤–éƒ¨APIï¼Œè¿™é‡Œæ¨¡æ‹Ÿæ–°æ•°æ®
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const refreshBtn = document.getElementById('refreshTramUpdates');
            const originalBtnText = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<span>ğŸ”„</span> åŠ è½½ä¸­...';
            refreshBtn.disabled = true;
            
            // æ¨¡æ‹ŸAPIå»¶è¿Ÿ
            setTimeout(() => {
                // ç”Ÿæˆä¸€äº›æ–°çš„å…¬å‘Š
                const newUpdates = [
                    `YarraTrams: ${new Date().toLocaleDateString()} æœ€æ–°æœåŠ¡è°ƒæ•´å…¬å‘Š`,
                    "äº¤é€šéƒ¨é—¨å…¬å‘Š: è®¡åˆ’å‡ºè¡Œè¯·å…³æ³¨PTVæ—…ç¨‹è§„åˆ’å·¥å…·çš„æœ€æ–°ä¿¡æ¯",
                    `æœåŠ¡æ›´æ–°: ä»Šæ—¥${Math.floor(Math.random() * 10) + 1}æ¡çº¿è·¯å› ç»´æŠ¤å·¥ä½œæœ‰ä¸´æ—¶è°ƒæ•´`,
                    "YarraTrams: ä¸‹è½½ç§»åŠ¨åº”ç”¨è·å–å®æ—¶ç”µè½¦åˆ°ç«™ä¿¡æ¯",
                    "å®‰å…¨æé†’: åœ¨ç”µè½¦ç«™å°è¯·ç«™åœ¨é»„çº¿å†…ç­‰å€™",
                    `ç”µè½¦è°ƒæ•´: ${Math.floor(Math.random() * 100) + 1}è·¯ç”µè½¦æœ‰ä¸´æ—¶æœåŠ¡å˜æ›´`
                ];
                
                // æ›´æ–°å¼¹å¹•æ•°æ®
                danmakuData = [...newUpdates, ...danmakuData.slice(0, 6)];
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                refreshBtn.innerHTML = originalBtnText;
                refreshBtn.disabled = false;
                
                // æ›´æ–°æœ€ååˆ·æ–°æ—¶é—´
                lastUpdateTime = new Date();
                updateStatusDisplay();
                
                // æ˜¾ç¤ºæç¤º
                if (showAlert) {
                    alert('ç”µè½¦ä¿¡æ¯å·²æ›´æ–°');
                }
            }, 1500);
        }
        
        // åˆå§‹åŒ–å¼¹å¹•ç³»ç»Ÿ
        function initDanmaku() {
            const container = document.getElementById('danmakuContainer');
            
            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';
            
            // å¦‚æœæ²¡æœ‰å¼¹å¹•æ•°æ®ï¼Œå…ˆæ›´æ–°
            if (!danmakuData || danmakuData.length === 0) {
                updateDanmakuData();
            }
            
            // å¾ªç¯å‘é€å¼¹å¹•
            function loopDanmaku() {
                danmakuData.forEach((text, index) => {
                    setTimeout(() => {
                        createDanmaku(text);
                    }, index * 3000); // æ¯3ç§’å‘é€ä¸€æ¡
                });
                
                // å¾ªç¯é—´éš”æ—¶é—´
                setTimeout(loopDanmaku, danmakuData.length * 3000);
            }
            
            // åˆ›å»ºå•æ¡å¼¹å¹•
            function createDanmaku(text) {
                const danmaku = document.createElement('div');
                danmaku.className = 'danmaku-item';
                
                // æ ¹æ®å†…å®¹è®¾ç½®ä¸åŒçš„æ ·å¼
                if (text.includes('å®‰å…¨') || text.includes('è­¦å‘Š') || text.includes('æ³¨æ„') || 
                    text.includes('safety') || text.includes('warning') || text.includes('caution')) {
                    danmaku.classList.add('safety');
                } else if (text.includes('Bus') || text.includes('Route') || text.includes('ç”µè½¦') || 
                           text.includes('tram') || text.includes('è·¯çº¿') || text.includes('stop') || 
                           text.startsWith('Route ')) {
                    danmaku.classList.add('service');
                } else if (text.includes('YarraTrams:') || text.includes('å…¬å‘Š') || text.includes('Disruption') || 
                          text.includes('replace') || text.includes('closure')) {
                    danmaku.classList.add('important');
                } else if (text.startsWith('ğŸ“') || text.startsWith('ğŸ’¬')) {
                    // æŠ¥å‘Šå’Œè¯„è®ºçš„æ ·å¼
                    danmaku.classList.add(text.startsWith('ğŸ“') ? 'report' : 'comment');
                }
                
                danmaku.textContent = text;
                
                // æ”¹è¿›å‚ç›´ä½ç½®åˆ†é…ï¼Œåˆ›å»ºå‡ ä¸ªé€šé“ä»¥é˜²æ­¢é‡å ï¼Œè¿›ä¸€æ­¥å¢åŠ é€šé“é—´è·
                const channels = [15, 50, 85, 115, 135]; // äº”ä¸ªå‚ç›´ä½ç½®é€šé“ï¼Œæœ€åº•éƒ¨é€šé“ä¸Šç§»æ›´å¤š
                const channelIndex = Math.floor(Math.random() * channels.length);
                const top = channels[channelIndex];
                danmaku.style.top = `${top}px`;
                
                // éšæœºé€Ÿåº¦ (é€šè¿‡åŠ¨ç”»æŒç»­æ—¶é—´æ§åˆ¶)
                const speed = 12 + Math.random() * 8; // 12-20ç§’ä¹‹é—´
                danmaku.style.animationDuration = `${speed}s`;
                
                // æ·»åŠ åˆ°å®¹å™¨
                container.appendChild(danmaku);
                
                // åŠ¨ç”»ç»“æŸåç§»é™¤
                setTimeout(() => {
                    danmaku.remove();
                }, speed * 1000);
            }
            
            // å¼€å§‹å¾ªç¯å¼¹å¹•
            loopDanmaku();
        }
        
        // ç¼–è¾‘æŠ¥å‘Š
        function editReport(reportId, description, image) {
            const report = reports.find(r => r.id === reportId);
            if (!report) return;
            
            // åªèƒ½ç¼–è¾‘è‡ªå·±çš„æŠ¥å‘Š
            if (report.userId !== currentUserId) {
                showConfirmDialog('æ‚¨åªèƒ½ç¼–è¾‘è‡ªå·±å‘å¸ƒçš„æŠ¥å‘Š', null);
                return false;
            }
            
            // æ›´æ–°æŠ¥å‘Šå†…å®¹
            report.description = description;
            if (image) {
                report.image = image;
            }
            
            // æ ¹æ®æè¿°æ›´æ–°è¡¨æƒ…
            let newEmoji = report.emoji; // é»˜è®¤ä¿æŒåŸæ¥çš„è¡¨æƒ…
            if (description.toLowerCase().includes('dog') || description.toLowerCase().includes('ç‹—')) {
                newEmoji = "ğŸ¶";
            } else if (description.toLowerCase().includes('traffic') || description.toLowerCase().includes('äº¤é€š')) {
                newEmoji = "ğŸš—";
            } else if (description.toLowerCase().includes('food') || description.toLowerCase().includes('é¤')) {
                newEmoji = "ğŸ”";
            } else if (description.toLowerCase().includes('event') || description.toLowerCase().includes('æ´»åŠ¨')) {
                newEmoji = "ğŸª";
            }
            
            // æ›´æ–°æŠ¥å‘Šçš„è¡¨æƒ…
            report.emoji = newEmoji;
            
            // ä¿å­˜åˆ°Firebase
            reportsRef.child(reportId.toString()).update({
                description: description,
                image: image,
                emoji: newEmoji
            })
            .then(() => {
                console.log("Report successfully updated in Firebase");
                // é‡æ–°æ˜¾ç¤ºæŠ¥å‘Šå¡ç‰‡
                showReportCard(reportId);
            })
            .catch((error) => {
                console.error("Error updating report in Firebase:", error);
            });
            
            return true;
        }
        
        // æ·»åŠ è¯„è®º
        function addComment(reportId, comment) {
            const report = reports.find(r => r.id === reportId);
            if (!report) return;
            
            // å…ˆåœ¨æœ¬åœ°æ·»åŠ 
            if (!report.comments) {
                report.comments = [];
            }
            report.comments.push(comment);
            
            // æ›´æ–°åˆ°Firebase
            reportsRef.child(reportId.toString()).child('comments').set(report.comments)
                .then(() => {
                    console.log("Comment successfully added to Firebase");
                })
                .catch((error) => {
                    console.error("Error adding comment to Firebase:", error);
                });
            
            // æ›´æ–°è¯„è®ºåŒº
            const commentsSection = document.getElementById('commentsSection');
            const commentElement = document.createElement('div');
            commentElement.className = 'comment';
            commentElement.textContent = comment;
            commentsSection.insertBefore(commentElement, document.getElementById('commentInput').parentNode);
            
            // æ›´æ–°è¯„è®ºè®¡æ•°
            document.getElementById('commentCount').textContent = `${report.comments.length} è¯„è®º`;
        }
        
        // åˆ é™¤æŠ¥å‘Š
        function deleteReport(reportId) {
            // æ‰¾åˆ°æŠ¥å‘Šç´¢å¼•
            const reportIndex = reports.findIndex(r => r.id === reportId);
            if (reportIndex === -1) return false;
            const report = reports[reportIndex];
            // æ£€æŸ¥æ˜¯å¦ä¸ºå½“å‰ç”¨æˆ·çš„æŠ¥å‘Š
            if (report.userId !== currentUserId) {
                showConfirmDialog('æ‚¨åªèƒ½åˆ é™¤è‡ªå·±å‘å¸ƒçš„æŠ¥å‘Š', null);
                return false;
            }
            // ä»Firebaseä¸­åˆ é™¤
            reportsRef.child(reportId.toString()).remove()
                .then(() => {
                    console.log(`Report ID ${reportId} successfully deleted from Firebase`);
                    // åˆ é™¤æˆåŠŸåè‡ªåŠ¨å…³é—­å¼¹çª—å’Œé®ç½©
                    document.getElementById('reportCard').style.display = 'none';
                    document.getElementById('reportCardMask').style.display = 'none';
                })
                .catch((error) => {
                    console.error("Error deleting report from Firebase:", error);
                });
            return true;
        }
        
        // æ–°åŠŸèƒ½ï¼šæ£€æŸ¥å¹¶ç§»é™¤è¶…æ—¶çš„æ ‡è®°
        function checkMarkerExpiry() {
            const now = new Date();
            let didRemove = false;
            
            for (let i = reports.length - 1; i >= 0; i--) { // Iterate backwards for safe removal
                const report = reports[i];
                const reportCreationTime = new Date(report.time);
                const reportAgeHours = (now - reportCreationTime) / (1000 * 60 * 60);

                if (reportAgeHours > 3) {
                    console.log(`Expiry check: Report ID ${report.id} (age: ${reportAgeHours.toFixed(2)} hrs) has expired.`);
                    
                    // Remove from Firebase
                    reportsRef.child(report.id.toString()).remove()
                        .then(() => {
                            console.log(`Report ID ${report.id} removed from Firebase.`);
                        })
                        .catch((error) => {
                            console.error("Error removing report from Firebase:", error);
                        });
                    
                    didRemove = true;
                    
                    // Find and remove marker from map (now handled by Firebase listener and displayReports)
                }
            }
        }
        
        // DOM äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function() {
            const addReportBtn = document.getElementById('addReportBtn');
            const reportForm = document.getElementById('reportForm');
            const imagePreview = document.querySelector('.image-preview');
            const imageInput = document.getElementById('imageInput');
            const previewImg = document.getElementById('previewImg');
            const imagePlaceholder = document.getElementById('imagePlaceholder');
            const submitReport = document.getElementById('submitReport');
            const commentBtn = document.getElementById('commentBtn');
            const commentsSection = document.getElementById('commentsSection');
            const sendComment = document.getElementById('sendComment');
            const commentInput = document.getElementById('commentInput');
            const confirmCancel = document.getElementById('confirmCancel');
            const confirmOk = document.getElementById('confirmOk');
            const editReportBtn = document.getElementById('editReportBtn');
            const editForm = document.getElementById('editForm');
            const editFormClose = document.getElementById('editFormClose');
            const editImagePreview = document.getElementById('editImagePreview');
            const editImageInput = document.getElementById('editImageInput');
            const editPreviewImg = document.getElementById('editPreviewImg');
            const editImagePlaceholder = document.getElementById('editImagePlaceholder');
            const submitEditReport = document.getElementById('submitEditReport');
            const refreshTramUpdates = document.getElementById('refreshTramUpdates');
            const addReportTip = document.getElementById('addReportTip');
            const cancelReport = document.getElementById('cancelReport');
            const reselectLocation = document.getElementById('reselectLocation');
            const closeReportCardBtn = document.getElementById('closeReportCardBtn');
            
            imageInput.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImg.src = e.target.result;
                        previewImg.style.display = 'block';
                        imagePlaceholder.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                } else {
                    previewImg.src = '';
                    previewImg.style.display = 'none';
                    imagePlaceholder.style.display = 'block';
                }
            });

            // æ·»åŠ æœ€åæ›´æ–°æ—¶é—´æ ‡ç­¾
            const updateTimeSpan = document.createElement('span');
            updateTimeSpan.id = 'lastUpdateTime';
            updateTimeSpan.textContent = 'åˆšåˆš';
            updateTimeSpan.style.marginLeft = '5px';
            updateTimeSpan.style.fontSize = '12px';
            updateTimeSpan.style.color = '#666';
            refreshTramUpdates.appendChild(updateTimeSpan);
            
            // åˆå§‹åŒ–å¼¹å¹•
            initDanmaku();
            
            // æ¯å¤©è‡ªåŠ¨æ›´æ–°å¼¹å¹•æ•°æ®
            function scheduleDailyUpdate() {
                const now = new Date();
                const tomorrow = new Date();
                tomorrow.setDate(now.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0); // è®¾ç½®ä¸ºæ˜å¤©å‡Œæ™¨00:00
                
                const timeUntilMidnight = tomorrow - now;
                
                // è®¾ç½®å®šæ—¶å™¨ï¼Œåœ¨æ˜å¤©å‡Œæ™¨è‡ªåŠ¨æ›´æ–°
                setTimeout(() => {
                    console.log("Daily danmaku update triggered");
                    fetchTramUpdates(false); // é™é»˜æ›´æ–°
                    // å†æ¬¡å®‰æ’æ˜å¤©çš„æ›´æ–°
                    scheduleDailyUpdate();
                }, timeUntilMidnight);
                
                console.log(`Next danmaku update scheduled in ${Math.floor(timeUntilMidnight/1000/60/60)} hours ${Math.floor((timeUntilMidnight/1000/60) % 60)} minutes`);
            }
            
            // å¯åŠ¨æ¯æ—¥æ›´æ–°è®¡åˆ’
            scheduleDailyUpdate();
            
            // è®¾ç½®è‡ªåŠ¨åˆ·æ–° (æ¯3å°æ—¶)
            clearInterval(autoRefreshTimer); // æ¸…é™¤åŸæœ‰å®šæ—¶å™¨
            autoRefreshTimer = setInterval(() => {
                fetchTramUpdates(false); // é™é»˜åˆ·æ–°ï¼Œä¸æ˜¾ç¤ºæç¤º
                initDanmaku(); // ç¡®ä¿å¼¹å¹•ä¹Ÿåˆ·æ–°
            }, 3 * 60 * 60 * 1000); // 3å°æ—¶
            
            // æ¯åˆ†é’Ÿæ›´æ–°çŠ¶æ€æ˜¾ç¤º
            setInterval(updateStatusDisplay, 60 * 1000);
            
            // åˆ·æ–°ç”µè½¦ä¿¡æ¯æŒ‰é’®
            refreshTramUpdates.addEventListener('click', function() {
                fetchTramUpdates(true); // æ˜¾ç¤ºæç¤º
                initDanmaku();
            });
            
            // æ‰“å¼€æŠ¥å‘Šè¡¨å•
            addReportBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (isSelectingLocation) return;
                isSelectingLocation = true;
                addReportTip.style.display = 'inline';
                addReportBtn.textContent = 'æ­£åœ¨é€‰ç‚¹...ï¼ˆå¯å–æ¶ˆï¼‰';
                addReportBtn.classList.add('disabled');
                selectedLocation = null;
                // å…³é—­è¡¨å•
                document.getElementById('reportForm').classList.remove('active');
                // é¼ æ ‡å˜ä¸ºåå­—
                document.body.style.cursor = 'crosshair';
                // æ¸…é™¤ä¸´æ—¶æ ‡è®°
                if (tempMarker) {
                    tempMarker.setMap(null);
                    tempMarker = null;
                }
            });
            
            // é‡æ–°é€‰ç‚¹æŒ‰é’®
            reselectLocation.addEventListener('click', function(e) {
                e.preventDefault();
                isSelectingLocation = true;
                addReportTip.style.display = 'inline';
                addReportBtn.textContent = 'æ­£åœ¨é€‰ç‚¹...ï¼ˆå¯å–æ¶ˆï¼‰';
                addReportBtn.classList.add('disabled');
                document.getElementById('reportForm').classList.remove('active');
                // é¼ æ ‡å˜ä¸ºåå­—
                document.body.style.cursor = 'crosshair';
                // æ¸…é™¤ä¸´æ—¶æ ‡è®°
                if (tempMarker) {
                    tempMarker.setMap(null);
                    tempMarker = null;
                }
            });
            
            // å–æ¶ˆæŒ‰é’®é€»è¾‘
            cancelReport.addEventListener('click', function(e) {
                e.preventDefault();
                closeReportFormAndReset();
            });
            
            // æäº¤æŠ¥å‘ŠæŒ‰é’®é€»è¾‘ä¼˜åŒ–
            submitReport.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('submitReport clicked');
                const description = document.getElementById('descriptionInput').value.trim();
                if (!selectedLocation) {
                    alert('è¯·å…ˆåœ¨åœ°å›¾ä¸Šç‚¹é€‰ä½ç½®');
                    return;
                }
                showConfirmDialog('æ‚¨ç¡®å®šè¦æäº¤è¿™ä¸ªæŠ¥å‘Šå—ï¼Ÿ', function(confirmed) {
                    console.log('ç¡®è®¤å¯¹è¯æ¡†å›è°ƒï¼Œconfirmed:', confirmed);
                    if (confirmed) {
                        let imageData = '';
                        if (previewImg.style.display !== 'none') {
                            imageData = previewImg.src;
                        }
                        console.log('è°ƒç”¨addNewReport', description, imageData, selectedLocation.lat, selectedLocation.lng);
                        addNewReport(description, imageData, selectedLocation.lat, selectedLocation.lng);
                        document.getElementById('reportForm').classList.remove('active');
                        selectedLocation = null;
                        isSelectingLocation = false;
                        addReportTip.style.display = 'none';
                        addReportBtn.textContent = '+ æ·»åŠ æŠ¥å‘Š';
                        addReportBtn.classList.remove('disabled');
                        // æ¸…é™¤ä¸´æ—¶æ ‡è®°
                        if (tempMarker) {
                            tempMarker.setMap(null);
                            tempMarker = null;
                        }
                        document.body.style.cursor = '';
                    }
                });
            });
            
            // æ˜¾ç¤º/éšè—è¯„è®ºåŒº
            commentBtn.addEventListener('click', function() {
                if (commentsSection.style.display === 'none') {
                    commentsSection.style.display = 'block';
                } else {
                    commentsSection.style.display = 'none';
                }
            });
            
            // å‘é€è¯„è®º
            sendComment.addEventListener('click', function() {
                const comment = commentInput.value.trim();
                if (!comment) return;
                
                showConfirmDialog('ç¡®å®šå‘é€æ­¤è¯„è®ºï¼Ÿ', function(confirmed) {
                    if (confirmed) {
                        addComment(currentReportId, comment);
                        commentInput.value = '';
                    }
                });
            });
            
            // å›è½¦å‘é€è¯„è®º
            commentInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const comment = this.value.trim();
                    if (!comment) return;
                    
                    showConfirmDialog('ç¡®å®šå‘é€æ­¤è¯„è®ºï¼Ÿ', function(confirmed) {
                        if (confirmed) {
                            addComment(currentReportId, comment);
                            commentInput.value = '';
                        }
                    });
                }
            });
            
            // ç‚¹å‡»åœ°å›¾ç©ºç™½å¤„å…³é—­æŠ¥å‘Šå¡ç‰‡
            map.addListener("click", (event) => {
                if (document.getElementById('reportCard').style.display === 'block') {
                    document.getElementById('reportCard').style.display = 'none';
                }
            });
            
            // ç‚¹å‡»ç¼–è¾‘æŒ‰é’®
            editReportBtn.addEventListener('click', function() {
                const report = reports.find(r => r.id === currentReportId);
                if (!report) return;
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºå½“å‰ç”¨æˆ·çš„æŠ¥å‘Š
                if (report.userId !== currentUserId) {
                    showConfirmDialog('æ‚¨åªèƒ½ç¼–è¾‘è‡ªå·±å‘å¸ƒçš„æŠ¥å‘Š', null);
                    return;
                }
                
                // å¡«å……ç¼–è¾‘è¡¨å•
                document.getElementById('editDescriptionInput').value = report.description;
                
                if (report.image) {
                    editPreviewImg.src = report.image;
                    editPreviewImg.style.display = 'block';
                    editImagePlaceholder.style.display = 'none';
                } else {
                    editPreviewImg.style.display = 'none';
                    editImagePlaceholder.style.display = 'block';
                }
                
                // æ˜¾ç¤ºç¼–è¾‘è¡¨å•
                editForm.classList.add('active');
            });
            
            // å…³é—­ç¼–è¾‘è¡¨å•
            editFormClose.addEventListener('click', function() {
                showConfirmDialog('æ‚¨ç¡®å®šè¦å–æ¶ˆç¼–è¾‘å—ï¼Ÿæœªä¿å­˜çš„ä¿®æ”¹å°†ä¼šä¸¢å¤±ã€‚', function(confirmed) {
                    if (confirmed) {
                        editForm.classList.remove('active');
                    }
                });
            });
            
            // é¢„è§ˆåŒºåŸŸç‚¹å‡»æç¤ºå·²ç”±inputè¦†ç›–ï¼Œæ— éœ€é¢å¤–äº‹ä»¶
            // ä½†ä¸ºç¼–è¾‘è¡¨å•ä¿ç•™ç‚¹å‡»äº‹ä»¶
            document.getElementById('editImagePreview').addEventListener('click', function() {
                document.getElementById('editImageInput').click();
            });
            
            editImageInput.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        editPreviewImg.src = e.target.result;
                        editPreviewImg.style.display = 'block';
                        editImagePlaceholder.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // æäº¤ç¼–è¾‘
            submitEditReport.addEventListener('click', function() {
                const description = document.getElementById('editDescriptionInput').value.trim();
                
                if (!description) {
                    alert('è¯·è¾“å…¥æè¿°');
                    return;
                }
                
                showConfirmDialog('æ‚¨ç¡®å®šè¦ä¿å­˜è¿™äº›ä¿®æ”¹å—ï¼Ÿ', function(confirmed) {
                    if (confirmed) {
                        // è·å–å›¾ç‰‡
                        let imageData = '';
                        if (editPreviewImg.style.display !== 'none') {
                            imageData = editPreviewImg.src;
                        }
                        
                        // ç¼–è¾‘æŠ¥å‘Š
                        if (editReport(currentReportId, description, imageData)) {
                            // å…³é—­ç¼–è¾‘è¡¨å•
                            editForm.classList.remove('active');
                        }
                    }
                });
            });
            
            // ç‚¹å‡»åˆ é™¤æŒ‰é’®
            const deleteReportBtn = document.getElementById('deleteReportBtn');
            deleteReportBtn.addEventListener('click', function() {
                showConfirmDialog('æ‚¨ç¡®å®šè¦åˆ é™¤è¿™æ¡æŠ¥å‘Šå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚', function(confirmed) {
                    if (confirmed) {
                        deleteReport(currentReportId);
                    }
                });
            });
            
            // ä¸ºæ‰€æœ‰æŒ‰é’®æ·»åŠ è§¦æ‘¸äº‹ä»¶æ”¯æŒ
            const allButtons = document.querySelectorAll('button, .add-report-btn');
            allButtons.forEach(button => {
                button.addEventListener('touchstart', function(e) {
                    // ä½¿ç”¨activeç±»æ ‡è®°æŒ‰é’®è¢«æŒ‰ä¸‹
                    this.classList.add('active-touch');
                });
                
                button.addEventListener('touchend', function(e) {
                    // ç§»é™¤activeç±»
                    this.classList.remove('active-touch');
                });
            });

            // é˜»æ­¢åœ°å›¾ä¸Šçš„é»˜è®¤è§¦æ‘¸è¡Œä¸ºï¼ˆé˜²æ­¢æ»šåŠ¨å¹²æ‰°ï¼‰
            document.getElementById('map').addEventListener('touchmove', function(e) {
                if (document.getElementById('reportForm').classList.contains('active') || 
                    document.getElementById('editForm').classList.contains('active') ||
                    document.getElementById('confirmDialog').classList.contains('active')) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            // ç¡®ä¿ç¡®è®¤å¯¹è¯æ¡†å†…çš„äº‹ä»¶ä¸ä¼ æ’­åˆ°åœ°å›¾
            document.getElementById('confirmDialog').addEventListener('touchmove', function(e) {
                e.stopPropagation();
            }, { passive: false });
            
            document.querySelector('.confirm-content').addEventListener('touchmove', function(e) {
                e.stopPropagation();
            }, { passive: false });
            
            // æ·»åŠ æ»šè½®äº‹ä»¶ç›‘å¬å™¨
            document.addEventListener('wheel', handleScroll);

            // æ–°å¢: æ·»åŠ é¼ æ ‡ç§»åŠ¨äº‹ä»¶ç›‘å¬å™¨
            document.body.addEventListener('mousemove', handleMouseMove);

            // æ–°å¢: å®šæ—¶æ£€æŸ¥æ ‡è®°æ˜¯å¦è¿‡æœŸ
            setInterval(checkMarkerExpiry, 60000); // Check every minute
            
            // åˆå§‹åŒ–Firebaseæ•°æ®åŠ è½½
            loadReportsFromFirebase();

            // ç¡®ä¿é®ç½©å…ƒç´ å’Œæ ·å¼æ’å…¥
            if (!document.getElementById('reportCardMask')) {
              const mask = document.createElement('div');
              mask.id = 'reportCardMask';
              document.body.appendChild(mask);
            }
            if (!document.getElementById('reportCardMaskStyle')) {
              const style = document.createElement('style');
              style.id = 'reportCardMaskStyle';
              style.innerHTML = `
              .report-card {
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                z-index: 2001 !important;
                background: rgba(28,28,30,0.98) !important;
                box-shadow: 0 4px 32px rgba(0,0,0,0.4) !important;
                display: none;
              }
              #reportCardMask {
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.45);
                z-index: 2000;
                display: none;
              }
              `;
              document.head.appendChild(style);
            }
            // ç»‘å®šé®ç½©ç‚¹å‡»å…³é—­å¼¹çª—
            const mask = document.getElementById('reportCardMask');
            if (mask) {
              mask.onclick = function() {
                mask.style.display = 'none';
                document.getElementById('reportCard').style.display = 'none';
              };
            }
            if (closeReportCardBtn) {
                closeReportCardBtn.onclick = function() {
                    document.getElementById('reportCard').style.display = 'none';
                    document.getElementById('reportCardMask').style.display = 'none';
                };
            }
        });

        // é€€å‡ºæŠ¥å‘Šé¡µé¢ç›¸å…³é€»è¾‘ï¼Œåªæ¸…ç†tempMarkerï¼Œä¸å½±å“æ­£å¼æ ‡è®°
        function closeReportFormAndReset() {
            document.getElementById('reportForm').classList.remove('active');
            selectedLocation = null;
            isSelectingLocation = false;
            document.getElementById('addReportTip').style.display = 'none';
            document.getElementById('addReportBtn').textContent = '+ æ·»åŠ æŠ¥å‘Š';
            document.getElementById('addReportBtn').classList.remove('disabled');
            if (tempMarker) {
                tempMarker.setMap(null);
                tempMarker = null;
            }
            document.body.style.cursor = '';
        }

        // è¯­è¨€åŒ…
        const i18n = {
          zh: {
            addReport: '+ æ·»åŠ æŠ¥å‘Š',
            addReportTip: 'è¯·åœ¨åœ°å›¾ä¸Šç‚¹é€‰ä½ç½®',
            formTitle: 'æ–°æŠ¥å‘Š',
            photo: 'ç…§ç‰‡',
            desc: 'æè¿°',
            descPlaceholder: 'è¯·æè¿°æ‚¨çœ‹åˆ°çš„æƒ…å†µ...',
            confirm: 'ç¡®å®š',
            reselect: 'é‡æ–°é€‰ç‚¹',
            cancel: 'å–æ¶ˆ',
            comment: 'è¯„è®º',
            edit: 'ç¼–è¾‘',
            delete: 'åˆ é™¤',
            commentCount: n => `${n} è¯„è®º`,
            editTitle: 'ç¼–è¾‘æŠ¥å‘Š',
            saveEdit: 'ä¿å­˜ä¿®æ”¹',
            confirmTitle: 'ç¡®è®¤æ“ä½œ',
            confirmMsg: 'æ‚¨ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ',
            confirmDelete: 'æ‚¨ç¡®å®šè¦åˆ é™¤è¿™æ¡æŠ¥å‘Šå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚',
            confirmEdit: 'æ‚¨ç¡®å®šè¦ä¿å­˜è¿™äº›ä¿®æ”¹å—ï¼Ÿ',
            confirmSendComment: 'ç¡®å®šå‘é€æ­¤è¯„è®ºï¼Ÿ',
            confirmCancelEdit: 'æ‚¨ç¡®å®šè¦å–æ¶ˆç¼–è¾‘å—ï¼Ÿæœªä¿å­˜çš„ä¿®æ”¹å°†ä¼šä¸¢å¤±ã€‚',
            alertNoDesc: 'è¯·è¾“å…¥æè¿°',
            alertNoLocation: 'è¯·å…ˆåœ¨åœ°å›¾ä¸Šç‚¹é€‰ä½ç½®',
            alertNoReport: 'å¼¹çª—å…ƒç´ æœªæ­£ç¡®æ’å…¥é¡µé¢ï¼Œè¯·æ£€æŸ¥HTMLç»“æ„æˆ–é®ç½©æ’å…¥é€»è¾‘ï¼',
            justNow: 'åˆšåˆš',
            minAgo: n => `${n} åˆ†é’Ÿå‰`,
            hourAgo: n => `${n} å°æ—¶å‰`,
            dayAgo: n => `${n} å¤©å‰`,
            refreshTram: 'åˆ·æ–°ç”µè½¦ä¿¡æ¯',
            lastUpdate: 'åˆšåˆš',
            send: 'å‘é€',
            imagePlaceholder: 'ç‚¹å‡»æ·»åŠ ç…§ç‰‡',
            editImagePlaceholder: 'ç‚¹å‡»æ·»åŠ ç…§ç‰‡',
            freeTram: 'å…è´¹ç”µè½¦åŒºæé†’: å¢¨å°”æœ¬å¸‚ä¸­å¿ƒåŒºåŸŸä¹˜åç”µè½¦æ— éœ€ä»˜è´¹',
            addReportSelecting: 'æ­£åœ¨é€‰ç‚¹...ï¼ˆå¯å–æ¶ˆï¼‰',
            updateSuccess: 'ç”µè½¦ä¿¡æ¯å·²æ›´æ–°',
            // ...å¯æ‰©å±•
          },
          en: {
            addReport: '+ Add Report',
            addReportTip: 'Please select a location on the map',
            formTitle: 'New Report',
            photo: 'Photo',
            desc: 'Description',
            descPlaceholder: 'Describe what you saw...',
            confirm: 'Submit',
            reselect: 'Reselect',
            cancel: 'Cancel',
            comment: 'Comment',
            edit: 'Edit',
            delete: 'Delete',
            commentCount: n => `${n} Comments`,
            editTitle: 'Edit Report',
            saveEdit: 'Save',
            confirmTitle: 'Confirmation',
            confirmMsg: 'Are you sure you want to proceed?',
            confirmDelete: 'Are you sure you want to delete this report? This action cannot be undone.',
            confirmEdit: 'Are you sure you want to save these changes?',
            confirmSendComment: 'Send this comment?',
            confirmCancelEdit: 'Are you sure to cancel editing? Unsaved changes will be lost.',
            alertNoDesc: 'Please enter a description',
            alertNoLocation: 'Please select a location on the map first',
            alertNoReport: 'Popup element not found, please check HTML structure!',
            justNow: 'Just now',
            minAgo: n => `${n} min ago`,
            hourAgo: n => `${n} hours ago`,
            dayAgo: n => `${n} days ago`,
            refreshTram: 'Refresh Tram Info',
            lastUpdate: 'Just now',
            send: 'Send',
            imagePlaceholder: 'Click to add photo',
            editImagePlaceholder: 'Click to add photo',
            freeTram: 'Free Tram Zone: No ticket required in Melbourne CBD',
            addReportSelecting: 'Selecting... (Cancelable)',
            updateSuccess: 'Tram information updated',
            // ...å¯æ‰©å±•
          }
        };
        let currentLang = 'zh';

        function setLang(lang) {
          currentLang = lang;
          // æŒ‰é’®
          document.getElementById('addReportBtn').textContent = i18n[lang].addReport;
          document.getElementById('addReportTip').textContent = i18n[lang].addReportTip;
          document.getElementById('langSwitchText').textContent = lang === 'zh' ? 'EN' : 'ä¸­';
          // æ›´æ–°ç”µè½¦ä¿¡æ¯æŒ‰é’®
          const refreshBtn = document.getElementById('refreshTramUpdates');
          const spanElement = refreshBtn.querySelector('span');
          const spanHtml = spanElement ? spanElement.outerHTML : '<span>ğŸš‹</span>';
          refreshBtn.innerHTML = `${spanHtml} ${i18n[lang].refreshTram}`;
          // è¡¨å•
          document.querySelector('.form-title').textContent = i18n[lang].formTitle;
          document.querySelector('.form-label').textContent = i18n[lang].photo;
          document.getElementById('imagePlaceholder').textContent = i18n[lang].imagePlaceholder;
          document.querySelectorAll('.form-label')[1].textContent = i18n[lang].desc;
          document.getElementById('descriptionInput').placeholder = i18n[lang].descPlaceholder;
          document.getElementById('submitReport').textContent = i18n[lang].confirm;
          document.getElementById('reselectLocation').textContent = i18n[lang].reselect;
          document.getElementById('cancelReport').textContent = i18n[lang].cancel;
          // è¯¦æƒ…å¼¹çª—
          document.getElementById('commentBtn').textContent = i18n[lang].comment;
          document.getElementById('editReportBtn').textContent = i18n[lang].edit;
          document.getElementById('deleteReportBtn').textContent = i18n[lang].delete;
          document.getElementById('sendComment').textContent = i18n[lang].send;
          document.getElementById('commentInput').placeholder = i18n[lang].comment;
          // ç¼–è¾‘å¼¹çª—
          document.querySelector('#editForm .form-title').textContent = i18n[lang].editTitle;
          document.getElementById('editImagePlaceholder').textContent = i18n[lang].editImagePlaceholder;
          document.getElementById('editDescriptionInput').placeholder = i18n[lang].descPlaceholder;
          document.getElementById('submitEditReport').textContent = i18n[lang].saveEdit;
          // ç¡®è®¤å¼¹çª—
          document.querySelector('.confirm-title').textContent = i18n[lang].confirmTitle;
          // å…¶ä»–å¯æ‰©å±•
          document.getElementById('langSwitchText').textContent = lang === 'zh' ? 'EN' : 'ä¸­';
          // é€‰ç‚¹çŠ¶æ€ä¸‹æŒ‰é’®æ–‡æœ¬
          const addReportBtn = document.getElementById('addReportBtn');
          if (addReportBtn.classList.contains('disabled')) {
            addReportBtn.textContent = i18n[lang].addReportSelecting;
          } else {
            addReportBtn.textContent = i18n[lang].addReport;
          }
          // æ–°å¢ï¼šåŒæ­¥æ›´æ–°å›¾ç‰‡ä¸Šä¼ ã€è¯„è®ºã€ç¡®è®¤å¼¹çª—
          updateImagePreviewLang();
          updateCommentBtnLang();
          updateConfirmDialogLang();
          // æ–°å¢ï¼šåŒæ­¥åˆ·æ–°æ‰€æœ‰å·²æ˜¾ç¤ºçš„è¯„è®ºæ•°
          const commentCount = document.getElementById('commentCount');
          if (commentCount && typeof currentReportId !== 'undefined') {
            const report = reports.find(r => r.id === currentReportId);
            if (report) commentCount.textContent = i18n[lang].commentCount(report.comments ? report.comments.length : 0);
          }
          // æ–°å¢ï¼šåŒæ­¥åˆ·æ–°ç¡®è®¤å¼¹çª—å†…å®¹
          const confirmDialog = document.getElementById('confirmDialog');
          if (confirmDialog && confirmDialog.style.display !== 'none') {
            document.querySelector('.confirm-title').textContent = i18n[lang].confirmTitle;
            document.getElementById('confirmCancel').textContent = i18n[lang].cancel;
            document.getElementById('confirmOk').textContent = i18n[lang].confirm;
            // è‹¥å†…å®¹ä¸ºé€šç”¨ç¡®è®¤ï¼Œè‡ªåŠ¨åˆ‡æ¢
            const msg = document.getElementById('confirmMessage');
            if (msg) {
              if (msg.textContent === i18n[lang === 'zh' ? 'en' : 'zh'].confirmMsg) {
                msg.textContent = i18n[lang].confirmMsg;
              } else if (msg.textContent === i18n[lang === 'zh' ? 'en' : 'zh'].confirmDelete) {
                msg.textContent = i18n[lang].confirmDelete;
              }
            }
          }
          // æ–°å¢ï¼šåˆ·æ–°å·²æ˜¾ç¤ºè¯„è®ºçš„ç¿»è¯‘æŒ‰é’®title
          const commentDivs = document.querySelectorAll('.comment');
          commentDivs.forEach(div => {
            const btn = div.querySelector('button');
            if (btn) btn.title = lang === 'zh' ? 'ç¿»è¯‘ä¸ºè‹±æ–‡' : 'Translate to Chinese';
          });
          
          // é‡æ–°ç”Ÿæˆå¯¹åº”è¯­è¨€çš„å¼¹å¹•æ•°æ®
          updateDanmakuData();
        }

        document.addEventListener('DOMContentLoaded', function() {
          // ...åŸæœ‰ä»£ç ...
          setLang('zh'); // é»˜è®¤ä¸­æ–‡
          // äº‹ä»¶ç»‘å®šæå‰ï¼Œç¡®ä¿ä¸ä¼šè¢«åç»­ä»£ç è¦†ç›–
          document.getElementById('langSwitchBtn').onclick = function() {
            setLang(currentLang === 'zh' ? 'en' : 'zh');
          };
          // ...åŸæœ‰ä»£ç ...
          // é€‰ç‚¹æŒ‰é’®åˆ‡æ¢æ—¶ä¹Ÿç”¨i18n
          document.getElementById('addReportBtn').addEventListener('click', function(e) {
            // ...åŸæœ‰...
            this.textContent = i18n[currentLang].addReportSelecting;
            // ...åŸæœ‰...
          });
          document.getElementById('reselectLocation').addEventListener('click', function(e) {
            // ...åŸæœ‰...
            document.getElementById('addReportBtn').textContent = i18n[currentLang].addReportSelecting;
            // ...åŸæœ‰...
          });
          document.getElementById('cancelReport').addEventListener('click', function(e) {
            // ...åŸæœ‰...
            document.getElementById('addReportBtn').textContent = i18n[currentLang].addReport;
            // ...åŸæœ‰...
          });
          // åˆå§‹åŒæ­¥å›¾ç‰‡ä¸Šä¼ ã€è¯„è®ºã€ç¡®è®¤å¼¹çª—
          updateImagePreviewLang();
          updateCommentBtnLang();
          updateConfirmDialogLang();
        });

        // 1. å›¾ç‰‡ä¸Šä¼ æŒ‰é’®ï¼ˆimage-preview:afterï¼‰å›½é™…åŒ–
        function updateImagePreviewLang() {
          const lang = currentLang;
          const styleId = 'imagePreviewLangStyle';
          let style = document.getElementById(styleId);
          if (!style) {
            style = document.createElement('style');
            style.id = styleId;
            document.head.appendChild(style);
          }
          style.innerHTML = `.image-preview:after { content: "${i18n[lang].imagePlaceholder}"; position: absolute; bottom: 10px; right: 10px; background-color: rgba(0,0,0,0.6); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; }`;
        }
        // 2. è¯„è®ºåŒº"è¯„è®º"ä¸"Comment"
        function updateCommentBtnLang() {
          const commentBtn = document.getElementById('commentBtn');
          if (commentBtn) commentBtn.textContent = i18n[currentLang].comment;
        }
        // 3. ç¡®è®¤å¼¹çª—æŒ‰é’®å›½é™…åŒ–
        function updateConfirmDialogLang() {
          document.getElementById('confirmCancel').textContent = i18n[currentLang].cancel;
          document.getElementById('confirmOk').textContent = i18n[currentLang].confirm;
        }

        // æ¨¡æ‹Ÿç¿»è¯‘å‡½æ•°ï¼ˆå®é™…å¯æ¥å…¥Google Translate APIï¼‰
        async function translateText(text, targetLang) {
          // è¿™é‡Œåªåšç®€å•æ¨¡æ‹Ÿï¼Œå®é™…å¯ç”¨fetchè°ƒç”¨API
          if (targetLang === 'en') {
            // å‡è®¾ä¸­æ–‡è½¬è‹±æ–‡
            if (text === 'æµ‹è¯•è¯„è®º') return 'Test comment';
            if (text === 'ä½ å¥½') return 'Hello';
            return '[EN] ' + text;
          } else {
            // å‡è®¾è‹±æ–‡è½¬ä¸­æ–‡
            if (text === 'Test comment') return 'æµ‹è¯•è¯„è®º';
            if (text === 'Hello') return 'ä½ å¥½';
            return '[ä¸­] ' + text;
          }
        }

        // æ£€æµ‹æ–‡æœ¬ä¸»è¦è¯­è¨€ï¼ˆç®€å•åˆ¤å®šï¼šå«æœ‰å¤§é‡ä¸­æ–‡å­—ç¬¦åˆ™ä¸ºä¸­æ–‡ï¼Œå¦åˆ™ä¸ºè‹±æ–‡ï¼‰
        function detectLang(text) {
          const zhCount = (text.match(/[\u4e00-\u9fa5]/g) || []).length;
          const enCount = (text.match(/[a-zA-Z]/g) || []).length;
          return zhCount > enCount ? 'zh' : 'en';
        }

        // å¼¹å¹•æ•°æ®æ›´æ–° - ä»YarraTramsè·å–æœåŠ¡å˜æ›´ä¿¡æ¯å¹¶åŠ å…¥æŠ¥å‘Šå†…å®¹
        function updateDanmakuData() {
            // æ¸…ç©ºç°æœ‰å¼¹å¹•æ•°æ®
            danmakuData = [];
            
            // æ·»åŠ æ—¶é—´å‰ç¼€å‡½æ•° - ä½¿ç”¨å½“å‰æ—¶é—´
            function addTimePrefix(text) {
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                return `[${hours}:${minutes}] ${text}`;
            }
            
            // æ ¹æ®å½“å‰è¯­è¨€é€‰æ‹©æœåŠ¡å˜æ›´ä¿¡æ¯ - ç°åœ¨åŒ…å«å‘å¸ƒæ—¥æœŸ
            // æ¯æ¡æœåŠ¡å˜æ›´ä¿¡æ¯åŒ…å«å†…å®¹å’Œå‘å¸ƒæ—¶é—´ [content, publishTime]
            let tramServiceChanges;
            if (currentLang === 'zh') {
                tramServiceChanges = [
                    ["58è·¯ç”µè½¦ - Kings Wayç«™ç‚¹å…³é—­è‡³2025å¹´7æœˆ", "2024-07-27T09:15:00"],
                    ["ç‰¹æ®Šæ´»åŠ¨å’Œé‚®è½®æœŸé—´å°†å¢åŠ é¢å¤–ç”µè½¦æœåŠ¡ï¼ˆ2025å¹´5æœˆè‡³6æœˆï¼‰", "2024-05-01T14:30:00"],
                    ["57è·¯å’Œ82è·¯ç”µè½¦å°†ç”±å·´å£«æ›¿ä»£ï¼ˆ2025å¹´5æœˆ2-11æ—¥ï¼‰", "2024-04-25T11:20:00"],
                    ["Flindersè¡—èµ·é‡æœºå®‰è£…å½±å“75è·¯å’Œç¯åŸç”µè½¦ï¼ˆ5æœˆ11æ—¥ï¼‰", "2024-05-05T16:45:00"],
                    ["5æœˆ11æ—¥å‘¨æ—¥å¸‚åŒºç”µè½¦å› é›†ä¼šå°†å—åˆ°å½±å“", "2024-05-04T13:10:00"],
                    ["Burwoodé«˜é€Ÿå…¬è·¯ç»´ä¿®ï¼š75è·¯ç”µè½¦å°†ç”±å·´å£«æ›¿ä»£ï¼ˆ5æœˆ19-27æ—¥ï¼‰", "2024-05-12T10:05:00"],
                    ["St Georgesé“è½¨é“å·¥ç¨‹ï¼š11è·¯ç”µè½¦å°†ç”±å·´å£«æ›¿ä»£ï¼ˆ5æœˆ30æ—¥-6æœˆ2æ—¥ï¼‰", "2024-05-15T09:30:00"],
                    ["å›½ç‹ç”Ÿæ—¥å…¬å…±å‡æœŸï¼šç”µè½¦å°†æŒ‰å‘¨å…­é¢‘ç‡è¿è¡Œï¼ˆ6æœˆ9æ—¥ï¼‰", "2024-05-20T15:40:00"],
                    ["å…è´¹ç”µè½¦åŒºæé†’ï¼šå¢¨å°”æœ¬å¸‚ä¸­å¿ƒåŒºåŸŸä¹˜åç”µè½¦æ— éœ€ä»˜è´¹", "2024-01-15T08:00:00"],
                    ["96è·¯ç”µè½¦ï¼šEast Brunswickè‡³St Kilda Beachæ­£å¸¸è¿è¡Œ", "2024-05-18T07:30:00"],
                    ["109è·¯ç”µè½¦ï¼šBox Hillè‡³Port MelbourneæœåŠ¡æ­£å¸¸", "2024-05-19T06:45:00"],
                    ["86è·¯ç”µè½¦ï¼šBundoora RMITè‡³Waterfront Cityè¿è¡Œé¡ºç•…", "2024-05-17T12:20:00"],
                    ["11è·¯ç”µè½¦ï¼šWest Prestonè‡³Victoria Harbour Docklandså‡†æ—¶", "2024-05-16T14:15:00"],
                    ["75è·¯ç”µè½¦ï¼šVermont Southè‡³Central PieræœåŠ¡æ›´æ–°å¯ç”¨", "2024-05-17T10:50:00"],
                    ["35è·¯ç¯åŸç”µè½¦æä¾›ä¾¿æ·çš„å¸‚åŒºè§‚å…‰ä½“éªŒ", "2024-05-01T09:00:00"]
                ];
            } else {
                tramServiceChanges = [
                    ["Route 58 - Stop closure on Kings Way until July 2025", "2024-07-27T09:15:00"],
                    ["Extra trams for special events and cruise ships from May to June 2025", "2024-05-01T14:30:00"],
                    ["Buses replace Route 57 and 82 trams from May 2-11, 2025", "2024-04-25T11:20:00"],
                    ["Flinders Street crane installation affects Route 75 and City Circle on May 11", "2024-05-05T16:45:00"],
                    ["Disruption to City trams on Sunday May 11 due to rally", "2024-05-04T13:10:00"],
                    ["Burwood Highway renewal works: Buses replace Route 75 trams May 19-27", "2024-05-12T10:05:00"],
                    ["St Georges Road track works: Buses replace Route 11 trams May 30-June 2", "2024-05-15T09:30:00"],
                    ["King's Birthday public holiday: Trams run Saturday frequency on June 9", "2024-05-20T15:40:00"],
                    ["Free Tram Zone reminder: No ticket required in Melbourne CBD", "2024-01-15T08:00:00"],
                    ["Route 96 East Brunswick to St Kilda Beach running on schedule", "2024-05-18T07:30:00"],
                    ["Route 109 Box Hill to Port Melbourne service operating normally", "2024-05-19T06:45:00"],
                    ["Route 86 Bundoora RMIT to Waterfront City running smoothly", "2024-05-17T12:20:00"],
                    ["Route 11 West Preston to Victoria Harbour Docklands on time", "2024-05-16T14:15:00"],
                    ["Route 75 Vermont South to Central Pier service update available", "2024-05-17T10:50:00"],
                    ["Route 35 City Circle provides convenient city touring experience", "2024-05-01T09:00:00"]
                ];
            }
            
            // æ·»åŠ ç”µè½¦æœåŠ¡å˜æ›´ä¿¡æ¯åˆ°å¼¹å¹•æ•°æ®ï¼ˆä½¿ç”¨å‘å¸ƒæ—¶é—´ï¼‰
            danmakuData = tramServiceChanges.map(([text, publishTime]) => {
                const date = new Date(publishTime);
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                return `[${hours}:${minutes}] ${text}`;
            });
            
            // æ·»åŠ æœ€è¿‘çš„æŠ¥å‘Šæè¿°å’Œè¯„è®ºï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            const now = new Date();
            const recentReports = reports.filter(report => {
                const reportTime = new Date(report.time);
                return (now - reportTime) < (1000 * 60 * 60 * 24); // 24å°æ—¶å†…çš„æŠ¥å‘Š
            }).slice(0, 5); // æœ€å¤šå–5æ¡æœ€æ–°æŠ¥å‘Š
            
            // æ·»åŠ æŠ¥å‘Šæè¿°åˆ°å¼¹å¹•æ•°æ®
            recentReports.forEach(report => {
                if (report.description && report.description.trim()) {
                    const reportTime = new Date(report.time);
                    const hours = reportTime.getHours().toString().padStart(2, '0');
                    const minutes = reportTime.getMinutes().toString().padStart(2, '0');
                    const reportPrefix = currentLang === 'zh' ? "ğŸ“ ç”¨æˆ·æŠ¥å‘Š" : "ğŸ“ User Report";
                    danmakuData.push(`[${hours}:${minutes}] ${reportPrefix}: ${report.description}`);
                }
                
                // æ·»åŠ æŠ¥å‘Šè¯„è®ºåˆ°å¼¹å¹•æ•°æ®
                if (report.comments && report.comments.length > 0) {
                    // åªå–æœ€æ–°çš„2æ¡è¯„è®º
                    report.comments.slice(-2).forEach(comment => {
                        if (comment && comment.trim()) {
                            const commentPrefix = currentLang === 'zh' ? "ğŸ’¬ è¯„è®º" : "ğŸ’¬ Comment";
                            danmakuData.push(addTimePrefix(`${commentPrefix}: ${comment}`));
                        }
                    });
                }
            });
            
            // å¦‚æœæ•°æ®ä¸è¶³15æ¡ï¼Œè¡¥å……ä¸€äº›é»˜è®¤ä¿¡æ¯
            const defaultMsg = currentLang === 'zh' 
                ? "YarraTrams: è®¿é—®PTVæ—…ç¨‹è§„åˆ’å·¥å…·ï¼Œè½»æ¾è§„åˆ’æ‚¨çš„å‡ºè¡Œè·¯çº¿" 
                : "YarraTrams: Visit PTV journey planner to plan your tram travel";
            
            while (danmakuData.length < 15) {
                danmakuData.push(addTimePrefix(defaultMsg));
            }
            
            console.log("Updated danmaku data:", danmakuData);
            
            // åˆ·æ–°å¼¹å¹•æ˜¾ç¤º
            initDanmaku();
        }

        // è·å–YarraTramsæœ€æ–°ä¿¡æ¯ - æ›´æ–°ä¸ºæ¯å¤©è‡ªåŠ¨åˆ·æ–°
        function fetchTramUpdates(showAlert = true) {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const refreshBtn = document.getElementById('refreshTramUpdates');
            const originalBtnText = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<span>ğŸ”„</span> åŠ è½½ä¸­...';
            refreshBtn.disabled = true;
            
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šè°ƒç”¨YarraTrams API
            // æ­¤å¤„æ”¹ä¸ºè§¦å‘å¼¹å¹•æ•°æ®æ›´æ–°
            setTimeout(() => {
                // æ›´æ–°å¼¹å¹•æ•°æ®
                updateDanmakuData();
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                refreshBtn.innerHTML = originalBtnText;
                refreshBtn.disabled = false;
                
                // æ›´æ–°æœ€ååˆ·æ–°æ—¶é—´
                lastUpdateTime = new Date();
                updateStatusDisplay();
                
                // æ˜¾ç¤ºæç¤º
                if (showAlert) {
                    alert(i18n[currentLang].updateSuccess || 'ç”µè½¦ä¿¡æ¯å·²æ›´æ–°');
                }
            }, 1500);
        }
        
        // åˆå§‹åŒ–å¼¹å¹•ç³»ç»Ÿ
        function initDanmaku() {
            const container = document.getElementById('danmakuContainer');
            
            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';
            
            // å¦‚æœæ²¡æœ‰å¼¹å¹•æ•°æ®ï¼Œå…ˆæ›´æ–°
            if (!danmakuData || danmakuData.length === 0) {
                updateDanmakuData();
            }
            
            // å¾ªç¯å‘é€å¼¹å¹•
            function loopDanmaku() {
                danmakuData.forEach((text, index) => {
                    setTimeout(() => {
                        createDanmaku(text);
                    }, index * 3000); // æ¯3ç§’å‘é€ä¸€æ¡
                });
                
                // å¾ªç¯é—´éš”æ—¶é—´
                setTimeout(loopDanmaku, danmakuData.length * 3000);
            }
            
            // åˆ›å»ºå•æ¡å¼¹å¹•
            function createDanmaku(text) {
                const danmaku = document.createElement('div');
                danmaku.className = 'danmaku-item';
                
                // æ ¹æ®å†…å®¹è®¾ç½®ä¸åŒçš„æ ·å¼
                if (text.includes('å®‰å…¨') || text.includes('è­¦å‘Š') || text.includes('æ³¨æ„') || 
                    text.includes('safety') || text.includes('warning') || text.includes('caution')) {
                    danmaku.classList.add('safety');
                } else if (text.includes('Bus') || text.includes('Route') || text.includes('ç”µè½¦') || 
                           text.includes('tram') || text.includes('è·¯çº¿') || text.includes('stop') || 
                           text.startsWith('Route ')) {
                    danmaku.classList.add('service');
                } else if (text.includes('YarraTrams:') || text.includes('å…¬å‘Š') || text.includes('Disruption') || 
                          text.includes('replace') || text.includes('closure')) {
                    danmaku.classList.add('important');
                } else if (text.startsWith('ğŸ“') || text.startsWith('ğŸ’¬')) {
                    // æŠ¥å‘Šå’Œè¯„è®ºçš„æ ·å¼
                    danmaku.classList.add(text.startsWith('ğŸ“') ? 'report' : 'comment');
                }
                
                danmaku.textContent = text;
                
                // æ”¹è¿›å‚ç›´ä½ç½®åˆ†é…ï¼Œåˆ›å»ºå‡ ä¸ªé€šé“ä»¥é˜²æ­¢é‡å ï¼Œè¿›ä¸€æ­¥å¢åŠ é€šé“é—´è·
                const channels = [15, 50, 85, 120, 140]; // äº”ä¸ªå‚ç›´ä½ç½®é€šé“ï¼Œæœ€åº•éƒ¨é€šé“ä¸Šç§»ï¼Œé¿å…è¢«æˆªæ–­
                const channelIndex = Math.floor(Math.random() * channels.length);
                const top = channels[channelIndex];
                danmaku.style.top = `${top}px`;
                
                // éšæœºé€Ÿåº¦ (é€šè¿‡åŠ¨ç”»æŒç»­æ—¶é—´æ§åˆ¶)
                const speed = 12 + Math.random() * 8; // 12-20ç§’ä¹‹é—´
                danmaku.style.animationDuration = `${speed}s`;
                
                // æ·»åŠ åˆ°å®¹å™¨
                container.appendChild(danmaku);
                
                // åŠ¨ç”»ç»“æŸåç§»é™¤
                setTimeout(() => {
                    danmaku.remove();
                }, speed * 1000);
            }
            
            // å¼€å§‹å¾ªç¯å¼¹å¹•
            loopDanmaku();
        }
    </script>
    <style>
    #langSwitchBtn:hover {
      background: #e6f0fa;
      border-color: #005bb5;
    }
    @media (max-width: 600px) {
      #langSwitchBtn {
        top: 10px;
        right: 10px;
        font-size: 16px;
        padding: 8px 16px 8px 12px;
      }
    }
    </style>
</body>
</html> 